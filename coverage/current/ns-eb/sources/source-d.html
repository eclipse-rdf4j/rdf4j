


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > PrefixDeclarations</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.eclipse.rdf4j.sparqlbuilder.core</a>
</div>

<h1>Coverage Summary for Class: PrefixDeclarations (org.eclipse.rdf4j.sparqlbuilder.core)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">PrefixDeclarations</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/13)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/58)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/105)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*******************************************************************************
&nbsp; * Copyright (c) 2018 Eclipse RDF4J contributors.
&nbsp; *
&nbsp; * All rights reserved. This program and the accompanying materials
&nbsp; * are made available under the terms of the Eclipse Distribution License v1.0
&nbsp; * which accompanies this distribution, and is available at
&nbsp; * http://www.eclipse.org/org/documents/edl-v10.php.
&nbsp; *
&nbsp; * SPDX-License-Identifier: BSD-3-Clause
&nbsp; *******************************************************************************/
&nbsp;
&nbsp;package org.eclipse.rdf4j.sparqlbuilder.core;
&nbsp;
&nbsp;import org.eclipse.rdf4j.model.util.URIUtil;
&nbsp;
&nbsp;/**
&nbsp; * A collection of SPARQL Prefix declarations
&nbsp; *
&nbsp; * @see &lt;a href=&quot;http://www.w3.org/TR/2013/REC-sparql11-query-20130321/#prefNames&quot;&gt; SPARQL Prefix&lt;/a&gt;
&nbsp; */
<b class="nc">&nbsp;public class PrefixDeclarations extends StandardQueryElementCollection&lt;Prefix&gt; {</b>
&nbsp;	/**
&nbsp;	 * Add prefix declarations to this collection
&nbsp;	 *
&nbsp;	 * @param prefixes the prefixes
&nbsp;	 * @return this
&nbsp;	 */
&nbsp;	public PrefixDeclarations addPrefix(Prefix... prefixes) {
<b class="nc">&nbsp;		addElements(prefixes);</b>
&nbsp;
<b class="nc">&nbsp;		return this;</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Replaces all occurrences of all declared namespaces with their prefix labels in the specified query string.
&nbsp;	 *
&nbsp;	 * For example, if the &lt;code&gt;foaf:&lt;/code&gt; prefix is declared with {@link PrefixDeclarations}, the query
&nbsp;	 *
&nbsp;	 * &lt;pre&gt;
&nbsp;	 * SELECT ?name WHERE {
&nbsp;	 *   ?x &amp;lt;http://xmlns.com/foaf/0.1/name&amp;gt; ?name .
&nbsp;	 * }
&nbsp;	 * &lt;/pre&gt;
&nbsp;	 *
&nbsp;	 * is transformed to
&nbsp;	 *
&nbsp;	 * &lt;pre&gt;
&nbsp;	 * SELECT ?name WHERE {
&nbsp;	 *   ?x foaf:name ?name .
&nbsp;	 * }
&nbsp;	 * &lt;/pre&gt;
&nbsp;	 *
&nbsp;	 *
&nbsp;	 * Rules applied:
&nbsp;	 * &lt;ul&gt;
&nbsp;	 * &lt;li&gt;The longest matching namespace wins (if one namespace is a substring of another)&lt;/li&gt;
&nbsp;	 * &lt;li&gt;No replacement if the namespace occurs in a string, i.e., within &lt;code&gt;&quot;&lt;/code&gt; or &lt;code&gt;&#39;&#39;&#39;&lt;/code&gt;&lt;/li&gt;
&nbsp;	 * &lt;li&gt;Only replace if the continuation of the match is a
&nbsp;	 * &lt;a href=&quot;https://www.w3.org/TR/sparql11-query/#rPN_LOCAL&quot;&gt;local name&lt;/a&gt; (&lt;/li&gt;
&nbsp;	 * &lt;/ul&gt;
&nbsp;	 *
&nbsp;	 * @param queryString the query string
&nbsp;	 * @return the query string, namespaces replaced with prefix label
&nbsp;	 */
&nbsp;	public String replacePrefixesInQuery(String queryString) {
<b class="nc">&nbsp;		boolean isInsideDoubleQuotes = false, isInsideMultlineQuotes = false, isInsideString = false;</b>
<b class="nc">&nbsp;		StringBuilder sb = new StringBuilder();</b>
<b class="nc">&nbsp;		int pos = 0;</b>
<b class="nc">&nbsp;		int lastPos = 0;</b>
<b class="nc">&nbsp;		while (pos != -1 &amp;&amp; pos &lt; queryString.length()) {</b>
<b class="nc">&nbsp;			pos = findNextRelevantIndex(queryString, lastPos, isInsideString);</b>
<b class="nc">&nbsp;			if (pos == -1) {</b>
<b class="nc">&nbsp;				break;</b>
&nbsp;			}
<b class="nc">&nbsp;			if (pos &gt;= queryString.length() - 1) {</b>
<b class="nc">&nbsp;				break;</b>
&nbsp;			}
<b class="nc">&nbsp;			sb.append(queryString, lastPos, pos);</b>
<b class="nc">&nbsp;			if (isInsideString) {</b>
<b class="nc">&nbsp;				if (isEscapeChar(queryString, pos)) {</b>
<b class="nc">&nbsp;					sb.append(queryString, pos, pos + 2);</b>
<b class="nc">&nbsp;					pos = pos + 2;</b>
<b class="nc">&nbsp;					lastPos = pos;</b>
<b class="nc">&nbsp;					continue;</b>
&nbsp;				}
<b class="nc">&nbsp;				if (isInsideDoubleQuotes &amp;&amp; isDoubleQuote(queryString, pos)) {</b>
<b class="nc">&nbsp;					sb.append(queryString, pos, pos + 1);</b>
<b class="nc">&nbsp;					isInsideString = false;</b>
<b class="nc">&nbsp;					isInsideDoubleQuotes = false;</b>
<b class="nc">&nbsp;					pos++;</b>
<b class="nc">&nbsp;					lastPos = pos;</b>
<b class="nc">&nbsp;					continue;</b>
&nbsp;				}
<b class="nc">&nbsp;				if (isInsideMultlineQuotes &amp;&amp; isMultilineQuote(queryString, pos)) {</b>
<b class="nc">&nbsp;					sb.append(queryString, pos, pos + 3);</b>
<b class="nc">&nbsp;					isInsideString = false;</b>
<b class="nc">&nbsp;					isInsideMultlineQuotes = false;</b>
<b class="nc">&nbsp;					pos = pos + 3;</b>
<b class="nc">&nbsp;					lastPos = pos;</b>
<b class="nc">&nbsp;					continue;</b>
&nbsp;				}
&nbsp;			} else {
<b class="nc">&nbsp;				if (isDoubleQuote(queryString, pos)) {</b>
<b class="nc">&nbsp;					sb.append(queryString, pos, pos + 1);</b>
<b class="nc">&nbsp;					isInsideString = true;</b>
<b class="nc">&nbsp;					isInsideDoubleQuotes = true;</b>
<b class="nc">&nbsp;					pos++;</b>
<b class="nc">&nbsp;					lastPos = pos;</b>
<b class="nc">&nbsp;					continue;</b>
&nbsp;				}
<b class="nc">&nbsp;				if (isMultilineQuote(queryString, pos)) {</b>
<b class="nc">&nbsp;					sb.append(queryString, pos, pos + 3);</b>
<b class="nc">&nbsp;					isInsideString = true;</b>
<b class="nc">&nbsp;					isInsideMultlineQuotes = true;</b>
<b class="nc">&nbsp;					pos = pos + 3;</b>
<b class="nc">&nbsp;					lastPos = pos;</b>
<b class="nc">&nbsp;					continue;</b>
&nbsp;				}
&nbsp;			}
<b class="nc">&nbsp;			if (isInsideString) {</b>
<b class="nc">&nbsp;				sb.append(queryString, pos, pos + 1);</b>
<b class="nc">&nbsp;				pos++;</b>
<b class="nc">&nbsp;				lastPos = pos;</b>
<b class="nc">&nbsp;				continue;</b>
&nbsp;			}
<b class="nc">&nbsp;			if (isOpeningAngledBracket(queryString, pos)) { // test not necessary but makes code more readable</b>
<b class="nc">&nbsp;				Prefix matchingPrefix = findMatchingPrefix(queryString, pos + 1);</b>
<b class="nc">&nbsp;				if (matchingPrefix != null) {</b>
<b class="nc">&nbsp;					int posOfClosingBracket = queryString.indexOf(&#39;&gt;&#39;, pos);</b>
<b class="nc">&nbsp;					if (posOfClosingBracket &gt; -1) {</b>
<b class="nc">&nbsp;						int replacementLength = matchingPrefix.getIri().getQueryString().length() - 2; // subtract 2 for</b>
&nbsp;																										// &#39;&lt;&#39;
&nbsp;						// and &#39;&gt;&#39;
<b class="nc">&nbsp;						sb</b>
<b class="nc">&nbsp;								.append(matchingPrefix.getLabel())</b>
<b class="nc">&nbsp;								.append(&quot;:&quot;)</b>
<b class="nc">&nbsp;								.append(queryString, pos + 1 + replacementLength, posOfClosingBracket);</b>
<b class="nc">&nbsp;						pos = posOfClosingBracket + 1;</b>
&nbsp;					}
<b class="nc">&nbsp;				} else {</b>
<b class="nc">&nbsp;					sb.append(&#39;&lt;&#39;);</b>
<b class="nc">&nbsp;					pos++;</b>
&nbsp;				}
&nbsp;			}
<b class="nc">&nbsp;			lastPos = pos;</b>
&nbsp;		}
<b class="nc">&nbsp;		if (pos == -1) {</b>
<b class="nc">&nbsp;			sb.append(queryString.substring(lastPos));</b>
&nbsp;		}
<b class="nc">&nbsp;		return sb.toString();</b>
&nbsp;	}
&nbsp;
&nbsp;	private boolean isOpeningAngledBracket(String queryString, int pos) {
<b class="nc">&nbsp;		return queryString.charAt(pos) == &#39;&lt;&#39;;</b>
&nbsp;	}
&nbsp;
&nbsp;	private boolean isMultilineQuote(String queryString, int pos) {
<b class="nc">&nbsp;		return queryString.startsWith(&quot;&#39;&#39;&#39;&quot;, pos);</b>
&nbsp;	}
&nbsp;
&nbsp;	private boolean isEscapeChar(String queryString, int pos) {
<b class="nc">&nbsp;		return queryString.charAt(pos) == &#39;\\&#39;;</b>
&nbsp;	}
&nbsp;
&nbsp;	private boolean isDoubleQuote(String queryString, int pos) {
<b class="nc">&nbsp;		return queryString.charAt(pos) == &#39;&quot;&#39;;</b>
&nbsp;	}
&nbsp;
&nbsp;	private int findNextRelevantIndex(String queryString, int lastPos, boolean isInsideString) {
<b class="nc">&nbsp;		int[] mins = new int[] {</b>
<b class="nc">&nbsp;				isInsideString ? -1 : queryString.indexOf(&#39;&lt;&#39;, lastPos),</b>
<b class="nc">&nbsp;				isInsideString ? queryString.indexOf(&#39;\\&#39;, lastPos) : -1,</b>
<b class="nc">&nbsp;				queryString.indexOf(&#39;&quot;&#39;, lastPos),</b>
<b class="nc">&nbsp;				queryString.indexOf(&quot;&#39;&#39;&#39;&quot;, lastPos)</b>
&nbsp;		};
<b class="nc">&nbsp;		int min = Integer.MAX_VALUE;</b>
<b class="nc">&nbsp;		for (int j : mins) {</b>
<b class="nc">&nbsp;			if (j &gt;= 0) {</b>
<b class="nc">&nbsp;				min = Math.min(min, j);</b>
&nbsp;			}
&nbsp;		}
<b class="nc">&nbsp;		return min == Integer.MAX_VALUE ? -1 : min;</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Returns the longest prefix that is found starting at position &lt;code&gt;pos&lt;/code&gt; in the &lt;code&gt;queryString&lt;/code&gt;
&nbsp;	 *
&nbsp;	 * @param queryString the query string
&nbsp;	 * @param pos         the position at which to start looking
&nbsp;	 * @return the longest prefixIri that matches fully (no tie-break for duplicates)
&nbsp;	 */
&nbsp;	private Prefix findMatchingPrefix(String queryString, int pos) {
<b class="nc">&nbsp;		return elements</b>
<b class="nc">&nbsp;				.stream()</b>
<b class="nc">&nbsp;				.filter(p -&gt; queryString.startsWith(getIRIStringFromPrefix(p), pos))</b>
<b class="nc">&nbsp;				.filter(p -&gt; isContinuationALocalName(</b>
<b class="nc">&nbsp;						queryString.substring(pos + p.getIri().getQueryString().length() - 2)))</b>
<b class="nc">&nbsp;				.reduce((r, l) -&gt; r.getIri().getQueryString().length() &gt; l.getIri().getQueryString().length() ? r : l)</b>
<b class="nc">&nbsp;				.orElse(null);</b>
&nbsp;	}
&nbsp;
&nbsp;	private boolean isContinuationALocalName(String continuation) {
<b class="nc">&nbsp;		String localNameCandiate = continuation.substring(0, findNextWhitespace(continuation));</b>
<b class="nc">&nbsp;		return URIUtil.isValidLocalName(localNameCandiate);</b>
&nbsp;	}
&nbsp;
&nbsp;	private int findNextWhitespace(String continuation) {
<b class="nc">&nbsp;		int i = 0;</b>
<b class="nc">&nbsp;		while (i &lt; continuation.length()) {</b>
<b class="nc">&nbsp;			char cur = continuation.charAt(i);</b>
<b class="nc">&nbsp;			if (Character.isWhitespace(cur)) {</b>
<b class="nc">&nbsp;				break;</b>
&nbsp;			}
<b class="nc">&nbsp;			if (&#39;&gt;&#39; == cur) {</b>
<b class="nc">&nbsp;				break;</b>
&nbsp;			}
<b class="nc">&nbsp;			i++;</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		return i;</b>
&nbsp;	}
&nbsp;
&nbsp;	private String getIRIStringFromPrefix(Prefix p) {
<b class="nc">&nbsp;		return p.getIri().getQueryString().substring(1, p.getIri().getQueryString().length() - 1);</b>
&nbsp;	}
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2022-09-18 08:56</div>
</div>
</body>
</html>
