


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > ArrayBindingBasedQueryEvaluationContext</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.eclipse.rdf4j.query.algebra.evaluation.impl</a>
</div>

<h1>Coverage Summary for Class: ArrayBindingBasedQueryEvaluationContext (org.eclipse.rdf4j.query.algebra.evaluation.impl)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ArrayBindingBasedQueryEvaluationContext</td>
<td class="coverageStat">
  <span class="percent">
    86.7%
  </span>
  <span class="absValue">
    (13/15)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    66.7%
  </span>
  <span class="absValue">
    (36/54)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    87%
  </span>
  <span class="absValue">
    (67/77)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ArrayBindingBasedQueryEvaluationContext$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (8/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (8/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (30/30)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ArrayBindingBasedQueryEvaluationContext$HasBinding</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    75%
  </span>
  <span class="absValue">
    (3/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    87.5%
  </span>
  <span class="absValue">
    (7/8)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ArrayBindingBasedQueryEvaluationContext$ValueGetter</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (4/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (8/8)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    92.6%
  </span>
  <span class="absValue">
    (25/27)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    72.9%
  </span>
  <span class="absValue">
    (51/70)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    91.1%
  </span>
  <span class="absValue">
    (112/123)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*******************************************************************************
&nbsp; * Copyright (c) 2021 Eclipse RDF4J contributors.
&nbsp; *
&nbsp; * All rights reserved. This program and the accompanying materials
&nbsp; * are made available under the terms of the Eclipse Distribution License v1.0
&nbsp; * which accompanies this distribution, and is available at
&nbsp; * http://www.eclipse.org/org/documents/edl-v10.php.
&nbsp; *
&nbsp; * SPDX-License-Identifier: BSD-3-Clause
&nbsp; *******************************************************************************/
&nbsp;package org.eclipse.rdf4j.query.algebra.evaluation.impl;
&nbsp;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.HashSet;
&nbsp;import java.util.LinkedHashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Set;
&nbsp;import java.util.function.BiConsumer;
&nbsp;import java.util.function.Function;
&nbsp;import java.util.function.Predicate;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import org.eclipse.rdf4j.model.Literal;
&nbsp;import org.eclipse.rdf4j.model.Value;
&nbsp;import org.eclipse.rdf4j.query.Binding;
&nbsp;import org.eclipse.rdf4j.query.BindingSet;
&nbsp;import org.eclipse.rdf4j.query.Dataset;
&nbsp;import org.eclipse.rdf4j.query.MutableBindingSet;
&nbsp;import org.eclipse.rdf4j.query.QueryEvaluationException;
&nbsp;import org.eclipse.rdf4j.query.algebra.ExtensionElem;
&nbsp;import org.eclipse.rdf4j.query.algebra.Group;
&nbsp;import org.eclipse.rdf4j.query.algebra.MultiProjection;
&nbsp;import org.eclipse.rdf4j.query.algebra.Projection;
&nbsp;import org.eclipse.rdf4j.query.algebra.ProjectionElem;
&nbsp;import org.eclipse.rdf4j.query.algebra.QueryRoot;
&nbsp;import org.eclipse.rdf4j.query.algebra.StatementPattern;
&nbsp;import org.eclipse.rdf4j.query.algebra.UnaryTupleOperator;
&nbsp;import org.eclipse.rdf4j.query.algebra.Var;
&nbsp;import org.eclipse.rdf4j.query.algebra.ZeroLengthPath;
&nbsp;import org.eclipse.rdf4j.query.algebra.evaluation.ArrayBindingSet;
&nbsp;import org.eclipse.rdf4j.query.algebra.evaluation.iterator.ZeroLengthPathIteration;
&nbsp;import org.eclipse.rdf4j.query.algebra.helpers.AbstractSimpleQueryModelVisitor;
&nbsp;import org.eclipse.rdf4j.query.impl.EmptyBindingSet;
&nbsp;
<b class="fc">&nbsp;public final class ArrayBindingBasedQueryEvaluationContext implements QueryEvaluationContext {</b>
&nbsp;	private final QueryEvaluationContext context;
&nbsp;	private final String[] allVariables;
&nbsp;	private final Set&lt;String&gt; allVariablesSet;
&nbsp;	private final ArrayBindingSet defaultArrayBindingSet;
&nbsp;	private final Predicate&lt;BindingSet&gt;[] hasBinding;
&nbsp;	private final Function&lt;BindingSet, Binding&gt;[] getBinding;
&nbsp;	private final Function&lt;BindingSet, Value&gt;[] getValue;
&nbsp;	private final BiConsumer&lt;Value, MutableBindingSet&gt;[] setBinding;
&nbsp;	private final BiConsumer&lt;Value, MutableBindingSet&gt;[] addBinding;
&nbsp;
&nbsp;	boolean initialized;
&nbsp;
<b class="fc">&nbsp;	ArrayBindingBasedQueryEvaluationContext(QueryEvaluationContext context, String[] allVariables) {</b>
<b class="pc">&nbsp;		assert new HashSet&lt;&gt;(Arrays.asList(allVariables)).size() == allVariables.length;</b>
<b class="fc">&nbsp;		this.context = context;</b>
<b class="fc">&nbsp;		this.allVariables = allVariables;</b>
<b class="fc">&nbsp;		this.allVariablesSet = Set.of(allVariables);</b>
<b class="fc">&nbsp;		this.defaultArrayBindingSet = new ArrayBindingSet(allVariables);</b>
&nbsp;
<b class="fc">&nbsp;		hasBinding = new Predicate[allVariables.length];</b>
<b class="fc">&nbsp;		getBinding = new Function[allVariables.length];</b>
<b class="fc">&nbsp;		getValue = new Function[allVariables.length];</b>
<b class="fc">&nbsp;		setBinding = new BiConsumer[allVariables.length];</b>
<b class="fc">&nbsp;		addBinding = new BiConsumer[allVariables.length];</b>
&nbsp;
<b class="fc">&nbsp;		for (int i = 0; i &lt; allVariables.length; i++) {</b>
<b class="fc">&nbsp;			hasBinding[i] = hasBinding(allVariables[i]);</b>
<b class="fc">&nbsp;			getBinding[i] = getBinding(allVariables[i]);</b>
<b class="fc">&nbsp;			getValue[i] = getValue(allVariables[i]);</b>
<b class="fc">&nbsp;			setBinding[i] = setBinding(allVariables[i]);</b>
<b class="fc">&nbsp;			addBinding[i] = addBinding(allVariables[i]);</b>
&nbsp;		}
&nbsp;
<b class="fc">&nbsp;		initialized = true;</b>
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public Literal getNow() {
<b class="nc">&nbsp;		return context.getNow();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public Dataset getDataset() {
<b class="fc">&nbsp;		return context.getDataset();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public ArrayBindingSet createBindingSet() {
<b class="fc">&nbsp;		return new ArrayBindingSet(allVariables);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public Predicate&lt;BindingSet&gt; hasBinding(String variableName) {
<b class="fc">&nbsp;		if (initialized) {</b>
<b class="pc">&nbsp;			for (int i = 0; i &lt; allVariables.length; i++) {</b>
<b class="fc">&nbsp;				if (allVariables[i] == variableName) {</b>
<b class="fc">&nbsp;					return hasBinding[i];</b>
&nbsp;				}
&nbsp;			}
&nbsp;		}
&nbsp;
<b class="pc">&nbsp;		assert variableName != null &amp;&amp; !variableName.isEmpty();</b>
<b class="fc">&nbsp;		Function&lt;ArrayBindingSet, Boolean&gt; directHasVariable = defaultArrayBindingSet.getDirectHasBinding(variableName);</b>
<b class="fc">&nbsp;		return new HasBinding(variableName, directHasVariable);</b>
&nbsp;	}
&nbsp;
&nbsp;	static private class HasBinding implements Predicate&lt;BindingSet&gt; {
&nbsp;
&nbsp;		private final String variableName;
&nbsp;		private final Function&lt;ArrayBindingSet, Boolean&gt; directHasVariable;
&nbsp;
<b class="fc">&nbsp;		public HasBinding(String variableName, Function&lt;ArrayBindingSet, Boolean&gt; directHasVariable) {</b>
<b class="fc">&nbsp;			this.variableName = variableName;</b>
<b class="fc">&nbsp;			this.directHasVariable = directHasVariable;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public boolean test(BindingSet bs) {
<b class="pc">&nbsp;			if (bs.isEmpty()) {</b>
<b class="nc">&nbsp;				return false;</b>
&nbsp;			}
<b class="fc">&nbsp;			if (bs instanceof ArrayBindingSet) {</b>
<b class="fc">&nbsp;				return directHasVariable.apply((ArrayBindingSet) bs);</b>
&nbsp;			} else {
<b class="fc">&nbsp;				return bs.hasBinding(variableName);</b>
&nbsp;			}
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public Function&lt;BindingSet, Binding&gt; getBinding(String variableName) {
<b class="pc">&nbsp;		if (initialized) {</b>
<b class="nc">&nbsp;			for (int i = 0; i &lt; allVariables.length; i++) {</b>
<b class="nc">&nbsp;				if (allVariables[i] == variableName) {</b>
<b class="nc">&nbsp;					return getBinding[i];</b>
&nbsp;				}
&nbsp;			}
&nbsp;		}
&nbsp;
<b class="fc">&nbsp;		Function&lt;ArrayBindingSet, Binding&gt; directAccessForVariable = defaultArrayBindingSet</b>
<b class="fc">&nbsp;				.getDirectGetBinding(variableName);</b>
<b class="fc">&nbsp;		return (bs) -&gt; {</b>
<b class="nc">&nbsp;			if (bs.isEmpty()) {</b>
<b class="nc">&nbsp;				return null;</b>
&nbsp;			}
<b class="nc">&nbsp;			if (bs instanceof ArrayBindingSet) {</b>
<b class="nc">&nbsp;				return directAccessForVariable.apply((ArrayBindingSet) bs);</b>
&nbsp;			} else {
<b class="nc">&nbsp;				return bs.getBinding(variableName);</b>
&nbsp;			}
&nbsp;		};
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public Function&lt;BindingSet, Value&gt; getValue(String variableName) {
<b class="fc">&nbsp;		if (initialized) {</b>
<b class="pc">&nbsp;			for (int i = 0; i &lt; allVariables.length; i++) {</b>
<b class="fc">&nbsp;				if (allVariables[i] == variableName) {</b>
<b class="fc">&nbsp;					return getValue[i];</b>
&nbsp;				}
&nbsp;			}
&nbsp;		}
&nbsp;
<b class="fc">&nbsp;		Function&lt;ArrayBindingSet, Value&gt; directAccessForVariable = defaultArrayBindingSet</b>
<b class="fc">&nbsp;				.getDirectGetValue(variableName);</b>
<b class="fc">&nbsp;		return new ValueGetter(variableName, directAccessForVariable);</b>
&nbsp;	}
&nbsp;
&nbsp;	private static class ValueGetter implements Function&lt;BindingSet, Value&gt; {
&nbsp;
&nbsp;		private final String variableName;
&nbsp;		private final Function&lt;ArrayBindingSet, Value&gt; directAccessForVariable;
&nbsp;
<b class="fc">&nbsp;		public ValueGetter(String variableName, Function&lt;ArrayBindingSet, Value&gt; directAccessForVariable) {</b>
&nbsp;
<b class="fc">&nbsp;			this.variableName = variableName;</b>
<b class="fc">&nbsp;			this.directAccessForVariable = directAccessForVariable;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public Value apply(BindingSet bs) {
<b class="fc">&nbsp;			if (bs.isEmpty()) {</b>
<b class="fc">&nbsp;				return null;</b>
&nbsp;			}
<b class="fc">&nbsp;			if (bs instanceof ArrayBindingSet) {</b>
<b class="fc">&nbsp;				return directAccessForVariable.apply((ArrayBindingSet) bs);</b>
&nbsp;			} else {
<b class="fc">&nbsp;				return bs.getValue(variableName);</b>
&nbsp;			}
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public BiConsumer&lt;Value, MutableBindingSet&gt; setBinding(String variableName) {
<b class="fc">&nbsp;		if (initialized) {</b>
<b class="fc">&nbsp;			for (int i = 0; i &lt; allVariables.length; i++) {</b>
<b class="fc">&nbsp;				if (allVariables[i] == variableName) {</b>
<b class="fc">&nbsp;					return setBinding[i];</b>
&nbsp;				}
&nbsp;			}
&nbsp;		}
&nbsp;
<b class="fc">&nbsp;		BiConsumer&lt;Value, ArrayBindingSet&gt; directAccessForVariable = defaultArrayBindingSet</b>
<b class="fc">&nbsp;				.getDirectSetBinding(variableName);</b>
<b class="fc">&nbsp;		return (val, bs) -&gt; {</b>
<b class="pc">&nbsp;			if (bs instanceof ArrayBindingSet) {</b>
<b class="fc">&nbsp;				directAccessForVariable.accept(val, (ArrayBindingSet) bs);</b>
&nbsp;			} else {
<b class="nc">&nbsp;				bs.setBinding(variableName, val);</b>
&nbsp;			}
&nbsp;		};
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public BiConsumer&lt;Value, MutableBindingSet&gt; addBinding(String variableName) {
<b class="fc">&nbsp;		if (initialized) {</b>
<b class="pc">&nbsp;			for (int i = 0; i &lt; allVariables.length; i++) {</b>
<b class="fc">&nbsp;				if (allVariables[i] == variableName) {</b>
<b class="fc">&nbsp;					return addBinding[i];</b>
&nbsp;				}
&nbsp;			}
&nbsp;		}
&nbsp;
<b class="fc">&nbsp;		BiConsumer&lt;Value, ArrayBindingSet&gt; wrapped = defaultArrayBindingSet</b>
<b class="fc">&nbsp;				.getDirectAddBinding(variableName);</b>
<b class="fc">&nbsp;		return (val, bs) -&gt; {</b>
<b class="fc">&nbsp;			if (bs instanceof ArrayBindingSet) {</b>
<b class="fc">&nbsp;				wrapped.accept(val, (ArrayBindingSet) bs);</b>
&nbsp;			} else {
<b class="fc">&nbsp;				bs.addBinding(variableName, val);</b>
&nbsp;			}
&nbsp;		};
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public ArrayBindingSet createBindingSet(BindingSet bindings) {
<b class="fc">&nbsp;		if (bindings instanceof ArrayBindingSet) {</b>
<b class="fc">&nbsp;			return new ArrayBindingSet(((ArrayBindingSet) bindings), allVariables);</b>
<b class="fc">&nbsp;		} else if (bindings == EmptyBindingSet.getInstance()) {</b>
<b class="fc">&nbsp;			return createBindingSet();</b>
&nbsp;		} else {
<b class="fc">&nbsp;			return new ArrayBindingSet(bindings, allVariablesSet, allVariables);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	public static String[] findAllVariablesUsedInQuery(QueryRoot node) {
<b class="fc">&nbsp;		HashMap&lt;String, String&gt; varNames = new LinkedHashMap&lt;&gt;();</b>
<b class="fc">&nbsp;		AbstractSimpleQueryModelVisitor&lt;QueryEvaluationException&gt; queryModelVisitorBase = new AbstractSimpleQueryModelVisitor&lt;&gt;(</b>
<b class="fc">&nbsp;				true) {</b>
&nbsp;
&nbsp;			@Override
&nbsp;			public void meet(Var node) throws QueryEvaluationException {
<b class="fc">&nbsp;				super.meet(node);</b>
&nbsp;				// We can skip constants that are only used in StatementPatterns since these are never added to the
&nbsp;				// BindingSet anyway
<b class="fc">&nbsp;				if (!(node.isConstant() &amp;&amp; node.getParentNode() instanceof StatementPattern)) {</b>
<b class="fc">&nbsp;					Var replacement = new Var(varNames.computeIfAbsent(node.getName(), k -&gt; k), node.getValue(),</b>
<b class="fc">&nbsp;							node.isAnonymous(), node.isConstant());</b>
<b class="fc">&nbsp;					node.replaceWith(replacement);</b>
&nbsp;				}
&nbsp;			}
&nbsp;
&nbsp;			@Override
&nbsp;			public void meet(ProjectionElem node) throws QueryEvaluationException {
<b class="fc">&nbsp;				super.meet(node);</b>
<b class="fc">&nbsp;				node.setName(varNames.computeIfAbsent(node.getName(), k -&gt; k));</b>
<b class="fc">&nbsp;				node.setProjectionAlias(varNames.computeIfAbsent(node.getProjectionAlias().orElse(null), k -&gt; k));</b>
&nbsp;			}
&nbsp;
&nbsp;			@Override
&nbsp;			protected void meetUnaryTupleOperator(UnaryTupleOperator node) throws QueryEvaluationException {
<b class="fc">&nbsp;				if (node instanceof Projection) {</b>
<b class="fc">&nbsp;					node.getArg().visit(this);</b>
<b class="fc">&nbsp;					((Projection) node).getProjectionElemList().visit(this);</b>
&nbsp;				} else {
<b class="fc">&nbsp;					node.visitChildren(this);</b>
&nbsp;				}
&nbsp;			}
&nbsp;
&nbsp;			@Override
&nbsp;			public void meet(MultiProjection node) throws QueryEvaluationException {
<b class="fc">&nbsp;				for (String bindingName : node.getBindingNames()) {</b>
<b class="fc">&nbsp;					varNames.computeIfAbsent(bindingName, k -&gt; k);</b>
<b class="fc">&nbsp;				}</b>
<b class="fc">&nbsp;				super.meet(node);</b>
&nbsp;			}
&nbsp;
&nbsp;			@Override
&nbsp;			public void meet(ZeroLengthPath node) throws QueryEvaluationException {
<b class="fc">&nbsp;				varNames.computeIfAbsent(ZeroLengthPathIteration.ANON_SUBJECT_VAR, k -&gt; k);</b>
<b class="fc">&nbsp;				varNames.computeIfAbsent(ZeroLengthPathIteration.ANON_PREDICATE_VAR, k -&gt; k);</b>
<b class="fc">&nbsp;				varNames.computeIfAbsent(ZeroLengthPathIteration.ANON_OBJECT_VAR, k -&gt; k);</b>
<b class="fc">&nbsp;				varNames.computeIfAbsent(ZeroLengthPathIteration.ANON_SEQUENCE_VAR, k -&gt; k);</b>
<b class="fc">&nbsp;				super.meet(node);</b>
&nbsp;			}
&nbsp;
&nbsp;			@Override
&nbsp;			public void meet(ExtensionElem node) throws QueryEvaluationException {
<b class="fc">&nbsp;				node.setName(varNames.computeIfAbsent(node.getName(), k -&gt; k));</b>
<b class="fc">&nbsp;				super.meet(node);</b>
&nbsp;			}
&nbsp;
&nbsp;			@Override
&nbsp;			public void meet(Group node) throws QueryEvaluationException {
<b class="fc">&nbsp;				List&lt;String&gt; collect = node.getGroupBindingNames()</b>
<b class="fc">&nbsp;						.stream()</b>
<b class="fc">&nbsp;						.map(varName -&gt; varNames.computeIfAbsent(varName, k -&gt; k))</b>
<b class="fc">&nbsp;						.collect(Collectors.toList());</b>
<b class="fc">&nbsp;				node.setGroupBindingNames(collect);</b>
<b class="fc">&nbsp;				super.meet(node);</b>
&nbsp;			}
&nbsp;		};
<b class="fc">&nbsp;		node.visit(queryModelVisitorBase);</b>
<b class="fc">&nbsp;		return varNames.keySet().toArray(new String[0]);</b>
&nbsp;	}
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2022-09-18 08:56</div>
</div>
</body>
</html>
