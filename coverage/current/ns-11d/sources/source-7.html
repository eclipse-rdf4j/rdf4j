


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > RepositoryConnectionTest</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.eclipse.rdf4j.testsuite.repository</a>
</div>

<h1>Coverage Summary for Class: RepositoryConnectionTest (org.eclipse.rdf4j.testsuite.repository)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">RepositoryConnectionTest</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/81)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/252)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1001)
  </span>
</td>
</tr>
  <tr>
    <td class="name">RepositoryConnectionTest$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">RepositoryConnectionTest$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">RepositoryConnectionTest$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">RepositoryConnectionTest$4</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/89)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/252)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1009)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*******************************************************************************
&nbsp; * Copyright (c) 2015 Eclipse RDF4J contributors, Aduna, and others.
&nbsp; *
&nbsp; * All rights reserved. This program and the accompanying materials
&nbsp; * are made available under the terms of the Eclipse Distribution License v1.0
&nbsp; * which accompanies this distribution, and is available at
&nbsp; * http://www.eclipse.org/org/documents/edl-v10.php.
&nbsp; *
&nbsp; * SPDX-License-Identifier: BSD-3-Clause
&nbsp; *******************************************************************************/
&nbsp;package org.eclipse.rdf4j.testsuite.repository;
&nbsp;
&nbsp;import static org.assertj.core.api.Assertions.assertThat;
&nbsp;import static org.junit.Assert.assertEquals;
&nbsp;import static org.junit.Assert.assertFalse;
&nbsp;import static org.junit.Assert.assertNotNull;
&nbsp;import static org.junit.Assert.assertNull;
&nbsp;import static org.junit.Assert.assertTrue;
&nbsp;import static org.junit.Assert.fail;
&nbsp;
&nbsp;import java.io.ByteArrayInputStream;
&nbsp;import java.io.ByteArrayOutputStream;
&nbsp;import java.io.IOException;
&nbsp;import java.io.InputStream;
&nbsp;import java.io.InputStreamReader;
&nbsp;import java.io.ObjectInputStream;
&nbsp;import java.io.ObjectOutputStream;
&nbsp;import java.io.Reader;
&nbsp;import java.io.StringReader;
&nbsp;import java.nio.charset.StandardCharsets;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.Calendar;
&nbsp;import java.util.Collection;
&nbsp;import java.util.Collections;
&nbsp;import java.util.GregorianCalendar;
&nbsp;import java.util.HashSet;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Set;
&nbsp;import java.util.TimeZone;
&nbsp;import java.util.concurrent.TimeUnit;
&nbsp;import java.util.stream.Collectors;
&nbsp;import java.util.stream.Stream;
&nbsp;
&nbsp;import javax.xml.datatype.DatatypeFactory;
&nbsp;import javax.xml.datatype.XMLGregorianCalendar;
&nbsp;
&nbsp;import org.eclipse.rdf4j.common.exception.RDF4JException;
&nbsp;import org.eclipse.rdf4j.common.iteration.CloseableIteration;
&nbsp;import org.eclipse.rdf4j.common.iteration.Iterations;
&nbsp;import org.eclipse.rdf4j.common.transaction.IsolationLevel;
&nbsp;import org.eclipse.rdf4j.common.transaction.IsolationLevels;
&nbsp;import org.eclipse.rdf4j.model.BNode;
&nbsp;import org.eclipse.rdf4j.model.IRI;
&nbsp;import org.eclipse.rdf4j.model.Literal;
&nbsp;import org.eclipse.rdf4j.model.Model;
&nbsp;import org.eclipse.rdf4j.model.Resource;
&nbsp;import org.eclipse.rdf4j.model.Statement;
&nbsp;import org.eclipse.rdf4j.model.Value;
&nbsp;import org.eclipse.rdf4j.model.ValueFactory;
&nbsp;import org.eclipse.rdf4j.model.impl.LinkedHashModel;
&nbsp;import org.eclipse.rdf4j.model.util.Namespaces;
&nbsp;import org.eclipse.rdf4j.model.vocabulary.DC;
&nbsp;import org.eclipse.rdf4j.model.vocabulary.FOAF;
&nbsp;import org.eclipse.rdf4j.model.vocabulary.RDF;
&nbsp;import org.eclipse.rdf4j.model.vocabulary.RDFS;
&nbsp;import org.eclipse.rdf4j.model.vocabulary.XSD;
&nbsp;import org.eclipse.rdf4j.query.BindingSet;
&nbsp;import org.eclipse.rdf4j.query.BooleanQuery;
&nbsp;import org.eclipse.rdf4j.query.GraphQuery;
&nbsp;import org.eclipse.rdf4j.query.GraphQueryResult;
&nbsp;import org.eclipse.rdf4j.query.MalformedQueryException;
&nbsp;import org.eclipse.rdf4j.query.QueryEvaluationException;
&nbsp;import org.eclipse.rdf4j.query.QueryLanguage;
&nbsp;import org.eclipse.rdf4j.query.TupleQuery;
&nbsp;import org.eclipse.rdf4j.query.TupleQueryResult;
&nbsp;import org.eclipse.rdf4j.query.Update;
&nbsp;import org.eclipse.rdf4j.query.impl.SimpleDataset;
&nbsp;import org.eclipse.rdf4j.repository.Repository;
&nbsp;import org.eclipse.rdf4j.repository.RepositoryConnection;
&nbsp;import org.eclipse.rdf4j.repository.RepositoryException;
&nbsp;import org.eclipse.rdf4j.repository.RepositoryResult;
&nbsp;import org.eclipse.rdf4j.rio.RDFFormat;
&nbsp;import org.eclipse.rdf4j.rio.RDFHandlerException;
&nbsp;import org.eclipse.rdf4j.rio.RDFParseException;
&nbsp;import org.eclipse.rdf4j.rio.RioSetting;
&nbsp;import org.eclipse.rdf4j.rio.helpers.AbstractRDFHandler;
&nbsp;import org.junit.After;
&nbsp;import org.junit.Assert;
&nbsp;import org.junit.Before;
&nbsp;import org.junit.BeforeClass;
&nbsp;import org.junit.Rule;
&nbsp;import org.junit.Test;
&nbsp;import org.junit.rules.Timeout;
&nbsp;import org.junit.runner.RunWith;
&nbsp;import org.junit.runners.Parameterized;
&nbsp;import org.junit.runners.Parameterized.Parameters;
&nbsp;import org.slf4j.Logger;
&nbsp;import org.slf4j.LoggerFactory;
&nbsp;
&nbsp;@RunWith(Parameterized.class)
&nbsp;public abstract class RepositoryConnectionTest {
&nbsp;
<b class="nc">&nbsp;	private final Logger logger = LoggerFactory.getLogger(RepositoryConnectionTest.class);</b>
&nbsp;
&nbsp;	@BeforeClass
&nbsp;	public static void setUpClass() throws Exception {
&nbsp;		// Turn off debugging for this test, as the cleanup processes are working correctly,
&nbsp;		// but they debug a lot of information in testOrderByQueriesAreInterrupable
<b class="nc">&nbsp;		System.setProperty(&quot;org.eclipse.rdf4j.repository.debug&quot;, &quot;false&quot;);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Parameters(name = &quot;{0}&quot;)
&nbsp;	public static IsolationLevel[] parameters() {
<b class="nc">&nbsp;		return IsolationLevels.values();</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Timeout all individual tests after 10 minutes.
&nbsp;	 */
<b class="nc">&nbsp;	@Rule</b>
&nbsp;	public Timeout to = new Timeout(10, TimeUnit.MINUTES);
&nbsp;
&nbsp;	private static final String URN_TEST_OTHER = &quot;urn:test:other&quot;;
&nbsp;
&nbsp;	private static final String SPARQL_DEL_ALL = &quot;DELETE { ?s ?p ?o } WHERE { ?s ?p ?o }&quot;;
&nbsp;
&nbsp;	private static final String URN_TEST_O1 = &quot;urn:test:o1&quot;;
&nbsp;
&nbsp;	private static final String URN_TEST_S1 = &quot;urn:test:s1&quot;;
&nbsp;
&nbsp;	private static final String URN_TEST_P2 = &quot;urn:test:p2&quot;;
&nbsp;
&nbsp;	private static final String URN_TEST_P1 = &quot;urn:test:p1&quot;;
&nbsp;
&nbsp;	private static final String URN_PRED = &quot;urn:pred&quot;;
&nbsp;
&nbsp;	private static final String RDF_PREFIX = &quot;rdf&quot;;
&nbsp;
&nbsp;	private static final String RDFS_NS = &quot;http://www.w3.org/2000/01/rdf-schema#&quot;;
&nbsp;
&nbsp;	private static final String RDFS_PREFIX = &quot;rdfs&quot;;
&nbsp;
&nbsp;	private static final String EXAMPLE_NS = &quot;http://example.org/&quot;;
&nbsp;
&nbsp;	private static final String EXAMPLE = &quot;example&quot;;
&nbsp;
&nbsp;	private static final String ASK = &quot;ASK &quot;;
&nbsp;
&nbsp;	private static final String PREFIX_FOAF = &quot;PREFIX foaf: &lt;&quot;;
&nbsp;
&nbsp;	private static final String PERSON = &quot;person&quot;;
&nbsp;
&nbsp;	private static final String UNEXPECTED_TYPE = &quot;unexpected query object type: &quot;;
&nbsp;
&nbsp;	private static final String UNSUPPORTED_OP = &quot;unsupported operation: &quot;;
&nbsp;
&nbsp;	private static final String NEWLY_ADDED = &quot;Repository should contain newly added statement&quot;;
&nbsp;
&nbsp;	private static final String MBOX = &quot;mbox&quot;;
&nbsp;
&nbsp;	private static final String NAME = &quot;name&quot;;
&nbsp;
&nbsp;	protected static final String FOAF_NS = &quot;http://xmlns.com/foaf/0.1/&quot;;
&nbsp;
&nbsp;	public static final String TEST_DIR_PREFIX = &quot;/testcases/&quot;;
&nbsp;
&nbsp;	protected Repository testRepository;
&nbsp;
&nbsp;	protected RepositoryConnection testCon;
&nbsp;
&nbsp;	protected RepositoryConnection testCon2;
&nbsp;
&nbsp;	protected ValueFactory vf;
&nbsp;
&nbsp;	protected Resource bob;
&nbsp;
&nbsp;	protected Resource alice;
&nbsp;
&nbsp;	protected Resource alexander;
&nbsp;
&nbsp;	protected IRI name;
&nbsp;
&nbsp;	protected IRI mbox;
&nbsp;
<b class="nc">&nbsp;	protected final IRI publisher = DC.PUBLISHER;</b>
&nbsp;
&nbsp;	protected IRI unknownContext;
&nbsp;
&nbsp;	protected IRI context1;
&nbsp;
&nbsp;	protected IRI context2;
&nbsp;
&nbsp;	protected Literal nameAlice;
&nbsp;
&nbsp;	protected Literal nameBob;
&nbsp;
&nbsp;	protected Literal mboxAlice;
&nbsp;
&nbsp;	protected Literal mboxBob;
&nbsp;
&nbsp;	protected Literal Александър;
&nbsp;
&nbsp;	protected IsolationLevel level;
&nbsp;
<b class="nc">&nbsp;	public RepositoryConnectionTest(IsolationLevel level) {</b>
<b class="nc">&nbsp;		this.level = level;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Before
&nbsp;	public void setUp() throws Exception {
<b class="nc">&nbsp;		testRepository = createRepository();</b>
&nbsp;
<b class="nc">&nbsp;		testCon = testRepository.getConnection();</b>
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.clear();</b>
<b class="nc">&nbsp;		testCon.clearNamespaces();</b>
<b class="nc">&nbsp;		testCon.commit();</b>
&nbsp;
<b class="nc">&nbsp;		testCon.setIsolationLevel(level);</b>
&nbsp;
<b class="nc">&nbsp;		testCon2 = testRepository.getConnection();</b>
<b class="nc">&nbsp;		testCon2.setIsolationLevel(level);</b>
&nbsp;
<b class="nc">&nbsp;		vf = testRepository.getValueFactory();</b>
&nbsp;
&nbsp;		// Initialize values
<b class="nc">&nbsp;		bob = vf.createBNode();</b>
<b class="nc">&nbsp;		alice = vf.createBNode();</b>
<b class="nc">&nbsp;		alexander = vf.createBNode();</b>
&nbsp;
<b class="nc">&nbsp;		name = vf.createIRI(FOAF_NS + NAME);</b>
<b class="nc">&nbsp;		mbox = vf.createIRI(FOAF_NS + MBOX);</b>
&nbsp;
<b class="nc">&nbsp;		nameAlice = vf.createLiteral(&quot;Alice&quot;);</b>
<b class="nc">&nbsp;		nameBob = vf.createLiteral(&quot;Bob&quot;);</b>
&nbsp;
<b class="nc">&nbsp;		mboxAlice = vf.createLiteral(&quot;alice@example.org&quot;);</b>
<b class="nc">&nbsp;		mboxBob = vf.createLiteral(&quot;bob@example.org&quot;);</b>
&nbsp;
<b class="nc">&nbsp;		Александър = vf.createLiteral(&quot;Александър&quot;);</b>
&nbsp;
<b class="nc">&nbsp;		unknownContext = vf.createIRI(&quot;urn:unknownContext&quot;);</b>
&nbsp;
<b class="nc">&nbsp;		context1 = vf.createIRI(&quot;urn:x-local:graph1&quot;);</b>
<b class="nc">&nbsp;		context2 = vf.createIRI(&quot;urn:x-local:graph2&quot;);</b>
&nbsp;	}
&nbsp;
&nbsp;	@After
&nbsp;	public void tearDown() throws Exception {
&nbsp;		try {
<b class="nc">&nbsp;			testCon2.close();</b>
&nbsp;		} finally {
<b class="nc">&nbsp;			try {</b>
<b class="nc">&nbsp;				testCon.close();</b>
&nbsp;			} finally {
<b class="nc">&nbsp;				testRepository.shutDown();</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Gets an (uninitialized) instance of the repository that should be tested.
&nbsp;	 *
&nbsp;	 * @return an uninitialized repository.
&nbsp;	 */
&nbsp;	protected abstract Repository createRepository() throws Exception;
&nbsp;
&nbsp;	@Test
&nbsp;	public void testAddStatement() throws Exception {
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob);</b>
&nbsp;
<b class="nc">&nbsp;		assertTrue(NEWLY_ADDED, testCon.hasStatement(bob, name, nameBob, false));</b>
&nbsp;
<b class="nc">&nbsp;		Statement statement = vf.createStatement(alice, name, nameAlice);</b>
<b class="nc">&nbsp;		testCon.add(statement);</b>
&nbsp;
<b class="nc">&nbsp;		assertTrue(NEWLY_ADDED, testCon.hasStatement(statement, false));</b>
<b class="nc">&nbsp;		assertTrue(NEWLY_ADDED, testCon.hasStatement(alice, name, nameAlice, false));</b>
&nbsp;
<b class="nc">&nbsp;		Repository tempRep = createRepository();</b>
<b class="nc">&nbsp;		try (RepositoryConnection con = tempRep.getConnection()) {</b>
&nbsp;
<b class="nc">&nbsp;			con.add(testCon.getStatements(null, null, null, false));</b>
&nbsp;
<b class="nc">&nbsp;			assertTrue(&quot;Temp Repository should contain newly added statement&quot;,</b>
<b class="nc">&nbsp;					con.hasStatement(bob, name, nameBob, false));</b>
<b class="nc">&nbsp;		} finally {</b>
<b class="nc">&nbsp;			tempRep.shutDown();</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testAddStatementWithContext() throws Exception {
<b class="nc">&nbsp;		Statement statement = vf.createStatement(alice, name, nameAlice, context1);</b>
<b class="nc">&nbsp;		testCon.add(statement);</b>
&nbsp;
<b class="nc">&nbsp;		assertTrue(NEWLY_ADDED, testCon.hasStatement(statement, false));</b>
<b class="nc">&nbsp;		assertTrue(NEWLY_ADDED, testCon.hasStatement(alice, name, nameAlice, false));</b>
<b class="nc">&nbsp;		assertTrue(NEWLY_ADDED, testCon.hasStatement(alice, name, nameAlice, false, context1));</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testAddLiteralWithNewline() throws Exception {
<b class="nc">&nbsp;		Literal test = vf.createLiteral(&quot;this is a test\n&quot;);</b>
<b class="nc">&nbsp;		testCon.add(bob, RDFS.LABEL, test);</b>
&nbsp;
<b class="nc">&nbsp;		assertTrue(NEWLY_ADDED, testCon.hasStatement(bob, RDFS.LABEL, test, false));</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testTransactionIsolation() throws Exception {
<b class="nc">&nbsp;		if (IsolationLevels.READ_UNCOMMITTED.isCompatibleWith(level)) {</b>
&nbsp;			return;
&nbsp;		}
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob);</b>
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(bob, name, nameBob, false)).isTrue();</b>
<b class="nc">&nbsp;		assertThat(testCon2.hasStatement(bob, name, nameBob, false)).isFalse();</b>
<b class="nc">&nbsp;		testCon.commit();</b>
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(bob, name, nameBob, false)).isTrue();</b>
<b class="nc">&nbsp;		assertThat(testCon2.hasStatement(bob, name, nameBob, false)).isTrue();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testAddReader() throws Exception {
<b class="nc">&nbsp;		try (Reader defaultGraph = new InputStreamReader(</b>
<b class="nc">&nbsp;				RepositoryConnectionTest.class.getResourceAsStream(TEST_DIR_PREFIX + &quot;default-graph.ttl&quot;),</b>
&nbsp;				StandardCharsets.UTF_8)) {
<b class="nc">&nbsp;			testCon.add(defaultGraph, &quot;&quot;, RDFFormat.TURTLE);</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		assertTrue(NEWLY_ADDED, testCon.hasStatement(null, publisher, nameBob, false));</b>
<b class="nc">&nbsp;		assertTrue(NEWLY_ADDED, testCon.hasStatement(null, publisher, nameAlice, false));</b>
&nbsp;
&nbsp;		// add file graph1.ttl to context1
<b class="nc">&nbsp;		try (InputStream graph1Stream = RepositoryConnectionTest.class</b>
<b class="nc">&nbsp;				.getResourceAsStream(TEST_DIR_PREFIX + &quot;graph1.ttl&quot;);</b>
<b class="nc">&nbsp;				Reader graph1 = new InputStreamReader(graph1Stream, StandardCharsets.UTF_8)) {</b>
<b class="nc">&nbsp;			testCon.add(graph1, &quot;&quot;, RDFFormat.TURTLE, context1);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
&nbsp;		// add file graph2.ttl to context2
<b class="nc">&nbsp;		try (InputStream graph2Stream = RepositoryConnectionTest.class</b>
<b class="nc">&nbsp;				.getResourceAsStream(TEST_DIR_PREFIX + &quot;graph2.ttl&quot;);</b>
<b class="nc">&nbsp;				Reader graph2 = new InputStreamReader(graph2Stream, StandardCharsets.UTF_8)) {</b>
<b class="nc">&nbsp;			testCon.add(graph2, &quot;&quot;, RDFFormat.TURTLE, context2);</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		assertTrue(&quot;alice should be known in the store&quot;, testCon.hasStatement(null, name, nameAlice, false));</b>
<b class="nc">&nbsp;		assertFalse(&quot;alice should not be known in context1&quot;,</b>
<b class="nc">&nbsp;				testCon.hasStatement(null, name, nameAlice, false, context1));</b>
<b class="nc">&nbsp;		assertTrue(&quot;alice should be known in context2&quot;, testCon.hasStatement(null, name, nameAlice, false, context2));</b>
<b class="nc">&nbsp;		assertTrue(&quot;bob should be known in the store&quot;, testCon.hasStatement(null, name, nameBob, false));</b>
<b class="nc">&nbsp;		assertFalse(&quot;bob should not be known in context2&quot;, testCon.hasStatement(null, name, nameBob, false, context2));</b>
<b class="nc">&nbsp;		assertTrue(&quot;bib should be known in context1&quot;, testCon.hasStatement(null, name, nameBob, false, context1));</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testAddInputStream() throws Exception {
&nbsp;		// add file default-graph.ttl to repository, no context
<b class="nc">&nbsp;		try (InputStream defaultGraph = RepositoryConnectionTest.class</b>
<b class="nc">&nbsp;				.getResourceAsStream(TEST_DIR_PREFIX + &quot;default-graph.ttl&quot;)) {</b>
<b class="nc">&nbsp;			testCon.add(defaultGraph, &quot;&quot;, RDFFormat.TURTLE);</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		assertTrue(NEWLY_ADDED, testCon.hasStatement(null, publisher, nameBob, false));</b>
<b class="nc">&nbsp;		assertTrue(NEWLY_ADDED, testCon.hasStatement(null, publisher, nameAlice, false));</b>
&nbsp;
&nbsp;		// add file graph1.ttl to context1
<b class="nc">&nbsp;		try (InputStream graph1 = RepositoryConnectionTest.class.getResourceAsStream(TEST_DIR_PREFIX + &quot;graph1.ttl&quot;)) {</b>
<b class="nc">&nbsp;			testCon.add(graph1, &quot;&quot;, RDFFormat.TURTLE, context1);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
&nbsp;		// add file graph2.ttl to context2
<b class="nc">&nbsp;		try (InputStream graph2 = RepositoryConnectionTest.class.getResourceAsStream(TEST_DIR_PREFIX + &quot;graph2.ttl&quot;)) {</b>
<b class="nc">&nbsp;			testCon.add(graph2, &quot;&quot;, RDFFormat.TURTLE, context2);</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		assertTrue(&quot;alice should be known in the store&quot;, testCon.hasStatement(null, name, nameAlice, false));</b>
<b class="nc">&nbsp;		assertFalse(&quot;alice should not be known in context1&quot;,</b>
<b class="nc">&nbsp;				testCon.hasStatement(null, name, nameAlice, false, context1));</b>
<b class="nc">&nbsp;		assertTrue(&quot;alice should be known in context2&quot;, testCon.hasStatement(null, name, nameAlice, false, context2));</b>
<b class="nc">&nbsp;		assertTrue(&quot;bob should be known in the store&quot;, testCon.hasStatement(null, name, nameBob, false));</b>
<b class="nc">&nbsp;		assertFalse(&quot;bob should not be known in context2&quot;, testCon.hasStatement(null, name, nameBob, false, context2));</b>
<b class="nc">&nbsp;		assertTrue(&quot;bib should be known in context1&quot;, testCon.hasStatement(null, name, nameBob, false, context1));</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testAddInputStreamInTxn() throws Exception {
&nbsp;		// add file default-graph.ttl to repository, no context
<b class="nc">&nbsp;		try (InputStream defaultGraph = RepositoryConnectionTest.class</b>
<b class="nc">&nbsp;				.getResourceAsStream(TEST_DIR_PREFIX + &quot;default-graph.ttl&quot;)) {</b>
<b class="nc">&nbsp;			testCon.begin();</b>
<b class="nc">&nbsp;			testCon.add(defaultGraph, &quot;&quot;, RDFFormat.TURTLE);</b>
<b class="nc">&nbsp;			testCon.commit();</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		assertTrue(NEWLY_ADDED, testCon.hasStatement(null, publisher, nameBob, false));</b>
<b class="nc">&nbsp;		assertTrue(NEWLY_ADDED, testCon.hasStatement(null, publisher, nameAlice, false));</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testAddReaderInTxn() throws Exception {
&nbsp;		// add file default-graph.ttl to repository, no context
&nbsp;
<b class="nc">&nbsp;		try (InputStream defaultGraph = RepositoryConnectionTest.class</b>
<b class="nc">&nbsp;				.getResourceAsStream(TEST_DIR_PREFIX + &quot;default-graph.ttl&quot;);</b>
<b class="nc">&nbsp;				InputStreamReader reader = new InputStreamReader(defaultGraph)) {</b>
<b class="nc">&nbsp;			testCon.begin();</b>
<b class="nc">&nbsp;			testCon.add(reader, &quot;&quot;, RDFFormat.TURTLE);</b>
<b class="nc">&nbsp;			testCon.commit();</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		assertTrue(NEWLY_ADDED, testCon.hasStatement(null, publisher, nameBob, false));</b>
<b class="nc">&nbsp;		assertTrue(NEWLY_ADDED, testCon.hasStatement(null, publisher, nameAlice, false));</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testAddGzipInputStream() throws Exception {
&nbsp;		// add file default-graph.ttl to repository, no context
<b class="nc">&nbsp;		try (InputStream defaultGraph = RepositoryConnectionTest.class</b>
<b class="nc">&nbsp;				.getResourceAsStream(TEST_DIR_PREFIX + &quot;default-graph.ttl.gz&quot;)) {</b>
<b class="nc">&nbsp;			testCon.add(defaultGraph, &quot;&quot;, RDFFormat.TURTLE);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
<b class="nc">&nbsp;		assertTrue(NEWLY_ADDED, testCon.hasStatement(null, publisher, nameBob, false));</b>
<b class="nc">&nbsp;		assertTrue(NEWLY_ADDED, testCon.hasStatement(null, publisher, nameAlice, false));</b>
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testAddZipFile() throws Exception {
<b class="nc">&nbsp;		testCon.add(RepositoryConnectionTest.class.getResourceAsStream(TEST_DIR_PREFIX + &quot;graphs.zip&quot;), &quot;&quot;,</b>
&nbsp;				RDFFormat.TURTLE);
<b class="nc">&nbsp;		assertTrue(NEWLY_ADDED, testCon.hasStatement(null, publisher, nameBob, false));</b>
<b class="nc">&nbsp;		assertTrue(NEWLY_ADDED, testCon.hasStatement(null, publisher, nameAlice, false));</b>
<b class="nc">&nbsp;		assertTrue(&quot;alice should be known in the store&quot;, testCon.hasStatement(null, name, nameAlice, false));</b>
<b class="nc">&nbsp;		assertTrue(&quot;bob should be known in the store&quot;, testCon.hasStatement(null, name, nameBob, false));</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testAddMalformedLiteralsDefaultConfig() throws Exception {
&nbsp;		try {
<b class="nc">&nbsp;			testCon.add(RepositoryConnectionTest.class.getResourceAsStream(TEST_DIR_PREFIX + &quot;malformed-literals.ttl&quot;),</b>
&nbsp;					&quot;&quot;, RDFFormat.TURTLE);
<b class="nc">&nbsp;			fail(&quot;upload of malformed literals should fail with error in default configuration&quot;);</b>
<b class="nc">&nbsp;		} catch (RDFParseException e) {</b>
&nbsp;			// ignore, as expected
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testAddMalformedLiteralsStrictConfig() throws Exception {
<b class="nc">&nbsp;		Set&lt;RioSetting&lt;?&gt;&gt; empty = Collections.emptySet();</b>
<b class="nc">&nbsp;		testCon.getParserConfig().setNonFatalErrors(empty);</b>
&nbsp;
&nbsp;		try {
<b class="nc">&nbsp;			testCon.add(RepositoryConnectionTest.class.getResourceAsStream(TEST_DIR_PREFIX + &quot;malformed-literals.ttl&quot;),</b>
&nbsp;					&quot;&quot;, RDFFormat.TURTLE);
<b class="nc">&nbsp;			fail(&quot;upload of malformed literals should fail with error in strict configuration&quot;);</b>
&nbsp;
<b class="nc">&nbsp;		} catch (RDFParseException e) {</b>
&nbsp;			// ingnore, as expected.
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testAutoCommit() throws Exception {
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.add(alice, name, nameAlice);</b>
&nbsp;
<b class="nc">&nbsp;		assertTrue(&quot;Uncommitted update should be visible to own connection&quot;,</b>
<b class="nc">&nbsp;				testCon.hasStatement(alice, name, nameAlice, false));</b>
&nbsp;
<b class="nc">&nbsp;		testCon.commit();</b>
&nbsp;
<b class="nc">&nbsp;		assertTrue(&quot;Repository should contain statement after commit&quot;,</b>
<b class="nc">&nbsp;				testCon.hasStatement(alice, name, nameAlice, false));</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testRollback() throws Exception {
<b class="nc">&nbsp;		if (IsolationLevels.NONE.isCompatibleWith(level)) {</b>
&nbsp;			return;
&nbsp;		}
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.add(alice, name, nameAlice);</b>
&nbsp;
<b class="nc">&nbsp;		assertTrue(&quot;Uncommitted updates should be visible to own connection&quot;,</b>
<b class="nc">&nbsp;				testCon.hasStatement(alice, name, nameAlice, false));</b>
&nbsp;
<b class="nc">&nbsp;		testCon.rollback();</b>
&nbsp;
<b class="nc">&nbsp;		assertFalse(&quot;Repository should not contain statement after rollback&quot;,</b>
<b class="nc">&nbsp;				testCon.hasStatement(alice, name, nameAlice, false));</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testSimpleTupleQuery() throws Exception {
<b class="nc">&nbsp;		testCon.add(alice, name, nameAlice, context2);</b>
<b class="nc">&nbsp;		testCon.add(alice, mbox, mboxAlice, context2);</b>
<b class="nc">&nbsp;		testCon.add(context2, publisher, nameAlice);</b>
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob, context1);</b>
<b class="nc">&nbsp;		testCon.add(bob, mbox, mboxBob, context1);</b>
<b class="nc">&nbsp;		testCon.add(context1, publisher, nameBob);</b>
<b class="nc">&nbsp;		StringBuilder queryBuilder = new StringBuilder(128);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; PREFIX foaf: &lt;&quot; + FOAF_NS + &quot;&gt; \n&quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; SELECT ?name ?mbox&quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; WHERE { [] foaf:name ?name;&quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot;            foaf:mbox ?mbox. }&quot;);</b>
&nbsp;
<b class="nc">&nbsp;		try (TupleQueryResult result = testCon.prepareTupleQuery(queryBuilder.toString()).evaluate()) {</b>
<b class="nc">&nbsp;			assertThat(result).isNotNull();</b>
<b class="nc">&nbsp;			assertThat(result.hasNext()).isTrue();</b>
<b class="nc">&nbsp;			while (result.hasNext()) {</b>
<b class="nc">&nbsp;				BindingSet solution = result.next();</b>
<b class="nc">&nbsp;				assertThat(solution.hasBinding(NAME)).isTrue();</b>
<b class="nc">&nbsp;				assertThat(solution.hasBinding(MBOX)).isTrue();</b>
<b class="nc">&nbsp;				Value nameResult = solution.getValue(NAME);</b>
<b class="nc">&nbsp;				Value mboxResult = solution.getValue(MBOX);</b>
<b class="nc">&nbsp;				assertThat(nameResult).isIn(nameAlice, nameBob);</b>
<b class="nc">&nbsp;				assertThat(mboxResult).isIn(mboxAlice, mboxBob);</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testPrepareSPARQLQuery() throws Exception {
&nbsp;
<b class="nc">&nbsp;		StringBuilder queryBuilder = new StringBuilder();</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; PREFIX foaf: &lt;&quot; + FOAF_NS + &quot;&gt;&quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; SELECT ?person&quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; WHERE { ?person foaf:name ?y . }&quot;);</b>
&nbsp;
&nbsp;		try {
<b class="nc">&nbsp;			testCon.prepareQuery(QueryLanguage.SPARQL, queryBuilder.toString());</b>
<b class="nc">&nbsp;		} catch (UnsupportedOperationException e) {</b>
<b class="nc">&nbsp;			fail(UNSUPPORTED_OP + e.getMessage());</b>
<b class="nc">&nbsp;		} catch (ClassCastException e) {</b>
<b class="nc">&nbsp;			fail(UNEXPECTED_TYPE + e.getMessage());</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
<b class="nc">&nbsp;		queryBuilder = new StringBuilder();</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; BASE &lt;http://base.uri&gt;&quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; PREFIX foaf: &lt;&quot; + FOAF_NS + &quot;&gt;&quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; PREFIX ex: &lt;http://example.org/&gt;&quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; PREFIX : &lt;http://example.org/foo#&gt;&quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; SELECT ?person&quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; WHERE { ?person foaf:name ?y . }&quot;);</b>
&nbsp;
&nbsp;		try {
<b class="nc">&nbsp;			testCon.prepareQuery(QueryLanguage.SPARQL, queryBuilder.toString());</b>
<b class="nc">&nbsp;		} catch (UnsupportedOperationException e) {</b>
<b class="nc">&nbsp;			fail(UNSUPPORTED_OP + e.getMessage());</b>
<b class="nc">&nbsp;		} catch (ClassCastException e) {</b>
<b class="nc">&nbsp;			fail(UNEXPECTED_TYPE + e.getMessage());</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testSimpleTupleQueryUnicode() throws Exception {
<b class="nc">&nbsp;		testCon.add(alexander, name, Александър);</b>
<b class="nc">&nbsp;		StringBuilder queryBuilder = new StringBuilder(128);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; PREFIX foaf: &lt;&quot; + FOAF_NS + &quot;&gt; \n&quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; SELECT ?person&quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; WHERE { ?person foaf:name \&quot;&quot;).append(Александър.getLabel()).append(&quot;\&quot;. }&quot;);</b>
&nbsp;
<b class="nc">&nbsp;		try (TupleQueryResult result = testCon.prepareTupleQuery(queryBuilder.toString()).evaluate()) {</b>
<b class="nc">&nbsp;			assertThat(result).isNotNull();</b>
<b class="nc">&nbsp;			assertThat(result.hasNext()).isTrue();</b>
<b class="nc">&nbsp;			while (result.hasNext()) {</b>
<b class="nc">&nbsp;				BindingSet solution = result.next();</b>
<b class="nc">&nbsp;				assertThat(solution.hasBinding(PERSON)).isTrue();</b>
<b class="nc">&nbsp;				assertThat(solution.getValue(PERSON)).isEqualTo(alexander);</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testPreparedTupleQuery() throws Exception {
<b class="nc">&nbsp;		testCon.add(alice, name, nameAlice, context2);</b>
<b class="nc">&nbsp;		testCon.add(alice, mbox, mboxAlice, context2);</b>
<b class="nc">&nbsp;		testCon.add(context2, publisher, nameAlice);</b>
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob, context1);</b>
<b class="nc">&nbsp;		testCon.add(bob, mbox, mboxBob, context1);</b>
<b class="nc">&nbsp;		testCon.add(context1, publisher, nameBob);</b>
<b class="nc">&nbsp;		StringBuilder queryBuilder = new StringBuilder();</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; PREFIX foaf: &lt;&quot; + FOAF_NS + &quot;&gt; \n&quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; SELECT ?name ?mbox \n&quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; WHERE { [] foaf:name ?name; \n&quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot;            foaf:mbox ?mbox . }&quot;);</b>
<b class="nc">&nbsp;		TupleQuery query = testCon.prepareTupleQuery(queryBuilder.toString());</b>
<b class="nc">&nbsp;		query.setBinding(NAME, nameBob);</b>
&nbsp;
<b class="nc">&nbsp;		try (TupleQueryResult result = query.evaluate()) {</b>
<b class="nc">&nbsp;			assertThat(result).isNotNull();</b>
<b class="nc">&nbsp;			assertThat(result.hasNext()).isTrue();</b>
<b class="nc">&nbsp;			while (result.hasNext()) {</b>
<b class="nc">&nbsp;				BindingSet solution = result.next();</b>
<b class="nc">&nbsp;				assertThat(solution.hasBinding(NAME)).isTrue();</b>
<b class="nc">&nbsp;				assertThat(solution.hasBinding(MBOX)).isTrue();</b>
<b class="nc">&nbsp;				Value nameResult = solution.getValue(NAME);</b>
<b class="nc">&nbsp;				Value mboxResult = solution.getValue(MBOX);</b>
<b class="nc">&nbsp;				assertEquals(&quot;unexpected value for name: &quot; + nameResult, nameBob, nameResult);</b>
<b class="nc">&nbsp;				assertEquals(&quot;unexpected value for mbox: &quot; + mboxResult, mboxBob, mboxResult);</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testPreparedTupleQueryUnicode() throws Exception {
<b class="nc">&nbsp;		testCon.add(alexander, name, Александър);</b>
&nbsp;
<b class="nc">&nbsp;		StringBuilder queryBuilder = new StringBuilder();</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; PREFIX foaf: &lt;&quot; + FOAF_NS + &quot;&gt; \n&quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; SELECT ?person \n&quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; WHERE { ?person foaf:name ?name . }&quot;);</b>
&nbsp;
<b class="nc">&nbsp;		TupleQuery query = testCon.prepareTupleQuery(queryBuilder.toString());</b>
<b class="nc">&nbsp;		query.setBinding(NAME, Александър);</b>
&nbsp;
<b class="nc">&nbsp;		try (TupleQueryResult result = query.evaluate()) {</b>
<b class="nc">&nbsp;			assertThat(result).isNotNull();</b>
<b class="nc">&nbsp;			assertThat(result.hasNext()).isTrue();</b>
&nbsp;
<b class="nc">&nbsp;			while (result.hasNext()) {</b>
<b class="nc">&nbsp;				BindingSet solution = result.next();</b>
<b class="nc">&nbsp;				assertThat(solution.hasBinding(PERSON)).isTrue();</b>
<b class="nc">&nbsp;				assertThat(solution.getValue(PERSON)).isEqualTo(alexander);</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testSimpleGraphQuery() throws Exception {
<b class="nc">&nbsp;		testCon.add(alice, name, nameAlice, context2);</b>
<b class="nc">&nbsp;		testCon.add(alice, mbox, mboxAlice, context2);</b>
<b class="nc">&nbsp;		testCon.add(context2, publisher, nameAlice);</b>
&nbsp;
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob, context1);</b>
<b class="nc">&nbsp;		testCon.add(bob, mbox, mboxBob, context1);</b>
<b class="nc">&nbsp;		testCon.add(context1, publisher, nameBob);</b>
&nbsp;
<b class="nc">&nbsp;		StringBuilder queryBuilder = new StringBuilder(128);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; PREFIX foaf: &lt;&quot; + FOAF_NS + &quot;&gt; \n&quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; CONSTRUCT\n&quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; WHERE { [] foaf:name ?name;\n&quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot;            foaf:mbox ?mbox.}&quot;);</b>
&nbsp;
<b class="nc">&nbsp;		try (GraphQueryResult result = testCon.prepareGraphQuery(queryBuilder.toString()).evaluate()) {</b>
<b class="nc">&nbsp;			assertThat(result).isNotNull();</b>
<b class="nc">&nbsp;			assertThat(result.hasNext()).isTrue();</b>
&nbsp;
<b class="nc">&nbsp;			while (result.hasNext()) {</b>
<b class="nc">&nbsp;				Statement st = result.next();</b>
<b class="nc">&nbsp;				if (name.equals(st.getPredicate())) {</b>
<b class="nc">&nbsp;					assertThat(st.getObject()).isIn(nameAlice, nameBob);</b>
&nbsp;				} else {
<b class="nc">&nbsp;					assertThat(st.getPredicate()).isEqualTo(mbox);</b>
<b class="nc">&nbsp;					assertThat(st.getObject()).isIn(mboxAlice, mboxBob);</b>
&nbsp;				}
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testPreparedGraphQuery() throws Exception {
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.add(alice, name, nameAlice, context2);</b>
<b class="nc">&nbsp;		testCon.add(alice, mbox, mboxAlice, context2);</b>
<b class="nc">&nbsp;		testCon.add(context2, publisher, nameAlice);</b>
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob, context1);</b>
<b class="nc">&nbsp;		testCon.add(bob, mbox, mboxBob, context1);</b>
<b class="nc">&nbsp;		testCon.add(context1, publisher, nameBob);</b>
<b class="nc">&nbsp;		testCon.commit();</b>
<b class="nc">&nbsp;		StringBuilder queryBuilder = new StringBuilder(128);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; PREFIX foaf: &lt;&quot; + FOAF_NS + &quot;&gt; \n&quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; CONSTRUCT\n&quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot; WHERE { [] foaf:name ?name;\n&quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot;            foaf:mbox ?mbox.}&quot;);</b>
<b class="nc">&nbsp;		GraphQuery query = testCon.prepareGraphQuery(queryBuilder.toString());</b>
<b class="nc">&nbsp;		query.setBinding(NAME, nameBob);</b>
&nbsp;
<b class="nc">&nbsp;		try (GraphQueryResult result = query.evaluate()) {</b>
<b class="nc">&nbsp;			assertThat(result).isNotNull();</b>
<b class="nc">&nbsp;			assertThat(result.hasNext()).isTrue();</b>
<b class="nc">&nbsp;			while (result.hasNext()) {</b>
<b class="nc">&nbsp;				Statement st = result.next();</b>
<b class="nc">&nbsp;				IRI predicate = st.getPredicate();</b>
<b class="nc">&nbsp;				assertThat(predicate).isIn(name, mbox);</b>
<b class="nc">&nbsp;				Value object = st.getObject();</b>
<b class="nc">&nbsp;				if (name.equals(predicate)) {</b>
<b class="nc">&nbsp;					assertEquals(&quot;unexpected value for name: &quot; + object, nameBob, object);</b>
&nbsp;				} else {
<b class="nc">&nbsp;					assertThat(predicate).isEqualTo(mbox);</b>
<b class="nc">&nbsp;					assertEquals(&quot;unexpected value for mbox: &quot; + object, mboxBob, object);</b>
&nbsp;				}
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testSimpleBooleanQuery() throws Exception {
<b class="nc">&nbsp;		testCon.add(alice, name, nameAlice, context2);</b>
<b class="nc">&nbsp;		testCon.add(alice, mbox, mboxAlice, context2);</b>
<b class="nc">&nbsp;		testCon.add(context2, publisher, nameAlice);</b>
&nbsp;
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob, context1);</b>
<b class="nc">&nbsp;		testCon.add(bob, mbox, mboxBob, context1);</b>
<b class="nc">&nbsp;		testCon.add(context1, publisher, nameBob);</b>
&nbsp;
<b class="nc">&nbsp;		StringBuilder queryBuilder = new StringBuilder(64);</b>
<b class="nc">&nbsp;		queryBuilder.append(PREFIX_FOAF + FOAF_NS + &quot;&gt; &quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(ASK);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot;{ ?p foaf:name ?name }&quot;);</b>
&nbsp;
<b class="nc">&nbsp;		boolean exists = testCon.prepareBooleanQuery(QueryLanguage.SPARQL, queryBuilder.toString()).evaluate();</b>
&nbsp;
<b class="nc">&nbsp;		assertThat(exists).isTrue();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testPreparedBooleanQuery() throws Exception {
<b class="nc">&nbsp;		testCon.add(alice, name, nameAlice, context2);</b>
<b class="nc">&nbsp;		testCon.add(alice, mbox, mboxAlice, context2);</b>
<b class="nc">&nbsp;		testCon.add(context2, publisher, nameAlice);</b>
&nbsp;
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob, context1);</b>
<b class="nc">&nbsp;		testCon.add(bob, mbox, mboxBob, context1);</b>
<b class="nc">&nbsp;		testCon.add(context1, publisher, nameBob);</b>
&nbsp;
<b class="nc">&nbsp;		StringBuilder queryBuilder = new StringBuilder();</b>
<b class="nc">&nbsp;		queryBuilder.append(PREFIX_FOAF + FOAF_NS + &quot;&gt; &quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(ASK);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot;{ ?p foaf:name ?name }&quot;);</b>
&nbsp;
<b class="nc">&nbsp;		BooleanQuery query = testCon.prepareBooleanQuery(QueryLanguage.SPARQL, queryBuilder.toString());</b>
<b class="nc">&nbsp;		query.setBinding(NAME, nameBob);</b>
&nbsp;
<b class="nc">&nbsp;		assertThat(query.evaluate()).isTrue();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testDataset() throws Exception {
<b class="nc">&nbsp;		testCon.add(alice, name, nameAlice, context2);</b>
<b class="nc">&nbsp;		testCon.add(alice, mbox, mboxAlice, context2);</b>
<b class="nc">&nbsp;		testCon.add(context2, publisher, nameAlice);</b>
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob, context1);</b>
<b class="nc">&nbsp;		testCon.add(bob, mbox, mboxBob, context1);</b>
<b class="nc">&nbsp;		testCon.add(context1, publisher, nameBob);</b>
<b class="nc">&nbsp;		StringBuilder queryBuilder = new StringBuilder();</b>
<b class="nc">&nbsp;		queryBuilder.append(PREFIX_FOAF + FOAF_NS + &quot;&gt; &quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(ASK);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot;{ ?p foaf:name ?name }&quot;);</b>
<b class="nc">&nbsp;		BooleanQuery query = testCon.prepareBooleanQuery(QueryLanguage.SPARQL, queryBuilder.toString());</b>
<b class="nc">&nbsp;		query.setBinding(NAME, nameBob);</b>
<b class="nc">&nbsp;		assertThat(query.evaluate()).isTrue();</b>
<b class="nc">&nbsp;		SimpleDataset dataset = new SimpleDataset();</b>
&nbsp;
&nbsp;		// default graph: {context1}
<b class="nc">&nbsp;		dataset.addDefaultGraph(context1);</b>
<b class="nc">&nbsp;		query.setDataset(dataset);</b>
<b class="nc">&nbsp;		assertThat(query.evaluate()).isTrue();</b>
&nbsp;
&nbsp;		// default graph: {context1, context2}
<b class="nc">&nbsp;		dataset.addDefaultGraph(context2);</b>
<b class="nc">&nbsp;		query.setDataset(dataset);</b>
<b class="nc">&nbsp;		assertThat(query.evaluate()).isTrue();</b>
&nbsp;
&nbsp;		// default graph: {context2}
<b class="nc">&nbsp;		dataset.removeDefaultGraph(context1);</b>
<b class="nc">&nbsp;		query.setDataset(dataset);</b>
<b class="nc">&nbsp;		assertThat(query.evaluate()).isFalse();</b>
<b class="nc">&nbsp;		queryBuilder.setLength(0);</b>
<b class="nc">&nbsp;		queryBuilder.append(PREFIX_FOAF + FOAF_NS + &quot;&gt; &quot;);</b>
<b class="nc">&nbsp;		queryBuilder.append(ASK);</b>
<b class="nc">&nbsp;		queryBuilder.append(&quot;{ GRAPH ?g { ?p foaf:name ?name } }&quot;);</b>
<b class="nc">&nbsp;		query = testCon.prepareBooleanQuery(QueryLanguage.SPARQL, queryBuilder.toString());</b>
<b class="nc">&nbsp;		query.setBinding(NAME, nameBob);</b>
&nbsp;
&nbsp;		// default graph: {context2}; named graph: {}
<b class="nc">&nbsp;		query.setDataset(dataset);</b>
<b class="nc">&nbsp;		assertThat(query.evaluate()).isFalse();</b>
&nbsp;
&nbsp;		// default graph: {context1, context2}; named graph: {context2}
<b class="nc">&nbsp;		dataset.addDefaultGraph(context1);</b>
<b class="nc">&nbsp;		dataset.addNamedGraph(context2);</b>
<b class="nc">&nbsp;		query.setDataset(dataset);</b>
<b class="nc">&nbsp;		assertThat(query.evaluate()).isFalse();</b>
&nbsp;
&nbsp;		// default graph: {context1, context2}; named graph: {context1,
&nbsp;		// context2}
<b class="nc">&nbsp;		dataset.addNamedGraph(context1);</b>
<b class="nc">&nbsp;		query.setDataset(dataset);</b>
<b class="nc">&nbsp;		assertThat(query.evaluate()).isTrue();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testGetStatements() throws Exception {
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob);</b>
&nbsp;
<b class="nc">&nbsp;		assertTrue(&quot;Repository should contain statement&quot;, testCon.hasStatement(bob, name, nameBob, false));</b>
&nbsp;
<b class="nc">&nbsp;		try (RepositoryResult&lt;Statement&gt; result = testCon.getStatements(null, name, null, false)) {</b>
<b class="nc">&nbsp;			assertNotNull(&quot;Iterator should not be null&quot;, result);</b>
<b class="nc">&nbsp;			assertTrue(&quot;Iterator should not be empty&quot;, result.hasNext());</b>
&nbsp;
<b class="nc">&nbsp;			while (result.hasNext()) {</b>
<b class="nc">&nbsp;				Statement st = result.next();</b>
<b class="nc">&nbsp;				assertNull(&quot;Statement should not be in a context &quot;, st.getContext());</b>
<b class="nc">&nbsp;				assertTrue(&quot;Statement predicate should be equal to name &quot;, st.getPredicate().equals(name));</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
<b class="nc">&nbsp;		List&lt;Statement&gt; list = Iterations.addAll(testCon.getStatements(null, name, null, false), new ArrayList&lt;&gt;());</b>
&nbsp;
<b class="nc">&nbsp;		assertNotNull(&quot;List should not be null&quot;, list);</b>
<b class="nc">&nbsp;		assertFalse(&quot;List should not be empty&quot;, list.isEmpty());</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testGetStatementsIterable() throws Exception {
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob);</b>
&nbsp;
<b class="nc">&nbsp;		assertTrue(&quot;Repository should contain statement&quot;, testCon.hasStatement(bob, name, nameBob, false));</b>
&nbsp;
<b class="nc">&nbsp;		try (RepositoryResult&lt;Statement&gt; result = testCon.getStatements(null, name, null, false)) {</b>
<b class="nc">&nbsp;			assertThat(result).isNotNull();</b>
<b class="nc">&nbsp;			assertThat(result).isNotEmpty();</b>
&nbsp;
<b class="nc">&nbsp;			for (Statement st : result) {</b>
<b class="nc">&nbsp;				assertThat(st.getContext()).isNull();</b>
<b class="nc">&nbsp;				assertThat(st.getPredicate()).isEqualTo(name);</b>
<b class="nc">&nbsp;			}</b>
&nbsp;
<b class="nc">&nbsp;			assertThat(result).isEmpty();</b>
<b class="nc">&nbsp;			assertThat(result.isClosed()).isTrue();</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testGetStatementsMalformedTypedLiteral() throws Exception {
<b class="nc">&nbsp;		Literal invalidIntegerLiteral = vf.createLiteral(&quot;the number four&quot;, XSD.INTEGER);</b>
&nbsp;		try {
<b class="nc">&nbsp;			IRI pred = vf.createIRI(URN_PRED);</b>
<b class="nc">&nbsp;			testCon.add(bob, pred, invalidIntegerLiteral);</b>
&nbsp;
<b class="nc">&nbsp;			try (RepositoryResult&lt;Statement&gt; statements = testCon.getStatements(bob, pred, null, true)) {</b>
<b class="nc">&nbsp;				assertNotNull(statements);</b>
<b class="nc">&nbsp;				assertTrue(statements.hasNext());</b>
<b class="nc">&nbsp;				Statement st = statements.next();</b>
<b class="nc">&nbsp;				assertTrue(st.getObject() instanceof Literal);</b>
<b class="nc">&nbsp;				assertTrue(st.getObject().equals(invalidIntegerLiteral));</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;		} catch (RepositoryException e) {</b>
&nbsp;			// shouldn&#39;t happen
<b class="nc">&nbsp;			fail(e.getMessage());</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testGetStatementsMalformedLanguageLiteral() throws Exception {
<b class="nc">&nbsp;		Literal invalidLanguageLiteral = vf.createLiteral(&quot;the number four&quot;, &quot;en_us&quot;);</b>
&nbsp;		try {
<b class="nc">&nbsp;			IRI pred = vf.createIRI(URN_PRED);</b>
<b class="nc">&nbsp;			testCon.add(bob, pred, invalidLanguageLiteral);</b>
&nbsp;
<b class="nc">&nbsp;			try (RepositoryResult&lt;Statement&gt; statements = testCon.getStatements(bob, pred, null, true)) {</b>
<b class="nc">&nbsp;				assertNotNull(statements);</b>
<b class="nc">&nbsp;				assertTrue(statements.hasNext());</b>
<b class="nc">&nbsp;				Statement st = statements.next();</b>
<b class="nc">&nbsp;				assertTrue(st.getObject() instanceof Literal);</b>
<b class="nc">&nbsp;				assertTrue(st.getObject().equals(invalidLanguageLiteral));</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;		} catch (RepositoryException e) {</b>
<b class="nc">&nbsp;			e.printStackTrace();</b>
&nbsp;			// shouldn&#39;t happen
<b class="nc">&nbsp;			fail(e.getMessage());</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testGetStatementsInSingleContext() throws Exception {
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob, context1);</b>
<b class="nc">&nbsp;		testCon.add(bob, mbox, mboxBob, context1);</b>
<b class="nc">&nbsp;		testCon.add(context1, publisher, nameBob);</b>
<b class="nc">&nbsp;		testCon.add(alice, name, nameAlice, context2);</b>
<b class="nc">&nbsp;		testCon.add(alice, mbox, mboxAlice, context2);</b>
<b class="nc">&nbsp;		testCon.add(context2, publisher, nameAlice);</b>
<b class="nc">&nbsp;		testCon.commit();</b>
<b class="nc">&nbsp;		assertTrue(&quot;Repository should contain statement&quot;, testCon.hasStatement(bob, name, nameBob, false));</b>
<b class="nc">&nbsp;		assertTrue(&quot;Repository should contain statement in context1&quot;,</b>
<b class="nc">&nbsp;				testCon.hasStatement(bob, name, nameBob, false, context1));</b>
<b class="nc">&nbsp;		assertFalse(&quot;Repository should not contain statement in context2&quot;,</b>
<b class="nc">&nbsp;				testCon.hasStatement(bob, name, nameBob, false, context2));</b>
&nbsp;
&nbsp;		// Check handling of getStatements without context IDs
<b class="nc">&nbsp;		try (RepositoryResult&lt;Statement&gt; result = testCon.getStatements(bob, name, null, false)) {</b>
<b class="nc">&nbsp;			while (result.hasNext()) {</b>
<b class="nc">&nbsp;				Statement st = result.next();</b>
<b class="nc">&nbsp;				assertThat(st.getSubject()).isEqualTo(bob);</b>
<b class="nc">&nbsp;				assertThat(st.getPredicate()).isEqualTo(name);</b>
<b class="nc">&nbsp;				assertThat(st.getObject()).isEqualTo(nameBob);</b>
<b class="nc">&nbsp;				assertThat(st.getContext()).isEqualTo(context1);</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
&nbsp;		// Check handling of getStatements with a known context ID
<b class="nc">&nbsp;		try (RepositoryResult&lt;Statement&gt; result = testCon.getStatements(null, null, null, false, context1)) {</b>
<b class="nc">&nbsp;			while (result.hasNext()) {</b>
<b class="nc">&nbsp;				Statement st = result.next();</b>
<b class="nc">&nbsp;				assertThat(st.getContext()).isEqualTo(context1);</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
&nbsp;		// Check handling of getStatements with an unknown context ID
<b class="nc">&nbsp;		try (RepositoryResult&lt;Statement&gt; result = testCon.getStatements(null, null, null, false, unknownContext)) {</b>
<b class="nc">&nbsp;			assertThat(result).isNotNull();</b>
<b class="nc">&nbsp;			assertThat(result.hasNext()).isFalse();</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
<b class="nc">&nbsp;		try (RepositoryResult&lt;Statement&gt; result = testCon.getStatements(null, name, null, false, context1)) {</b>
<b class="nc">&nbsp;			List&lt;Statement&gt; list = Iterations.addAll(result, new ArrayList&lt;&gt;());</b>
<b class="nc">&nbsp;			assertNotNull(&quot;List should not be null&quot;, list);</b>
<b class="nc">&nbsp;			assertFalse(&quot;List should not be empty&quot;, list.isEmpty());</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testGetStatementsInMultipleContexts() throws Exception {
<b class="nc">&nbsp;		testCon.clear();</b>
&nbsp;
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.add(alice, name, nameAlice, context2);</b>
<b class="nc">&nbsp;		testCon.add(alice, mbox, mboxAlice, context2);</b>
<b class="nc">&nbsp;		testCon.add(context2, publisher, nameAlice);</b>
<b class="nc">&nbsp;		testCon.commit();</b>
&nbsp;
&nbsp;		// get statements with either no context or context2
<b class="nc">&nbsp;		try (RepositoryResult&lt;Statement&gt; iter = testCon.getStatements(null, null, null, false, null, context2)) {</b>
<b class="nc">&nbsp;			int count = 0;</b>
<b class="nc">&nbsp;			while (iter.hasNext()) {</b>
<b class="nc">&nbsp;				count++;</b>
<b class="nc">&nbsp;				Statement st = iter.next();</b>
<b class="nc">&nbsp;				assertThat(st.getContext()).isIn(null, context2);</b>
<b class="nc">&nbsp;			}</b>
&nbsp;
<b class="nc">&nbsp;			assertEquals(&quot;there should be three statements&quot;, 3, count);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
&nbsp;		// get all statements with context1 or context2. Note that context1 and
&nbsp;		// context2 are both known
&nbsp;		// in the store because they have been created through the store&#39;s own
&nbsp;		// value vf.
<b class="nc">&nbsp;		try (RepositoryResult&lt;Statement&gt; iter = testCon.getStatements(null, null, null, false, context1, context2)) {</b>
<b class="nc">&nbsp;			int count = 0;</b>
<b class="nc">&nbsp;			while (iter.hasNext()) {</b>
<b class="nc">&nbsp;				count++;</b>
<b class="nc">&nbsp;				Statement st = iter.next();</b>
&nbsp;				// we should have _only_ statements from context2
<b class="nc">&nbsp;				assertThat(st.getContext()).isEqualTo(context2);</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;			assertEquals(&quot;there should be two statements&quot;, 2, count);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
&nbsp;		// get all statements with unknownContext or context2.
<b class="nc">&nbsp;		try (RepositoryResult&lt;Statement&gt; iter = testCon.getStatements(null, null, null, false, unknownContext,</b>
&nbsp;				context2)) {
<b class="nc">&nbsp;			int count = 0;</b>
<b class="nc">&nbsp;			while (iter.hasNext()) {</b>
<b class="nc">&nbsp;				count++;</b>
<b class="nc">&nbsp;				Statement st = iter.next();</b>
&nbsp;				// we should have _only_ statements from context2
<b class="nc">&nbsp;				assertThat(st.getContext()).isEqualTo(context2);</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;			assertEquals(&quot;there should be two statements&quot;, 2, count);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
&nbsp;		// add statements to context1
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob, context1);</b>
<b class="nc">&nbsp;		testCon.add(bob, mbox, mboxBob, context1);</b>
<b class="nc">&nbsp;		testCon.add(context1, publisher, nameBob);</b>
<b class="nc">&nbsp;		testCon.commit();</b>
&nbsp;
<b class="nc">&nbsp;		try (RepositoryResult&lt;Statement&gt; iter = testCon.getStatements(null, null, null, false, context1)) {</b>
<b class="nc">&nbsp;			assertThat(iter).isNotNull();</b>
<b class="nc">&nbsp;			assertThat(iter.hasNext()).isTrue();</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
&nbsp;		// get statements with either no context or context2
<b class="nc">&nbsp;		try (RepositoryResult&lt;Statement&gt; iter = testCon.getStatements(null, null, null, false, null, context2)) {</b>
<b class="nc">&nbsp;			int count = 0;</b>
<b class="nc">&nbsp;			while (iter.hasNext()) {</b>
<b class="nc">&nbsp;				count++;</b>
<b class="nc">&nbsp;				Statement st = iter.next();</b>
&nbsp;				// we should have _only_ statements from context2, or without
&nbsp;				// context
<b class="nc">&nbsp;				assertThat(st.getContext()).isIn(null, context2);</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;			assertEquals(&quot;there should be four statements&quot;, 4, count);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
&nbsp;		// get all statements with context1 or context2
<b class="nc">&nbsp;		try (RepositoryResult&lt;Statement&gt; iter = testCon.getStatements(null, null, null, false, context1, context2)) {</b>
<b class="nc">&nbsp;			int count = 0;</b>
<b class="nc">&nbsp;			while (iter.hasNext()) {</b>
<b class="nc">&nbsp;				count++;</b>
<b class="nc">&nbsp;				Statement st = iter.next();</b>
<b class="nc">&nbsp;				assertThat(st.getContext()).isIn(context1, context2);</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;			assertEquals(&quot;there should be four statements&quot;, 4, count);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testDuplicateFilter() throws Exception {
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob);</b>
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob, context1);</b>
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob, context2);</b>
<b class="nc">&nbsp;		testCon.commit();</b>
&nbsp;
<b class="nc">&nbsp;		try (RepositoryResult&lt;Statement&gt; result = testCon.getStatements(bob, name, null, true)) {</b>
<b class="nc">&nbsp;			result.enableDuplicateFilter();</b>
<b class="nc">&nbsp;			int count = 0;</b>
<b class="nc">&nbsp;			while (result.hasNext()) {</b>
<b class="nc">&nbsp;				result.next();</b>
<b class="nc">&nbsp;				count++;</b>
&nbsp;			}
&nbsp;			// TODO now that statement.equals includes context, the above three statements are considered distinct.
&nbsp;			// This duplicate filter test has become meaningless since it is _expected_ that nothing gets filtered out.
&nbsp;			// We should look into reimplementing/renaming the enableDuplicateFilter to ignore context.
<b class="nc">&nbsp;			assertThat(count).isEqualTo(3);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testRemoveStatements() throws Exception {
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob);</b>
<b class="nc">&nbsp;		testCon.add(alice, name, nameAlice);</b>
<b class="nc">&nbsp;		testCon.commit();</b>
&nbsp;
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(bob, name, nameBob, false)).isTrue();</b>
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(alice, name, nameAlice, false)).isTrue();</b>
&nbsp;
<b class="nc">&nbsp;		testCon.remove(bob, name, nameBob);</b>
&nbsp;
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(bob, name, nameBob, false)).isFalse();</b>
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(alice, name, nameAlice, false)).isTrue();</b>
&nbsp;
<b class="nc">&nbsp;		testCon.remove(alice, null, null);</b>
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(alice, name, nameAlice, false)).isFalse();</b>
<b class="nc">&nbsp;		assertThat(testCon.isEmpty()).isTrue();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testRemoveStatementWithContext() throws Exception {
<b class="nc">&nbsp;		Statement statement = vf.createStatement(alice, name, nameAlice, context1);</b>
<b class="nc">&nbsp;		testCon.add(statement);</b>
&nbsp;
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(alice, name, nameAlice, false)).isTrue();</b>
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(alice, name, nameAlice, false, context1)).isTrue();</b>
&nbsp;
<b class="nc">&nbsp;		testCon.remove(alice, name, nameAlice, context1);</b>
&nbsp;
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(alice, name, nameAlice, false)).isFalse();</b>
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(alice, name, nameAlice, false, context1)).isFalse();</b>
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testRemoveStatementCollection() throws Exception {
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.add(alice, name, nameAlice);</b>
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob);</b>
<b class="nc">&nbsp;		testCon.commit();</b>
&nbsp;
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(bob, name, nameBob, false)).isTrue();</b>
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(alice, name, nameAlice, false)).isTrue();</b>
&nbsp;
<b class="nc">&nbsp;		try (RepositoryResult&lt;Statement&gt; result = testCon.getStatements(null, null, null, false)) {</b>
<b class="nc">&nbsp;			Collection&lt;Statement&gt; c = Iterations.addAll(result, new ArrayList&lt;&gt;());</b>
&nbsp;
<b class="nc">&nbsp;			testCon.remove(c);</b>
&nbsp;
<b class="nc">&nbsp;			assertThat(testCon.hasStatement(bob, name, nameBob, false)).isFalse();</b>
<b class="nc">&nbsp;			assertThat(testCon.hasStatement(alice, name, nameAlice, false)).isFalse();</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testRemoveStatementIteration() throws Exception {
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.add(alice, name, nameAlice);</b>
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob);</b>
<b class="nc">&nbsp;		testCon.commit();</b>
&nbsp;
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(bob, name, nameBob, false)).isTrue();</b>
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(alice, name, nameAlice, false)).isTrue();</b>
&nbsp;
<b class="nc">&nbsp;		try (CloseableIteration&lt;? extends Statement, RepositoryException&gt; iter = testCon.getStatements(null, null, null,</b>
&nbsp;				false)) {
<b class="nc">&nbsp;			testCon.remove(iter);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(bob, name, nameBob, false)).isFalse();</b>
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(alice, name, nameAlice, false)).isFalse();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testGetNamespace() throws Exception {
<b class="nc">&nbsp;		setupNamespaces();</b>
<b class="nc">&nbsp;		assertThat(testCon.getNamespace(EXAMPLE)).isEqualTo(EXAMPLE_NS);</b>
<b class="nc">&nbsp;		assertThat(testCon.getNamespace(RDFS_PREFIX)).isEqualTo(RDFS_NS);</b>
<b class="nc">&nbsp;		assertThat(testCon.getNamespace(RDF_PREFIX)).isEqualTo(&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;);</b>
<b class="nc">&nbsp;		assertThat(testCon.getNamespace(&quot;undefined&quot;)).isNull();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testGetNamespaces() throws Exception {
<b class="nc">&nbsp;		setupNamespaces();</b>
<b class="nc">&nbsp;		Map&lt;String, String&gt; map = Namespaces.asMap(Iterations.asSet(testCon.getNamespaces()));</b>
<b class="nc">&nbsp;		assertThat(map.size()).isEqualTo(3);</b>
<b class="nc">&nbsp;		assertThat(map.keySet()).contains(EXAMPLE, RDFS_PREFIX, RDF_PREFIX);</b>
<b class="nc">&nbsp;		assertThat(map.get(EXAMPLE)).isEqualTo(EXAMPLE_NS);</b>
<b class="nc">&nbsp;		assertThat(map.get(RDFS_PREFIX)).isEqualTo(RDFS_NS);</b>
<b class="nc">&nbsp;		assertThat(map.get(RDF_PREFIX)).isEqualTo(&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void setupNamespaces() throws IOException, RDFParseException, RepositoryException {
<b class="nc">&nbsp;		testCon.setNamespace(EXAMPLE, EXAMPLE_NS);</b>
<b class="nc">&nbsp;		testCon.setNamespace(RDF_PREFIX, &quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;);</b>
<b class="nc">&nbsp;		testCon.setNamespace(RDFS_PREFIX, RDFS_NS);</b>
&nbsp;
&nbsp;		// Translated from earlier RDF document. Is this line even necessary?
<b class="nc">&nbsp;		testCon.add(vf.createIRI(EXAMPLE_NS, &quot;Main&quot;), vf.createIRI(RDFS_NS, &quot;label&quot;), vf.createLiteral(&quot;Main Node&quot;));</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testClear() throws Exception {
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob);</b>
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(null, name, nameBob, false)).isTrue();</b>
<b class="nc">&nbsp;		testCon.clear();</b>
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(null, name, nameBob, false)).isFalse();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testRecoverFromParseError() throws RepositoryException, IOException {
<b class="nc">&nbsp;		String invalidData = &quot;bad&quot;;</b>
<b class="nc">&nbsp;		String validData = &quot;@prefix foo: &lt;http://example.org/foo#&gt;.\nfoo:a foo:b foo:c.&quot;;</b>
&nbsp;
&nbsp;		try {
<b class="nc">&nbsp;			testCon.add(new StringReader(invalidData), &quot;&quot;, RDFFormat.TURTLE);</b>
<b class="nc">&nbsp;			fail(&quot;Invalid data should result in an exception&quot;);</b>
<b class="nc">&nbsp;		} catch (RDFParseException e) {</b>
&nbsp;			// Expected behaviour
<b class="nc">&nbsp;		}</b>
&nbsp;
&nbsp;		try {
<b class="nc">&nbsp;			testCon.add(new StringReader(validData), &quot;&quot;, RDFFormat.TURTLE);</b>
<b class="nc">&nbsp;		} catch (RDFParseException e) {</b>
<b class="nc">&nbsp;			fail(&quot;Valid data should not result in an exception&quot;);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
<b class="nc">&nbsp;		assertEquals(&quot;Repository contains incorrect number of statements&quot;, 1, testCon.size());</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testStatementSerialization() throws Exception {
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob);</b>
&nbsp;
&nbsp;		Statement st;
&nbsp;
<b class="nc">&nbsp;		try (RepositoryResult&lt;Statement&gt; statements = testCon.getStatements(null, null, null, true)) {</b>
<b class="nc">&nbsp;			st = statements.next();</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
<b class="nc">&nbsp;		ByteArrayOutputStream baos = new ByteArrayOutputStream();</b>
<b class="nc">&nbsp;		ObjectOutputStream out = new ObjectOutputStream(baos);</b>
<b class="nc">&nbsp;		out.writeObject(st);</b>
<b class="nc">&nbsp;		out.close();</b>
&nbsp;
<b class="nc">&nbsp;		ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray());</b>
<b class="nc">&nbsp;		ObjectInputStream in = new ObjectInputStream(bais);</b>
<b class="nc">&nbsp;		Statement deserialized = (Statement) in.readObject();</b>
<b class="nc">&nbsp;		in.close();</b>
&nbsp;
<b class="nc">&nbsp;		assertThat(deserialized).isEqualTo(st);</b>
&nbsp;
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(st, true)).isTrue();</b>
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(deserialized, true)).isTrue();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testBNodeSerialization() throws Exception {
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob);</b>
&nbsp;
&nbsp;		Statement st;
<b class="nc">&nbsp;		try (RepositoryResult&lt;Statement&gt; statements = testCon.getStatements(null, null, null, false)) {</b>
<b class="nc">&nbsp;			st = statements.next();</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
<b class="nc">&nbsp;		BNode bnode = (BNode) st.getSubject();</b>
&nbsp;
<b class="nc">&nbsp;		ByteArrayOutputStream baos = new ByteArrayOutputStream();</b>
<b class="nc">&nbsp;		ObjectOutputStream out = new ObjectOutputStream(baos);</b>
<b class="nc">&nbsp;		out.writeObject(bnode);</b>
<b class="nc">&nbsp;		out.close();</b>
&nbsp;
<b class="nc">&nbsp;		ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray());</b>
<b class="nc">&nbsp;		ObjectInputStream in = new ObjectInputStream(bais);</b>
<b class="nc">&nbsp;		BNode deserializedBNode = (BNode) in.readObject();</b>
<b class="nc">&nbsp;		in.close();</b>
&nbsp;
<b class="nc">&nbsp;		assertThat(deserializedBNode).isEqualTo(bnode);</b>
&nbsp;
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(bnode, name, nameBob, true)).isTrue();</b>
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(deserializedBNode, name, nameBob, true)).isTrue();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testURISerialization() throws Exception {
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob);</b>
&nbsp;
&nbsp;		Statement st;
<b class="nc">&nbsp;		try (RepositoryResult&lt;Statement&gt; statements = testCon.getStatements(null, null, null, false)) {</b>
<b class="nc">&nbsp;			st = statements.next();</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
<b class="nc">&nbsp;		IRI uri = st.getPredicate();</b>
&nbsp;
<b class="nc">&nbsp;		ByteArrayOutputStream baos = new ByteArrayOutputStream();</b>
<b class="nc">&nbsp;		ObjectOutputStream out = new ObjectOutputStream(baos);</b>
<b class="nc">&nbsp;		out.writeObject(uri);</b>
<b class="nc">&nbsp;		out.close();</b>
&nbsp;
<b class="nc">&nbsp;		ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray());</b>
<b class="nc">&nbsp;		ObjectInputStream in = new ObjectInputStream(bais);</b>
<b class="nc">&nbsp;		IRI deserializedURI = (IRI) in.readObject();</b>
<b class="nc">&nbsp;		in.close();</b>
&nbsp;
<b class="nc">&nbsp;		assertThat(deserializedURI).isEqualTo(uri);</b>
&nbsp;
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(bob, uri, nameBob, true)).isTrue();</b>
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(bob, deserializedURI, nameBob, true)).isTrue();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testLiteralSerialization() throws Exception {
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob);</b>
&nbsp;
&nbsp;		Statement st;
<b class="nc">&nbsp;		try (RepositoryResult&lt;Statement&gt; statements = testCon.getStatements(null, null, null, false)) {</b>
<b class="nc">&nbsp;			st = statements.next();</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
<b class="nc">&nbsp;		Literal literal = (Literal) st.getObject();</b>
&nbsp;
<b class="nc">&nbsp;		ByteArrayOutputStream baos = new ByteArrayOutputStream();</b>
<b class="nc">&nbsp;		ObjectOutputStream out = new ObjectOutputStream(baos);</b>
<b class="nc">&nbsp;		out.writeObject(literal);</b>
<b class="nc">&nbsp;		out.close();</b>
&nbsp;
<b class="nc">&nbsp;		ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray());</b>
<b class="nc">&nbsp;		ObjectInputStream in = new ObjectInputStream(bais);</b>
<b class="nc">&nbsp;		Literal deserialized = (Literal) in.readObject();</b>
<b class="nc">&nbsp;		in.close();</b>
&nbsp;
<b class="nc">&nbsp;		assertThat(deserialized).isEqualTo(literal);</b>
&nbsp;
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(bob, name, literal, true)).isTrue();</b>
<b class="nc">&nbsp;		assertThat(testCon.hasStatement(bob, name, deserialized, true)).isTrue();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testGraphSerialization() throws Exception {
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob);</b>
<b class="nc">&nbsp;		testCon.add(alice, name, nameAlice);</b>
&nbsp;
<b class="nc">&nbsp;		try (RepositoryResult&lt;Statement&gt; statements = testCon.getStatements(null, null, null, true)) {</b>
<b class="nc">&nbsp;			Model graph = Iterations.addAll(statements, new LinkedHashModel());</b>
&nbsp;
<b class="nc">&nbsp;			ByteArrayOutputStream baos = new ByteArrayOutputStream();</b>
<b class="nc">&nbsp;			ObjectOutputStream out = new ObjectOutputStream(baos);</b>
<b class="nc">&nbsp;			out.writeObject(graph);</b>
<b class="nc">&nbsp;			out.close();</b>
&nbsp;
<b class="nc">&nbsp;			ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray());</b>
<b class="nc">&nbsp;			ObjectInputStream in = new ObjectInputStream(bais);</b>
<b class="nc">&nbsp;			Model deserializedGraph = (Model) in.readObject();</b>
<b class="nc">&nbsp;			in.close();</b>
&nbsp;
<b class="nc">&nbsp;			assertThat(deserializedGraph.isEmpty()).isFalse();</b>
<b class="nc">&nbsp;			assertThat(deserializedGraph).hasSameSizeAs(graph);</b>
<b class="nc">&nbsp;			for (Statement st : deserializedGraph) {</b>
<b class="nc">&nbsp;				assertThat(graph).contains(st);</b>
<b class="nc">&nbsp;				assertThat(testCon.hasStatement(st, true)).isTrue();</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testEmptyRollback() throws Exception {
<b class="nc">&nbsp;		if (IsolationLevels.NONE.isCompatibleWith(level)) {</b>
&nbsp;			return;
&nbsp;		}
<b class="nc">&nbsp;		assertThat(testCon.isEmpty()).isTrue();</b>
<b class="nc">&nbsp;		assertThat(testCon2.isEmpty()).isTrue();</b>
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.add(vf.createBNode(), vf.createIRI(URN_PRED), vf.createBNode());</b>
<b class="nc">&nbsp;		assertThat(testCon.isEmpty()).isFalse();</b>
<b class="nc">&nbsp;		assertThat(testCon2.isEmpty()).isTrue();</b>
<b class="nc">&nbsp;		testCon.rollback();</b>
<b class="nc">&nbsp;		assertThat(testCon.isEmpty()).isTrue();</b>
<b class="nc">&nbsp;		assertThat(testCon2.isEmpty()).isTrue();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testEmptyCommit() throws Exception {
<b class="nc">&nbsp;		if (IsolationLevels.NONE.isCompatibleWith(level)) {</b>
&nbsp;			return;
&nbsp;		}
<b class="nc">&nbsp;		assertThat(testCon.isEmpty()).isTrue();</b>
<b class="nc">&nbsp;		assertThat(testCon2.isEmpty()).isTrue();</b>
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.add(vf.createBNode(), vf.createIRI(URN_PRED), vf.createBNode());</b>
<b class="nc">&nbsp;		assertThat(testCon.isEmpty()).isFalse();</b>
<b class="nc">&nbsp;		assertThat(testCon2.isEmpty()).isTrue();</b>
<b class="nc">&nbsp;		testCon.commit();</b>
<b class="nc">&nbsp;		assertThat(testCon.isEmpty()).isFalse();</b>
<b class="nc">&nbsp;		assertThat(testCon2.isEmpty()).isFalse();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testOpen() throws Exception {
<b class="nc">&nbsp;		assertThat(testCon.isOpen()).isTrue();</b>
<b class="nc">&nbsp;		assertThat(testCon2.isOpen()).isTrue();</b>
<b class="nc">&nbsp;		testCon.close();</b>
<b class="nc">&nbsp;		assertThat(testCon.isOpen()).isFalse();</b>
<b class="nc">&nbsp;		assertThat(testCon2.isOpen()).isTrue();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testSizeRollback() throws Exception {
<b class="nc">&nbsp;		if (IsolationLevels.NONE.isCompatibleWith(level)) {</b>
&nbsp;			return;
&nbsp;		}
<b class="nc">&nbsp;		assertThat(testCon.size()).isEqualTo(0L);</b>
<b class="nc">&nbsp;		assertThat(testCon2.size()).isEqualTo(0L);</b>
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.add(vf.createBNode(), vf.createIRI(URN_PRED), vf.createBNode());</b>
<b class="nc">&nbsp;		assertThat(testCon.size()).isEqualTo(1L);</b>
<b class="nc">&nbsp;		assertThat(testCon2.size()).isEqualTo(0L);</b>
<b class="nc">&nbsp;		testCon.add(vf.createBNode(), vf.createIRI(URN_PRED), vf.createBNode());</b>
<b class="nc">&nbsp;		assertThat(testCon.size()).isEqualTo(2L);</b>
<b class="nc">&nbsp;		assertThat(testCon2.size()).isEqualTo(0L);</b>
<b class="nc">&nbsp;		testCon.rollback();</b>
<b class="nc">&nbsp;		assertThat(testCon.size()).isEqualTo(0L);</b>
<b class="nc">&nbsp;		assertThat(testCon2.size()).isEqualTo(0L);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testSizeCommit() throws Exception {
<b class="nc">&nbsp;		if (IsolationLevels.NONE.isCompatibleWith(level)) {</b>
&nbsp;			return;
&nbsp;		}
<b class="nc">&nbsp;		assertThat(testCon.size()).isEqualTo(0L);</b>
<b class="nc">&nbsp;		assertThat(testCon2.size()).isEqualTo(0L);</b>
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.add(vf.createBNode(), vf.createIRI(URN_PRED), vf.createBNode());</b>
<b class="nc">&nbsp;		assertThat(testCon.size()).isEqualTo(1L);</b>
<b class="nc">&nbsp;		assertThat(testCon2.size()).isEqualTo(0L);</b>
<b class="nc">&nbsp;		testCon.add(vf.createBNode(), vf.createIRI(URN_PRED), vf.createBNode());</b>
<b class="nc">&nbsp;		assertThat(testCon.size()).isEqualTo(2L);</b>
<b class="nc">&nbsp;		assertThat(testCon2.size()).isEqualTo(0L);</b>
<b class="nc">&nbsp;		testCon.commit();</b>
<b class="nc">&nbsp;		assertThat(testCon.size()).isEqualTo(2L);</b>
<b class="nc">&nbsp;		assertThat(testCon2.size()).isEqualTo(2L);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testSizeDuplicateStatement() throws Exception {
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.add(RDF.SUBJECT, RDF.PREDICATE, RDF.OBJECT);</b>
<b class="nc">&nbsp;		testCon.commit();</b>
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.add(RDF.SUBJECT, RDF.PREDICATE, RDF.OBJECT);</b>
<b class="nc">&nbsp;		assertEquals(&quot;Statement should appear once&quot;, 1, testCon.size());</b>
<b class="nc">&nbsp;		testCon.commit();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testAddRemove() throws RDF4JException {
<b class="nc">&nbsp;		final Statement stmt = vf.createStatement(vf.createIRI(URN_TEST_S1), vf.createIRI(URN_TEST_P1),</b>
<b class="nc">&nbsp;				vf.createIRI(URN_TEST_O1));</b>
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.add(stmt);</b>
<b class="nc">&nbsp;		testCon.remove(stmt);</b>
<b class="nc">&nbsp;		testCon.commit();</b>
&nbsp;
<b class="nc">&nbsp;		testCon.exportStatements(null, null, null, false, new AbstractRDFHandler() {</b>
&nbsp;
&nbsp;			@Override
&nbsp;			public void handleStatement(Statement st) throws RDFHandlerException {
<b class="nc">&nbsp;				assertThat(st).isNotEqualTo(stmt);</b>
&nbsp;			}
&nbsp;		});
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testAddDelete() throws RDF4JException {
<b class="nc">&nbsp;		final Statement stmt = vf.createStatement(vf.createIRI(URN_TEST_S1), vf.createIRI(URN_TEST_P1),</b>
<b class="nc">&nbsp;				vf.createIRI(URN_TEST_O1));</b>
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.add(stmt);</b>
<b class="nc">&nbsp;		testCon.prepareUpdate(QueryLanguage.SPARQL,</b>
<b class="nc">&nbsp;				&quot;DELETE DATA {&lt;&quot; + URN_TEST_S1 + &quot;&gt; &lt;&quot; + URN_TEST_P1 + &quot;&gt; &lt;&quot; + URN_TEST_O1 + &quot;&gt;}&quot;).execute();</b>
<b class="nc">&nbsp;		testCon.commit();</b>
&nbsp;
<b class="nc">&nbsp;		testCon.exportStatements(null, null, null, false, new AbstractRDFHandler() {</b>
&nbsp;
&nbsp;			@Override
&nbsp;			public void handleStatement(Statement st) throws RDFHandlerException {
<b class="nc">&nbsp;				assertThat(st).isNotEqualTo(stmt);</b>
&nbsp;			}
&nbsp;		});
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public final void testInsertRemove() throws RDF4JException {
<b class="nc">&nbsp;		final Statement stmt = vf.createStatement(vf.createIRI(URN_TEST_S1), vf.createIRI(URN_TEST_P1),</b>
<b class="nc">&nbsp;				vf.createIRI(URN_TEST_O1));</b>
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.prepareUpdate(QueryLanguage.SPARQL,</b>
<b class="nc">&nbsp;				&quot;INSERT DATA {&lt;&quot; + URN_TEST_S1 + &quot;&gt; &lt;&quot; + URN_TEST_P1 + &quot;&gt; &lt;&quot; + URN_TEST_O1 + &quot;&gt;}&quot;).execute();</b>
<b class="nc">&nbsp;		testCon.remove(stmt);</b>
<b class="nc">&nbsp;		testCon.commit();</b>
&nbsp;
<b class="nc">&nbsp;		testCon.exportStatements(null, null, null, false, new AbstractRDFHandler() {</b>
&nbsp;
&nbsp;			@Override
&nbsp;			public void handleStatement(Statement st) throws RDFHandlerException {
<b class="nc">&nbsp;				assertThat(st).isNotEqualTo(stmt);</b>
&nbsp;			}
&nbsp;		});
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testInsertDelete() throws RDF4JException {
<b class="nc">&nbsp;		final Statement stmt = vf.createStatement(vf.createIRI(URN_TEST_S1), vf.createIRI(URN_TEST_P1),</b>
<b class="nc">&nbsp;				vf.createIRI(URN_TEST_O1));</b>
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.prepareUpdate(QueryLanguage.SPARQL,</b>
<b class="nc">&nbsp;				&quot;INSERT DATA {&lt;&quot; + URN_TEST_S1 + &quot;&gt; &lt;&quot; + URN_TEST_P1 + &quot;&gt; &lt;&quot; + URN_TEST_O1 + &quot;&gt;}&quot;).execute();</b>
<b class="nc">&nbsp;		testCon.prepareUpdate(QueryLanguage.SPARQL,</b>
<b class="nc">&nbsp;				&quot;DELETE DATA {&lt;&quot; + URN_TEST_S1 + &quot;&gt; &lt;&quot; + URN_TEST_P1 + &quot;&gt; &lt;&quot; + URN_TEST_O1 + &quot;&gt;}&quot;).execute();</b>
<b class="nc">&nbsp;		testCon.commit();</b>
&nbsp;
<b class="nc">&nbsp;		testCon.exportStatements(null, null, null, false, new AbstractRDFHandler() {</b>
&nbsp;
&nbsp;			@Override
&nbsp;			public void handleStatement(Statement st) throws RDFHandlerException {
<b class="nc">&nbsp;				assertThat(st).isNotEqualTo(stmt);</b>
&nbsp;			}
&nbsp;		});
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testAddRemoveAdd() throws RDF4JException {
<b class="nc">&nbsp;		Statement stmt = vf.createStatement(vf.createIRI(URN_TEST_S1), vf.createIRI(URN_TEST_P1),</b>
<b class="nc">&nbsp;				vf.createIRI(URN_TEST_O1));</b>
<b class="nc">&nbsp;		testCon.add(stmt);</b>
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.remove(vf.createIRI(URN_TEST_S1), vf.createIRI(URN_TEST_P1), vf.createIRI(URN_TEST_O1));</b>
<b class="nc">&nbsp;		testCon.add(stmt);</b>
<b class="nc">&nbsp;		testCon.commit();</b>
<b class="nc">&nbsp;		Assert.assertFalse(testCon.isEmpty());</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testAddDeleteAdd() throws RDF4JException {
<b class="nc">&nbsp;		Statement stmt = vf.createStatement(vf.createIRI(URN_TEST_S1), vf.createIRI(URN_TEST_P1),</b>
<b class="nc">&nbsp;				vf.createIRI(URN_TEST_O1));</b>
<b class="nc">&nbsp;		testCon.add(stmt);</b>
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.prepareUpdate(QueryLanguage.SPARQL,</b>
<b class="nc">&nbsp;				&quot;DELETE DATA {&lt;&quot; + URN_TEST_S1 + &quot;&gt; &lt;&quot; + URN_TEST_P1 + &quot;&gt; &lt;&quot; + URN_TEST_O1 + &quot;&gt;}&quot;).execute();</b>
<b class="nc">&nbsp;		testCon.add(stmt);</b>
<b class="nc">&nbsp;		testCon.commit();</b>
<b class="nc">&nbsp;		Assert.assertFalse(testCon.isEmpty());</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testAddRemoveInsert() throws RDF4JException {
<b class="nc">&nbsp;		Statement stmt = vf.createStatement(vf.createIRI(URN_TEST_S1), vf.createIRI(URN_TEST_P1),</b>
<b class="nc">&nbsp;				vf.createIRI(URN_TEST_O1));</b>
<b class="nc">&nbsp;		testCon.add(stmt);</b>
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.remove(stmt);</b>
<b class="nc">&nbsp;		testCon.prepareUpdate(QueryLanguage.SPARQL,</b>
<b class="nc">&nbsp;				&quot;INSERT DATA {&lt;&quot; + URN_TEST_S1 + &quot;&gt; &lt;&quot; + URN_TEST_P1 + &quot;&gt; &lt;&quot; + URN_TEST_O1 + &quot;&gt;}&quot;).execute();</b>
<b class="nc">&nbsp;		testCon.commit();</b>
<b class="nc">&nbsp;		Assert.assertFalse(testCon.isEmpty());</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testAddDeleteInsert() throws RDF4JException {
<b class="nc">&nbsp;		testCon.add(vf.createIRI(URN_TEST_S1), vf.createIRI(URN_TEST_P1), vf.createIRI(URN_TEST_O1));</b>
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.prepareUpdate(QueryLanguage.SPARQL,</b>
<b class="nc">&nbsp;				&quot;DELETE DATA {&lt;&quot; + URN_TEST_S1 + &quot;&gt; &lt;&quot; + URN_TEST_P1 + &quot;&gt; &lt;&quot; + URN_TEST_O1 + &quot;&gt;}&quot;).execute();</b>
<b class="nc">&nbsp;		testCon.prepareUpdate(QueryLanguage.SPARQL,</b>
<b class="nc">&nbsp;				&quot;INSERT DATA {&lt;&quot; + URN_TEST_S1 + &quot;&gt; &lt;&quot; + URN_TEST_P1 + &quot;&gt; &lt;&quot; + URN_TEST_O1 + &quot;&gt;}&quot;).execute();</b>
<b class="nc">&nbsp;		testCon.commit();</b>
<b class="nc">&nbsp;		Assert.assertFalse(testCon.isEmpty());</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testQueryInTransaction() throws Exception {
<b class="nc">&nbsp;		testCon.add(bob, RDF.TYPE, FOAF.PERSON);</b>
&nbsp;
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		String query = &quot;SELECT * where {?x a ?y }&quot;;</b>
<b class="nc">&nbsp;		try (TupleQueryResult result = testCon.prepareTupleQuery(QueryLanguage.SPARQL, query).evaluate()) {</b>
&nbsp;			// test verifies that query as part of transaction executes and returns
&nbsp;			// a result
<b class="nc">&nbsp;			assertNotNull(result);</b>
<b class="nc">&nbsp;			assertTrue(result.hasNext());</b>
<b class="nc">&nbsp;			testCon.commit();</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testUpdateInTransaction() throws Exception {
<b class="nc">&nbsp;		testCon.add(bob, RDF.TYPE, FOAF.PERSON);</b>
&nbsp;
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		String query = &quot;INSERT { ?x rdfs:label \&quot;Bob\&quot; } where {?x a ?y }&quot;;</b>
<b class="nc">&nbsp;		testCon.prepareUpdate(QueryLanguage.SPARQL, query).execute();</b>
&nbsp;
&nbsp;		// test verifies that update as part of transaction executes and returns
&nbsp;		// a result
<b class="nc">&nbsp;		assertTrue(testCon.hasStatement(bob, RDFS.LABEL, vf.createLiteral(&quot;Bob&quot;), true));</b>
<b class="nc">&nbsp;		testCon.commit();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testInferredStatementCount() throws Exception {
<b class="nc">&nbsp;		assertThat(testCon.isEmpty()).isTrue();</b>
<b class="nc">&nbsp;		long inferred = getTotalStatementCount(testCon);</b>
&nbsp;
<b class="nc">&nbsp;		IRI root = vf.createIRI(&quot;urn:root&quot;);</b>
&nbsp;
<b class="nc">&nbsp;		testCon.add(root, RDF.TYPE, RDF.LIST);</b>
<b class="nc">&nbsp;		testCon.remove(root, RDF.TYPE, RDF.LIST);</b>
&nbsp;
<b class="nc">&nbsp;		assertThat(testCon.isEmpty()).isTrue();</b>
<b class="nc">&nbsp;		assertThat(getTotalStatementCount(testCon)).isEqualTo(inferred);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testGetContextIDs() throws Exception {
<b class="nc">&nbsp;		assertThat(Iterations.asList(testCon.getContextIDs())).isEmpty();</b>
&nbsp;
&nbsp;		// load data
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob, context1);</b>
<b class="nc">&nbsp;		assertThat(Iterations.asList(testCon.getContextIDs())).isEqualTo(List.of((Resource) context1));</b>
&nbsp;
<b class="nc">&nbsp;		testCon.remove(bob, name, nameBob, context1);</b>
<b class="nc">&nbsp;		assertThat(Iterations.asList(testCon.getContextIDs())).isEmpty();</b>
&nbsp;
<b class="nc">&nbsp;		testCon.add(bob, name, nameBob, context2);</b>
<b class="nc">&nbsp;		assertThat(Iterations.asList(testCon.getContextIDs())).isEqualTo(List.of((Resource) context2));</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testXmlCalendarZ() throws Exception {
<b class="nc">&nbsp;		String NS = &quot;http://example.org/rdf/&quot;;</b>
<b class="nc">&nbsp;		int OFFSET = TimeZone.getDefault()</b>
<b class="nc">&nbsp;				.getOffset(new GregorianCalendar(2007 - 1900, Calendar.NOVEMBER, 6).getTimeInMillis()) / 1000 / 60;</b>
<b class="nc">&nbsp;		String SELECT_BY_DATE = &quot;SELECT ?s ?d WHERE { ?s &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#value&gt; ?d . FILTER (?d &lt;= ?date) }&quot;;</b>
<b class="nc">&nbsp;		DatatypeFactory data = DatatypeFactory.newInstance();</b>
<b class="nc">&nbsp;		for (int i = 1; i &lt; 5; i++) {</b>
<b class="nc">&nbsp;			IRI uri = vf.createIRI(NS, &quot;date&quot; + i);</b>
<b class="nc">&nbsp;			XMLGregorianCalendar xcal = data.newXMLGregorianCalendar();</b>
<b class="nc">&nbsp;			xcal.setYear(2000);</b>
<b class="nc">&nbsp;			xcal.setMonth(11);</b>
<b class="nc">&nbsp;			xcal.setDay(i * 2);</b>
<b class="nc">&nbsp;			testCon.add(uri, RDF.VALUE, vf.createLiteral(xcal));</b>
<b class="nc">&nbsp;			IRI uriz = vf.createIRI(NS, &quot;dateZ&quot; + i);</b>
<b class="nc">&nbsp;			xcal = data.newXMLGregorianCalendar();</b>
<b class="nc">&nbsp;			xcal.setYear(2007);</b>
<b class="nc">&nbsp;			xcal.setMonth(11);</b>
<b class="nc">&nbsp;			xcal.setDay(i * 2);</b>
<b class="nc">&nbsp;			xcal.setTimezone(OFFSET);</b>
<b class="nc">&nbsp;			testCon.add(uriz, RDF.VALUE, vf.createLiteral(xcal));</b>
&nbsp;		}
<b class="nc">&nbsp;		XMLGregorianCalendar xcal = data.newXMLGregorianCalendar();</b>
<b class="nc">&nbsp;		xcal.setYear(2007);</b>
<b class="nc">&nbsp;		xcal.setMonth(11);</b>
<b class="nc">&nbsp;		xcal.setDay(6);</b>
<b class="nc">&nbsp;		xcal.setTimezone(OFFSET);</b>
<b class="nc">&nbsp;		TupleQuery query = testCon.prepareTupleQuery(QueryLanguage.SPARQL, SELECT_BY_DATE);</b>
<b class="nc">&nbsp;		query.setBinding(&quot;date&quot;, vf.createLiteral(xcal));</b>
<b class="nc">&nbsp;		TupleQueryResult result = query.evaluate();</b>
<b class="nc">&nbsp;		List&lt;BindingSet&gt; list = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;		while (result.hasNext()) {</b>
<b class="nc">&nbsp;			list.add(result.next());</b>
&nbsp;		}
<b class="nc">&nbsp;		assertThat(list).hasSize(7);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testOptionalFilter() throws Exception {
<b class="nc">&nbsp;		String optional = &quot;{ ?s :p1 ?v1 OPTIONAL {?s :p2 ?v2 FILTER(?v1&lt;3) } }&quot;;</b>
<b class="nc">&nbsp;		IRI s = vf.createIRI(&quot;urn:test:s&quot;);</b>
<b class="nc">&nbsp;		IRI p1 = vf.createIRI(URN_TEST_P1);</b>
<b class="nc">&nbsp;		IRI p2 = vf.createIRI(URN_TEST_P2);</b>
<b class="nc">&nbsp;		Value v1 = vf.createLiteral(1);</b>
<b class="nc">&nbsp;		Value v2 = vf.createLiteral(2);</b>
<b class="nc">&nbsp;		Value v3 = vf.createLiteral(3);</b>
<b class="nc">&nbsp;		testCon.add(s, p1, v1);</b>
<b class="nc">&nbsp;		testCon.add(s, p2, v2);</b>
<b class="nc">&nbsp;		testCon.add(s, p1, v3);</b>
<b class="nc">&nbsp;		String qry = &quot;PREFIX :&lt;urn:test:&gt; SELECT ?s ?v1 ?v2 WHERE &quot; + optional;</b>
<b class="nc">&nbsp;		TupleQuery query = testCon.prepareTupleQuery(QueryLanguage.SPARQL, qry);</b>
<b class="nc">&nbsp;		try (TupleQueryResult result = query.evaluate()) {</b>
<b class="nc">&nbsp;			Set&lt;List&lt;Value&gt;&gt; set = new HashSet&lt;&gt;();</b>
<b class="nc">&nbsp;			while (result.hasNext()) {</b>
<b class="nc">&nbsp;				BindingSet bindings = result.next();</b>
<b class="nc">&nbsp;				set.add(Arrays.asList(bindings.getValue(&quot;v1&quot;), bindings.getValue(&quot;v2&quot;)));</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;			assertThat(set).contains(Arrays.asList(v1, v2));</b>
<b class="nc">&nbsp;			assertThat(set).contains(Arrays.asList(v3, null));</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testOrPredicate() throws Exception {
<b class="nc">&nbsp;		String union = &quot;{ :s ?p :o FILTER (?p = :p1 || ?p = :p2) }&quot;;</b>
<b class="nc">&nbsp;		IRI s = vf.createIRI(&quot;urn:test:s&quot;);</b>
<b class="nc">&nbsp;		IRI p1 = vf.createIRI(URN_TEST_P1);</b>
<b class="nc">&nbsp;		IRI p2 = vf.createIRI(URN_TEST_P2);</b>
<b class="nc">&nbsp;		IRI o = vf.createIRI(&quot;urn:test:o&quot;);</b>
<b class="nc">&nbsp;		testCon.add(s, p1, o);</b>
<b class="nc">&nbsp;		testCon.add(s, p2, o);</b>
<b class="nc">&nbsp;		String qry = &quot;PREFIX :&lt;urn:test:&gt; SELECT ?p WHERE &quot; + union;</b>
<b class="nc">&nbsp;		TupleQuery query = testCon.prepareTupleQuery(QueryLanguage.SPARQL, qry);</b>
<b class="nc">&nbsp;		try (TupleQueryResult result = query.evaluate()) {</b>
<b class="nc">&nbsp;			List&lt;Value&gt; list = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;			while (result.hasNext()) {</b>
<b class="nc">&nbsp;				BindingSet bindings = result.next();</b>
<b class="nc">&nbsp;				list.add(bindings.getValue(&quot;p&quot;));</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;			assertThat(list).contains(p1);</b>
<b class="nc">&nbsp;			assertThat(list).contains(p2);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testSES713() throws Exception {
<b class="nc">&nbsp;		String queryString = &quot;SELECT * { ?sub ?pred ?obj . FILTER ( &#39;not a number&#39; + 1 = ?obj )}&quot;;</b>
&nbsp;
<b class="nc">&nbsp;		TupleQuery query = testCon.prepareTupleQuery(QueryLanguage.SPARQL, queryString);</b>
<b class="nc">&nbsp;		try (TupleQueryResult tqr = query.evaluate()) {</b>
<b class="nc">&nbsp;			assertFalse(&quot;Query should not return any results&quot;, tqr.hasNext());</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testSES2172ChineseChars() throws Exception {
<b class="nc">&nbsp;		String updateString = &quot;INSERT DATA { &lt;urn:subject1&gt; rdfs:label \&quot;\\u8BBE\\u5907\&quot;. }&quot;;</b>
&nbsp;
<b class="nc">&nbsp;		Update update = testCon.prepareUpdate(QueryLanguage.SPARQL, updateString);</b>
<b class="nc">&nbsp;		update.execute();</b>
&nbsp;
<b class="nc">&nbsp;		assertFalse(testCon.isEmpty());</b>
&nbsp;
<b class="nc">&nbsp;		String queryString = &quot;SELECT ?o WHERE { &lt;urn:subject1&gt; rdfs:label ?o . }&quot;;</b>
&nbsp;
<b class="nc">&nbsp;		TupleQuery query = testCon.prepareTupleQuery(QueryLanguage.SPARQL, queryString);</b>
<b class="nc">&nbsp;		try (TupleQueryResult result = query.evaluate()) {</b>
<b class="nc">&nbsp;			assertNotNull(result);</b>
&nbsp;
<b class="nc">&nbsp;			final String expected = &quot;设备&quot;;</b>
<b class="nc">&nbsp;			while (result.hasNext()) {</b>
<b class="nc">&nbsp;				Value o = result.next().getValue(&quot;o&quot;);</b>
&nbsp;
<b class="nc">&nbsp;				assertEquals(expected, o.stringValue());</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testQueryDefaultGraph() throws Exception {
<b class="nc">&nbsp;		IRI graph = vf.createIRI(&quot;urn:test:default&quot;);</b>
<b class="nc">&nbsp;		testCon.add(vf.createIRI(URN_TEST_S1), vf.createIRI(URN_TEST_P1), vf.createIRI(URN_TEST_O1));</b>
<b class="nc">&nbsp;		assertThat(size(graph)).isEqualTo(0);</b>
<b class="nc">&nbsp;		testCon.add(vf.createIRI(&quot;urn:test:s2&quot;), vf.createIRI(URN_TEST_P2), vf.createIRI(&quot;urn:test:o2&quot;), graph);</b>
<b class="nc">&nbsp;		assertThat(size(graph)).isEqualTo(1);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testQueryBaseURI() throws Exception {
<b class="nc">&nbsp;		testCon.add(vf.createIRI(URN_TEST_S1), vf.createIRI(URN_TEST_P1), vf.createIRI(URN_TEST_O1));</b>
<b class="nc">&nbsp;		try (TupleQueryResult rs = testCon.prepareTupleQuery(QueryLanguage.SPARQL, &quot;SELECT * { &lt;&gt; ?p ?o }&quot;, URN_TEST_S1)</b>
<b class="nc">&nbsp;				.evaluate()) {</b>
<b class="nc">&nbsp;			assertThat(rs.hasNext()).isTrue();</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testUpdateBaseURI() throws Exception {
<b class="nc">&nbsp;		testCon.prepareUpdate(QueryLanguage.SPARQL, &quot;INSERT DATA { &lt;&gt; a &lt;&gt; }&quot;, URN_TEST_S1).execute();</b>
<b class="nc">&nbsp;		assertThat(testCon.size()).isEqualTo(1L);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testDeleteDefaultGraph() throws Exception {
<b class="nc">&nbsp;		IRI g1 = vf.createIRI(&quot;urn:test:g1&quot;);</b>
<b class="nc">&nbsp;		IRI g2 = vf.createIRI(&quot;urn:test:g2&quot;);</b>
<b class="nc">&nbsp;		testCon.add(vf.createIRI(URN_TEST_S1), vf.createIRI(URN_TEST_P1), vf.createIRI(URN_TEST_O1), g1);</b>
<b class="nc">&nbsp;		testCon.add(vf.createIRI(&quot;urn:test:s2&quot;), vf.createIRI(URN_TEST_P2), vf.createIRI(&quot;urn:test:o2&quot;), g2);</b>
<b class="nc">&nbsp;		Update up = testCon.prepareUpdate(QueryLanguage.SPARQL, SPARQL_DEL_ALL);</b>
<b class="nc">&nbsp;		SimpleDataset ds = new SimpleDataset();</b>
<b class="nc">&nbsp;		ds.addDefaultGraph(g1);</b>
<b class="nc">&nbsp;		ds.addDefaultRemoveGraph(g1);</b>
<b class="nc">&nbsp;		up.setDataset(ds);</b>
<b class="nc">&nbsp;		up.execute();</b>
<b class="nc">&nbsp;		assertThat(size(g1)).isEqualTo(0);</b>
<b class="nc">&nbsp;		assertThat(size(g2)).isEqualTo(1);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testRemoveStatementsFromContextSingleTransaction() throws Exception {
<b class="nc">&nbsp;		IRI g1 = vf.createIRI(&quot;urn:test:g1&quot;);</b>
<b class="nc">&nbsp;		IRI g2 = vf.createIRI(&quot;urn:test:g2&quot;);</b>
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.add(vf.createIRI(URN_TEST_S1), vf.createIRI(URN_TEST_P1), vf.createIRI(URN_TEST_O1), g1);</b>
<b class="nc">&nbsp;		testCon.add(vf.createIRI(&quot;urn:test:s2&quot;), vf.createIRI(URN_TEST_P2), vf.createIRI(&quot;urn:test:o2&quot;), g2);</b>
<b class="nc">&nbsp;		testCon.commit();</b>
&nbsp;
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.remove(((Resource) null), null, null, g1);</b>
<b class="nc">&nbsp;		try (Stream&lt;Statement&gt; stream = testCon.getStatements(null, null, null, false).stream()) {</b>
<b class="nc">&nbsp;			List&lt;Statement&gt; collect = stream.collect(Collectors.toList());</b>
<b class="nc">&nbsp;			assertEquals(1, collect.size());</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		testCon.commit();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Test
&nbsp;	public void testClearStatementsFromContextSingleTransaction() throws Exception {
<b class="nc">&nbsp;		IRI g1 = vf.createIRI(&quot;urn:test:g1&quot;);</b>
<b class="nc">&nbsp;		IRI g2 = vf.createIRI(&quot;urn:test:g2&quot;);</b>
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.add(vf.createIRI(URN_TEST_S1), vf.createIRI(URN_TEST_P1), vf.createIRI(URN_TEST_O1), g1);</b>
<b class="nc">&nbsp;		testCon.add(vf.createIRI(&quot;urn:test:s2&quot;), vf.createIRI(URN_TEST_P2), vf.createIRI(&quot;urn:test:o2&quot;), g2);</b>
<b class="nc">&nbsp;		testCon.commit();</b>
&nbsp;
<b class="nc">&nbsp;		testCon.begin();</b>
<b class="nc">&nbsp;		testCon.clear(g1);</b>
&nbsp;
<b class="nc">&nbsp;		try (Stream&lt;Statement&gt; stream = testCon.getStatements(null, null, null, false).stream()) {</b>
<b class="nc">&nbsp;			List&lt;Statement&gt; collect = stream.collect(Collectors.toList());</b>
<b class="nc">&nbsp;			assertEquals(1, collect.size());</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		testCon.commit();</b>
&nbsp;	}
&nbsp;
&nbsp;	private long size(IRI defaultGraph) throws RepositoryException, MalformedQueryException, QueryEvaluationException {
<b class="nc">&nbsp;		TupleQuery qry = testCon.prepareTupleQuery(QueryLanguage.SPARQL, &quot;SELECT * { ?s ?p ?o }&quot;);</b>
<b class="nc">&nbsp;		SimpleDataset dataset = new SimpleDataset();</b>
<b class="nc">&nbsp;		dataset.addDefaultGraph(defaultGraph);</b>
<b class="nc">&nbsp;		qry.setDataset(dataset);</b>
&nbsp;
&nbsp;		long size;
<b class="nc">&nbsp;		try (TupleQueryResult result = qry.evaluate()) {</b>
<b class="nc">&nbsp;			size = result.stream().count();</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
<b class="nc">&nbsp;		try (Stream&lt;Statement&gt; stream = testCon.getStatements(null, null, null, defaultGraph).stream()) {</b>
<b class="nc">&nbsp;			assertEquals(size, stream.count());</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
<b class="nc">&nbsp;		return size;</b>
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	private long getTotalStatementCount(RepositoryConnection connection) throws RepositoryException {
<b class="nc">&nbsp;		try (CloseableIteration&lt;? extends Statement, RepositoryException&gt; iter = connection.getStatements(null, null,</b>
&nbsp;				null, true)) {
<b class="nc">&nbsp;			return iter.stream().count();</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2022-09-18 08:20</div>
</div>
</body>
</html>
