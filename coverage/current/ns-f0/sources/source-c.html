


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > SpinRenderer</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.eclipse.rdf4j.spin</a>
</div>

<h1>Coverage Summary for Class: SpinRenderer (org.eclipse.rdf4j.spin)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">SpinRenderer</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/52)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/108)
  </span>
</td>
</tr>
  <tr>
    <td class="name">SpinRenderer$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpinRenderer$AskVisitor</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpinRenderer$ConstructVisitor</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/29)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpinRenderer$DescribeVisitor</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpinRenderer$ExtensionContext</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpinRenderer$ListContext</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpinRenderer$Output</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpinRenderer$SpinVisitor</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/72)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/115)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/521)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpinRenderer$SpinVisitor$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/34)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpinRenderer$SpinVisitor$ExtensionVisitor</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/58)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpinRenderer$SpinVisitor$GroupVisitor</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/23)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpinRenderer$SpinVisitor$OrderVisitor</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/13)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/124)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/221)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/823)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*******************************************************************************
&nbsp; * Copyright (c) 2015 Eclipse RDF4J contributors, Aduna, and others.
&nbsp; *
&nbsp; * All rights reserved. This program and the accompanying materials
&nbsp; * are made available under the terms of the Eclipse Distribution License v1.0
&nbsp; * which accompanies this distribution, and is available at
&nbsp; * http://www.eclipse.org/org/documents/edl-v10.php.
&nbsp; *
&nbsp; * SPDX-License-Identifier: BSD-3-Clause
&nbsp; *******************************************************************************/
&nbsp;package org.eclipse.rdf4j.spin;
&nbsp;
&nbsp;import java.io.IOException;
&nbsp;import java.io.StringReader;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.LinkedHashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Set;
&nbsp;
&nbsp;import org.eclipse.rdf4j.model.BNode;
&nbsp;import org.eclipse.rdf4j.model.IRI;
&nbsp;import org.eclipse.rdf4j.model.Resource;
&nbsp;import org.eclipse.rdf4j.model.Statement;
&nbsp;import org.eclipse.rdf4j.model.Value;
&nbsp;import org.eclipse.rdf4j.model.ValueFactory;
&nbsp;import org.eclipse.rdf4j.model.impl.BooleanLiteral;
&nbsp;import org.eclipse.rdf4j.model.impl.SimpleValueFactory;
&nbsp;import org.eclipse.rdf4j.model.vocabulary.AFN;
&nbsp;import org.eclipse.rdf4j.model.vocabulary.RDF;
&nbsp;import org.eclipse.rdf4j.model.vocabulary.SP;
&nbsp;import org.eclipse.rdf4j.model.vocabulary.XSD;
&nbsp;import org.eclipse.rdf4j.query.BindingSet;
&nbsp;import org.eclipse.rdf4j.query.Dataset;
&nbsp;import org.eclipse.rdf4j.query.algebra.And;
&nbsp;import org.eclipse.rdf4j.query.algebra.Avg;
&nbsp;import org.eclipse.rdf4j.query.algebra.BNodeGenerator;
&nbsp;import org.eclipse.rdf4j.query.algebra.BindingSetAssignment;
&nbsp;import org.eclipse.rdf4j.query.algebra.Bound;
&nbsp;import org.eclipse.rdf4j.query.algebra.Clear;
&nbsp;import org.eclipse.rdf4j.query.algebra.Coalesce;
&nbsp;import org.eclipse.rdf4j.query.algebra.Compare;
&nbsp;import org.eclipse.rdf4j.query.algebra.Compare.CompareOp;
&nbsp;import org.eclipse.rdf4j.query.algebra.Count;
&nbsp;import org.eclipse.rdf4j.query.algebra.Create;
&nbsp;import org.eclipse.rdf4j.query.algebra.Datatype;
&nbsp;import org.eclipse.rdf4j.query.algebra.DeleteData;
&nbsp;import org.eclipse.rdf4j.query.algebra.Difference;
&nbsp;import org.eclipse.rdf4j.query.algebra.Distinct;
&nbsp;import org.eclipse.rdf4j.query.algebra.Exists;
&nbsp;import org.eclipse.rdf4j.query.algebra.Extension;
&nbsp;import org.eclipse.rdf4j.query.algebra.ExtensionElem;
&nbsp;import org.eclipse.rdf4j.query.algebra.Filter;
&nbsp;import org.eclipse.rdf4j.query.algebra.FunctionCall;
&nbsp;import org.eclipse.rdf4j.query.algebra.Group;
&nbsp;import org.eclipse.rdf4j.query.algebra.GroupConcat;
&nbsp;import org.eclipse.rdf4j.query.algebra.IRIFunction;
&nbsp;import org.eclipse.rdf4j.query.algebra.If;
&nbsp;import org.eclipse.rdf4j.query.algebra.InsertData;
&nbsp;import org.eclipse.rdf4j.query.algebra.IsBNode;
&nbsp;import org.eclipse.rdf4j.query.algebra.IsLiteral;
&nbsp;import org.eclipse.rdf4j.query.algebra.IsNumeric;
&nbsp;import org.eclipse.rdf4j.query.algebra.IsURI;
&nbsp;import org.eclipse.rdf4j.query.algebra.Join;
&nbsp;import org.eclipse.rdf4j.query.algebra.Lang;
&nbsp;import org.eclipse.rdf4j.query.algebra.LeftJoin;
&nbsp;import org.eclipse.rdf4j.query.algebra.Load;
&nbsp;import org.eclipse.rdf4j.query.algebra.LocalName;
&nbsp;import org.eclipse.rdf4j.query.algebra.MathExpr;
&nbsp;import org.eclipse.rdf4j.query.algebra.MathExpr.MathOp;
&nbsp;import org.eclipse.rdf4j.query.algebra.Max;
&nbsp;import org.eclipse.rdf4j.query.algebra.Min;
&nbsp;import org.eclipse.rdf4j.query.algebra.Modify;
&nbsp;import org.eclipse.rdf4j.query.algebra.MultiProjection;
&nbsp;import org.eclipse.rdf4j.query.algebra.Not;
&nbsp;import org.eclipse.rdf4j.query.algebra.Or;
&nbsp;import org.eclipse.rdf4j.query.algebra.Order;
&nbsp;import org.eclipse.rdf4j.query.algebra.OrderElem;
&nbsp;import org.eclipse.rdf4j.query.algebra.Projection;
&nbsp;import org.eclipse.rdf4j.query.algebra.ProjectionElem;
&nbsp;import org.eclipse.rdf4j.query.algebra.ProjectionElemList;
&nbsp;import org.eclipse.rdf4j.query.algebra.QueryModelNode;
&nbsp;import org.eclipse.rdf4j.query.algebra.Reduced;
&nbsp;import org.eclipse.rdf4j.query.algebra.Regex;
&nbsp;import org.eclipse.rdf4j.query.algebra.Sample;
&nbsp;import org.eclipse.rdf4j.query.algebra.Service;
&nbsp;import org.eclipse.rdf4j.query.algebra.Slice;
&nbsp;import org.eclipse.rdf4j.query.algebra.StatementPattern;
&nbsp;import org.eclipse.rdf4j.query.algebra.Str;
&nbsp;import org.eclipse.rdf4j.query.algebra.Sum;
&nbsp;import org.eclipse.rdf4j.query.algebra.TupleExpr;
&nbsp;import org.eclipse.rdf4j.query.algebra.Union;
&nbsp;import org.eclipse.rdf4j.query.algebra.UpdateExpr;
&nbsp;import org.eclipse.rdf4j.query.algebra.ValueConstant;
&nbsp;import org.eclipse.rdf4j.query.algebra.ValueExpr;
&nbsp;import org.eclipse.rdf4j.query.algebra.Var;
&nbsp;import org.eclipse.rdf4j.query.algebra.helpers.QueryModelVisitorBase;
&nbsp;import org.eclipse.rdf4j.query.parser.ParsedBooleanQuery;
&nbsp;import org.eclipse.rdf4j.query.parser.ParsedDescribeQuery;
&nbsp;import org.eclipse.rdf4j.query.parser.ParsedGraphQuery;
&nbsp;import org.eclipse.rdf4j.query.parser.ParsedOperation;
&nbsp;import org.eclipse.rdf4j.query.parser.ParsedQuery;
&nbsp;import org.eclipse.rdf4j.query.parser.ParsedTupleQuery;
&nbsp;import org.eclipse.rdf4j.query.parser.ParsedUpdate;
&nbsp;import org.eclipse.rdf4j.query.parser.sparql.SPARQLUpdateDataBlockParser;
&nbsp;import org.eclipse.rdf4j.rio.RDFHandler;
&nbsp;import org.eclipse.rdf4j.rio.RDFHandlerException;
&nbsp;import org.eclipse.rdf4j.rio.RDFParseException;
&nbsp;import org.eclipse.rdf4j.rio.helpers.AbstractRDFHandler;
&nbsp;
&nbsp;import com.google.common.base.Function;
&nbsp;
&nbsp;public class SpinRenderer {
&nbsp;
<b class="nc">&nbsp;	public enum Output {</b>
<b class="nc">&nbsp;		TEXT_AND_RDF(true, true),</b>
<b class="nc">&nbsp;		TEXT_ONLY(true, false),</b>
<b class="nc">&nbsp;		RDF_ONLY(false, true);</b>
&nbsp;
&nbsp;		final boolean text, rdf;
&nbsp;
<b class="nc">&nbsp;		Output(boolean text, boolean rdf) {</b>
<b class="nc">&nbsp;			this.text = text;</b>
<b class="nc">&nbsp;			this.rdf = rdf;</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private final ValueFactory valueFactory;
&nbsp;
&nbsp;	private final Output output;
&nbsp;
&nbsp;	private final Function&lt;String, IRI&gt; wellKnownVars;
&nbsp;
&nbsp;	private final Function&lt;String, IRI&gt; wellKnownFunctions;
&nbsp;
&nbsp;	public SpinRenderer() {
<b class="nc">&nbsp;		this(Output.TEXT_AND_RDF);</b>
&nbsp;	}
&nbsp;
&nbsp;	public SpinRenderer(Output output) {
<b class="nc">&nbsp;		this(output, SpinWellKnownVars.INSTANCE::getURI, SpinWellKnownFunctions.INSTANCE::getURI,</b>
<b class="nc">&nbsp;				SimpleValueFactory.getInstance());</b>
&nbsp;	}
&nbsp;
&nbsp;	public SpinRenderer(Output output, Function&lt;String, IRI&gt; wellKnownVarMapper,
<b class="nc">&nbsp;			Function&lt;String, IRI&gt; wellKnownFuncMapper, ValueFactory vf) {</b>
<b class="nc">&nbsp;		this.output = output;</b>
<b class="nc">&nbsp;		this.wellKnownVars = wellKnownVarMapper;</b>
<b class="nc">&nbsp;		this.wellKnownFunctions = wellKnownFuncMapper;</b>
<b class="nc">&nbsp;		this.valueFactory = vf;</b>
&nbsp;	}
&nbsp;
&nbsp;	public void render(ParsedOperation operation, RDFHandler handler) throws RDFHandlerException {
<b class="nc">&nbsp;		if (operation instanceof ParsedQuery) {</b>
<b class="nc">&nbsp;			render((ParsedQuery) operation, handler);</b>
<b class="nc">&nbsp;		} else if (operation instanceof ParsedUpdate) {</b>
<b class="nc">&nbsp;			render((ParsedUpdate) operation, handler);</b>
&nbsp;		} else {
<b class="nc">&nbsp;			throw new AssertionError(&quot;Unrecognised ParsedOperation: &quot; + operation.getClass());</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	public void render(ParsedQuery query, RDFHandler handler) throws RDFHandlerException {
<b class="nc">&nbsp;		if (query instanceof ParsedBooleanQuery) {</b>
<b class="nc">&nbsp;			render((ParsedBooleanQuery) query, handler);</b>
<b class="nc">&nbsp;		} else if (query instanceof ParsedTupleQuery) {</b>
<b class="nc">&nbsp;			render((ParsedTupleQuery) query, handler);</b>
&nbsp;		}
&nbsp;		// order matters as subclass of ParsedGraphQuery
<b class="nc">&nbsp;		else if (query instanceof ParsedDescribeQuery) {</b>
<b class="nc">&nbsp;			render((ParsedDescribeQuery) query, handler);</b>
<b class="nc">&nbsp;		} else if (query instanceof ParsedGraphQuery) {</b>
<b class="nc">&nbsp;			render((ParsedGraphQuery) query, handler);</b>
&nbsp;		} else {
<b class="nc">&nbsp;			throw new AssertionError(&quot;Unrecognised ParsedQuery: &quot; + query.getClass());</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	public void render(ParsedBooleanQuery query, RDFHandler handler) throws RDFHandlerException {
<b class="nc">&nbsp;		handler.startRDF();</b>
<b class="nc">&nbsp;		Resource querySubj = valueFactory.createBNode();</b>
<b class="nc">&nbsp;		handler.handleStatement(valueFactory.createStatement(querySubj, RDF.TYPE, SP.ASK_CLASS));</b>
<b class="nc">&nbsp;		if (output.text) {</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(querySubj, SP.TEXT_PROPERTY,</b>
<b class="nc">&nbsp;					valueFactory.createLiteral(query.getSourceString())));</b>
&nbsp;		}
<b class="nc">&nbsp;		if (output.rdf) {</b>
<b class="nc">&nbsp;			Resource whereBNode = valueFactory.createBNode();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(querySubj, SP.WHERE_PROPERTY, whereBNode));</b>
<b class="nc">&nbsp;			TupleExpr expr = query.getTupleExpr();</b>
<b class="nc">&nbsp;			SpinVisitor visitor = new AskVisitor(handler, whereBNode, query.getDataset());</b>
<b class="nc">&nbsp;			expr.visit(visitor);</b>
<b class="nc">&nbsp;			visitor.end();</b>
&nbsp;		}
<b class="nc">&nbsp;		handler.endRDF();</b>
&nbsp;	}
&nbsp;
&nbsp;	public void render(ParsedTupleQuery query, RDFHandler handler) throws RDFHandlerException {
<b class="nc">&nbsp;		handler.startRDF();</b>
<b class="nc">&nbsp;		Resource querySubj = valueFactory.createBNode();</b>
<b class="nc">&nbsp;		handler.handleStatement(valueFactory.createStatement(querySubj, RDF.TYPE, SP.SELECT_CLASS));</b>
<b class="nc">&nbsp;		if (output.text) {</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(querySubj, SP.TEXT_PROPERTY,</b>
<b class="nc">&nbsp;					valueFactory.createLiteral(query.getSourceString())));</b>
&nbsp;		}
<b class="nc">&nbsp;		if (output.rdf) {</b>
<b class="nc">&nbsp;			TupleExpr expr = query.getTupleExpr();</b>
<b class="nc">&nbsp;			SpinVisitor visitor = new SpinVisitor(handler, null, querySubj, query.getDataset());</b>
<b class="nc">&nbsp;			expr.visit(visitor);</b>
<b class="nc">&nbsp;			visitor.end();</b>
&nbsp;		}
<b class="nc">&nbsp;		handler.endRDF();</b>
&nbsp;	}
&nbsp;
&nbsp;	public void render(ParsedDescribeQuery query, RDFHandler handler) throws RDFHandlerException {
<b class="nc">&nbsp;		handler.startRDF();</b>
<b class="nc">&nbsp;		Resource querySubj = valueFactory.createBNode();</b>
<b class="nc">&nbsp;		handler.handleStatement(valueFactory.createStatement(querySubj, RDF.TYPE, SP.DESCRIBE_CLASS));</b>
<b class="nc">&nbsp;		if (output.text) {</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(querySubj, SP.TEXT_PROPERTY,</b>
<b class="nc">&nbsp;					valueFactory.createLiteral(query.getSourceString())));</b>
&nbsp;		}
<b class="nc">&nbsp;		if (output.rdf) {</b>
<b class="nc">&nbsp;			TupleExpr expr = query.getTupleExpr();</b>
<b class="nc">&nbsp;			SpinVisitor visitor = new DescribeVisitor(handler, querySubj, query.getDataset());</b>
<b class="nc">&nbsp;			expr.visit(visitor);</b>
<b class="nc">&nbsp;			visitor.end();</b>
&nbsp;		}
<b class="nc">&nbsp;		handler.endRDF();</b>
&nbsp;	}
&nbsp;
&nbsp;	public void render(ParsedGraphQuery query, RDFHandler handler) throws RDFHandlerException {
<b class="nc">&nbsp;		handler.startRDF();</b>
<b class="nc">&nbsp;		Resource querySubj = valueFactory.createBNode();</b>
<b class="nc">&nbsp;		handler.handleStatement(valueFactory.createStatement(querySubj, RDF.TYPE, SP.CONSTRUCT_CLASS));</b>
<b class="nc">&nbsp;		if (output.text) {</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(querySubj, SP.TEXT_PROPERTY,</b>
<b class="nc">&nbsp;					valueFactory.createLiteral(query.getSourceString())));</b>
&nbsp;		}
<b class="nc">&nbsp;		if (output.rdf) {</b>
<b class="nc">&nbsp;			TupleExpr expr = query.getTupleExpr();</b>
<b class="nc">&nbsp;			SpinVisitor visitor = new ConstructVisitor(handler, querySubj, query.getDataset());</b>
<b class="nc">&nbsp;			expr.visit(visitor);</b>
<b class="nc">&nbsp;			visitor.end();</b>
&nbsp;		}
<b class="nc">&nbsp;		handler.endRDF();</b>
&nbsp;	}
&nbsp;
&nbsp;	public void render(ParsedUpdate update, RDFHandler handler) throws RDFHandlerException {
<b class="nc">&nbsp;		handler.startRDF();</b>
&nbsp;
<b class="nc">&nbsp;		for (Map.Entry&lt;String, String&gt; entry : update.getNamespaces().entrySet()) {</b>
<b class="nc">&nbsp;			handler.handleNamespace(entry.getKey(), entry.getValue());</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
<b class="nc">&nbsp;		String[] sourceStrings = update.getSourceString().split(&quot;\\s*;\\s*&quot;);</b>
<b class="nc">&nbsp;		List&lt;UpdateExpr&gt; updateExprs = update.getUpdateExprs();</b>
<b class="nc">&nbsp;		Map&lt;UpdateExpr, Dataset&gt; datasets = update.getDatasetMapping();</b>
<b class="nc">&nbsp;		for (int i = 0; i &lt; updateExprs.size(); i++) {</b>
<b class="nc">&nbsp;			UpdateExpr updateExpr = updateExprs.get(i);</b>
<b class="nc">&nbsp;			Resource updateSubj = valueFactory.createBNode();</b>
<b class="nc">&nbsp;			Dataset dataset = datasets.get(updateExpr);</b>
&nbsp;			IRI updateClass;
<b class="nc">&nbsp;			if (updateExpr instanceof Modify) {</b>
<b class="nc">&nbsp;				Modify modify = (Modify) updateExpr;</b>
<b class="nc">&nbsp;				if (modify.getInsertExpr() == null &amp;&amp; modify.getWhereExpr().equals(modify.getDeleteExpr())) {</b>
<b class="nc">&nbsp;					updateClass = SP.DELETE_WHERE_CLASS;</b>
&nbsp;				} else {
<b class="nc">&nbsp;					updateClass = SP.MODIFY_CLASS;</b>
&nbsp;				}
<b class="nc">&nbsp;			} else if (updateExpr instanceof InsertData) {</b>
<b class="nc">&nbsp;				updateClass = SP.INSERT_DATA_CLASS;</b>
<b class="nc">&nbsp;			} else if (updateExpr instanceof DeleteData) {</b>
<b class="nc">&nbsp;				updateClass = SP.DELETE_DATA_CLASS;</b>
<b class="nc">&nbsp;			} else if (updateExpr instanceof Load) {</b>
<b class="nc">&nbsp;				updateClass = SP.LOAD_CLASS;</b>
<b class="nc">&nbsp;			} else if (updateExpr instanceof Clear) {</b>
<b class="nc">&nbsp;				updateClass = SP.CLEAR_CLASS;</b>
<b class="nc">&nbsp;			} else if (updateExpr instanceof Create) {</b>
<b class="nc">&nbsp;				updateClass = SP.CREATE_CLASS;</b>
&nbsp;			} else {
<b class="nc">&nbsp;				throw new RDFHandlerException(&quot;Unrecognised UpdateExpr: &quot; + updateExpr.getClass());</b>
&nbsp;			}
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(updateSubj, RDF.TYPE, updateClass));</b>
<b class="nc">&nbsp;			if (output.text) {</b>
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(updateSubj, SP.TEXT_PROPERTY,</b>
<b class="nc">&nbsp;						valueFactory.createLiteral(sourceStrings[i])));</b>
&nbsp;			}
<b class="nc">&nbsp;			if (output.rdf) {</b>
<b class="nc">&nbsp;				SpinVisitor visitor = new SpinVisitor(handler, null, updateSubj, dataset);</b>
<b class="nc">&nbsp;				updateExpr.visit(visitor);</b>
<b class="nc">&nbsp;				visitor.end();</b>
&nbsp;			}
&nbsp;		}
<b class="nc">&nbsp;		handler.endRDF();</b>
&nbsp;	}
&nbsp;
&nbsp;	private class AskVisitor extends SpinVisitor {
&nbsp;
<b class="nc">&nbsp;		AskVisitor(RDFHandler handler, Resource list, Dataset dataset) {</b>
<b class="nc">&nbsp;			super(handler, list, null, dataset);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Slice node) throws RDFHandlerException {
<b class="nc">&nbsp;			if (!isSubQuery) { // ignore root slice</b>
<b class="nc">&nbsp;				node.getArg().visit(this);</b>
&nbsp;			} else {
<b class="nc">&nbsp;				super.meet(node);</b>
&nbsp;			}
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private class DescribeVisitor extends SpinVisitor {
&nbsp;
<b class="nc">&nbsp;		DescribeVisitor(RDFHandler handler, Resource subject, Dataset dataset) {</b>
<b class="nc">&nbsp;			super(handler, null, subject, dataset);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(ProjectionElemList node) throws RDFHandlerException {
<b class="nc">&nbsp;			if (isSubQuery) {</b>
<b class="nc">&nbsp;				super.meet(node);</b>
&nbsp;			} else {
<b class="nc">&nbsp;				Resource elemListBNode = valueFactory.createBNode();</b>
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(subject, SP.RESULT_NODES_PROPERTY, elemListBNode));</b>
<b class="nc">&nbsp;				ListContext ctx = newList(elemListBNode);</b>
<b class="nc">&nbsp;				meetNode(node);</b>
<b class="nc">&nbsp;				endList(ctx);</b>
&nbsp;			}
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private class ConstructVisitor extends SpinVisitor {
&nbsp;
<b class="nc">&nbsp;		ConstructVisitor(RDFHandler handler, Resource subject, Dataset dataset) {</b>
<b class="nc">&nbsp;			super(handler, null, subject, dataset);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Reduced node) throws RDFHandlerException {
<b class="nc">&nbsp;			if (!isSubQuery) { // ignore root reduced</b>
<b class="nc">&nbsp;				node.getArg().visit(this);</b>
&nbsp;			} else {
<b class="nc">&nbsp;				super.meet(node);</b>
&nbsp;			}
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(ProjectionElemList node) throws RDFHandlerException {
<b class="nc">&nbsp;			if (isSubQuery) {</b>
<b class="nc">&nbsp;				super.meet(node);</b>
<b class="nc">&nbsp;			} else if (isMultiProjection) {</b>
<b class="nc">&nbsp;				listEntry();</b>
<b class="nc">&nbsp;				meetNode(node);</b>
&nbsp;			} else {
<b class="nc">&nbsp;				ListContext ctx = startTemplateList();</b>
<b class="nc">&nbsp;				listEntry();</b>
<b class="nc">&nbsp;				meetNode(node);</b>
<b class="nc">&nbsp;				endTemplateList(ctx);</b>
&nbsp;			}
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(ProjectionElem node) throws RDFHandlerException {
<b class="nc">&nbsp;			if (isSubQuery) {</b>
<b class="nc">&nbsp;				super.meet(node);</b>
&nbsp;			} else {
<b class="nc">&nbsp;				String varName = node.getName();</b>
<b class="nc">&nbsp;				ValueExpr valueExpr = inlineBindings.getValueExpr(varName);</b>
<b class="nc">&nbsp;				Value value = (valueExpr instanceof ValueConstant) ? ((ValueConstant) valueExpr).getValue()</b>
<b class="nc">&nbsp;						: getVar(varName);</b>
<b class="nc">&nbsp;				String targetName = node.getProjectionAlias().orElse(null);</b>
&nbsp;				IRI pred;
<b class="nc">&nbsp;				if (&quot;subject&quot;.equals(targetName)) {</b>
<b class="nc">&nbsp;					pred = SP.SUBJECT_PROPERTY;</b>
<b class="nc">&nbsp;				} else if (&quot;predicate&quot;.equals(targetName)) {</b>
<b class="nc">&nbsp;					pred = SP.PREDICATE_PROPERTY;</b>
<b class="nc">&nbsp;				} else if (&quot;object&quot;.equals(targetName)) {</b>
<b class="nc">&nbsp;					pred = SP.OBJECT_PROPERTY;</b>
&nbsp;				} else {
<b class="nc">&nbsp;					throw new AssertionError(&quot;Unexpected ProjectionElem: &quot; + node);</b>
&nbsp;				}
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(subject, pred, value));</b>
&nbsp;			}
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private class SpinVisitor extends QueryModelVisitorBase&lt;RDFHandlerException&gt; {
&nbsp;
&nbsp;		final RDFHandler handler;
&nbsp;
&nbsp;		final Dataset dataset;
&nbsp;
<b class="nc">&nbsp;		final Map&lt;String, BNode&gt; varBNodes = new HashMap&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;		final Map&lt;String, ListContext&gt; namedGraphLists = new HashMap&lt;&gt;();</b>
&nbsp;
&nbsp;		ExtensionContext inlineBindings;
&nbsp;
&nbsp;		Resource list;
&nbsp;
&nbsp;		Resource subject;
&nbsp;
&nbsp;		IRI predicate;
&nbsp;
&nbsp;		ListContext namedGraphContext;
&nbsp;
&nbsp;		boolean isMultiProjection;
&nbsp;
&nbsp;		boolean isSubQuery;
&nbsp;
&nbsp;		boolean hasGroup;
&nbsp;
<b class="nc">&nbsp;		SpinVisitor(RDFHandler handler, Resource list, Resource subject, Dataset dataset) {</b>
<b class="nc">&nbsp;			this.handler = handler;</b>
<b class="nc">&nbsp;			this.list = list;</b>
<b class="nc">&nbsp;			this.subject = subject;</b>
<b class="nc">&nbsp;			this.dataset = dataset;</b>
&nbsp;		}
&nbsp;
&nbsp;		private ExtensionContext meetExtension(TupleExpr expr) {
<b class="nc">&nbsp;			ExtensionContext extVisitor = new ExtensionContext();</b>
<b class="nc">&nbsp;			expr.visit(extVisitor);</b>
<b class="nc">&nbsp;			ExtensionContext oldInlineBindings = inlineBindings;</b>
<b class="nc">&nbsp;			inlineBindings = (extVisitor.extension) != null ? extVisitor : null;</b>
<b class="nc">&nbsp;			return oldInlineBindings;</b>
&nbsp;		}
&nbsp;
&nbsp;		ListContext save() {
<b class="nc">&nbsp;			return new ListContext(list, subject);</b>
&nbsp;		}
&nbsp;
&nbsp;		void update(ListContext ctx) {
<b class="nc">&nbsp;			ctx.list = list;</b>
<b class="nc">&nbsp;			ctx.subject = subject;</b>
&nbsp;		}
&nbsp;
&nbsp;		void restore(ListContext ctx) {
<b class="nc">&nbsp;			list = ctx.list;</b>
<b class="nc">&nbsp;			subject = ctx.subject;</b>
&nbsp;		}
&nbsp;
&nbsp;		ListContext newList(Resource res) {
<b class="nc">&nbsp;			ListContext ctx = save();</b>
<b class="nc">&nbsp;			list = res;</b>
<b class="nc">&nbsp;			subject = null;</b>
<b class="nc">&nbsp;			return ctx;</b>
&nbsp;		}
&nbsp;
&nbsp;		void listEntry() throws RDFHandlerException {
<b class="nc">&nbsp;			listEntry(null);</b>
&nbsp;		}
&nbsp;
&nbsp;		void listEntry(Value entry) throws RDFHandlerException {
<b class="nc">&nbsp;			if (list == null) {</b>
<b class="nc">&nbsp;				list = valueFactory.createBNode();</b>
&nbsp;			}
<b class="nc">&nbsp;			if (subject != null) {</b>
<b class="nc">&nbsp;				nextListEntry(valueFactory.createBNode());</b>
&nbsp;			}
<b class="nc">&nbsp;			if (entry == null) {</b>
<b class="nc">&nbsp;				entry = valueFactory.createBNode();</b>
&nbsp;			}
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(list, RDF.FIRST, entry));</b>
<b class="nc">&nbsp;			if (entry instanceof Resource) {</b>
<b class="nc">&nbsp;				subject = (Resource) entry;</b>
&nbsp;			} else {
&nbsp;				// in this case, actual value doesn&#39;t matter, only that it is
&nbsp;				// not null
<b class="nc">&nbsp;				subject = RDF.NIL;</b>
&nbsp;			}
&nbsp;		}
&nbsp;
&nbsp;		void endList(ListContext ctx) throws RDFHandlerException {
<b class="nc">&nbsp;			nextListEntry(RDF.NIL);</b>
<b class="nc">&nbsp;			if (ctx != null) {</b>
<b class="nc">&nbsp;				restore(ctx);</b>
&nbsp;			}
&nbsp;		}
&nbsp;
&nbsp;		private void nextListEntry(Resource nextEntry) throws RDFHandlerException {
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(list, RDF.REST, nextEntry));</b>
<b class="nc">&nbsp;			list = nextEntry;</b>
<b class="nc">&nbsp;			subject = null;</b>
&nbsp;		}
&nbsp;
&nbsp;		Resource getVar(String name) throws RDFHandlerException {
<b class="nc">&nbsp;			Resource res = (wellKnownVars != null) ? wellKnownVars.apply(name) : null;</b>
<b class="nc">&nbsp;			if (res == null) {</b>
<b class="nc">&nbsp;				res = varBNodes.get(name);</b>
<b class="nc">&nbsp;				if (res == null) {</b>
<b class="nc">&nbsp;					BNode bnode = valueFactory.createBNode(name);</b>
<b class="nc">&nbsp;					varBNodes.put(name, bnode);</b>
<b class="nc">&nbsp;					res = bnode;</b>
&nbsp;				}
&nbsp;			}
<b class="nc">&nbsp;			return res;</b>
&nbsp;		}
&nbsp;
&nbsp;		ListContext getNamedGraph(Var context) throws RDFHandlerException {
&nbsp;			ListContext currentCtx;
<b class="nc">&nbsp;			namedGraphContext = namedGraphLists.get(context.getName());</b>
<b class="nc">&nbsp;			if (namedGraphContext == null) {</b>
<b class="nc">&nbsp;				listEntry();</b>
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.NAMED_GRAPH_CLASS));</b>
<b class="nc">&nbsp;				predicate = SP.GRAPH_NAME_NODE_PROPERTY;</b>
<b class="nc">&nbsp;				context.visit(this);</b>
<b class="nc">&nbsp;				Resource elementsList = valueFactory.createBNode();</b>
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(subject, SP.ELEMENTS_PROPERTY, elementsList));</b>
<b class="nc">&nbsp;				currentCtx = newList(elementsList);</b>
<b class="nc">&nbsp;				namedGraphContext = save();</b>
<b class="nc">&nbsp;				namedGraphLists.put(context.getName(), namedGraphContext);</b>
<b class="nc">&nbsp;			} else {</b>
<b class="nc">&nbsp;				currentCtx = save();</b>
<b class="nc">&nbsp;				restore(namedGraphContext);</b>
&nbsp;			}
<b class="nc">&nbsp;			return currentCtx;</b>
&nbsp;		}
&nbsp;
&nbsp;		void restoreNamedGraph(ListContext ctx) {
<b class="nc">&nbsp;			update(namedGraphContext);</b>
<b class="nc">&nbsp;			restore(ctx);</b>
&nbsp;		}
&nbsp;
&nbsp;		public void end() throws RDFHandlerException {
<b class="nc">&nbsp;			if (list != null) {</b>
<b class="nc">&nbsp;				endList(null);</b>
&nbsp;			}
&nbsp;
&nbsp;			// end any named graph lists
<b class="nc">&nbsp;			for (ListContext elementsCtx : namedGraphLists.values()) {</b>
<b class="nc">&nbsp;				restore(elementsCtx);</b>
<b class="nc">&nbsp;				endList(null);</b>
<b class="nc">&nbsp;			}</b>
&nbsp;
&nbsp;			// output all the var BNodes together to give a more friendlier RDF
&nbsp;			// structure
<b class="nc">&nbsp;			for (Map.Entry&lt;String, BNode&gt; entry : varBNodes.entrySet()) {</b>
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(entry.getValue(), SP.VAR_NAME_PROPERTY,</b>
<b class="nc">&nbsp;						valueFactory.createLiteral(entry.getKey())));</b>
<b class="nc">&nbsp;			}</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(MultiProjection node) throws RDFHandlerException {
<b class="nc">&nbsp;			ExtensionContext oldInlineBindings = meetExtension(node.getArg());</b>
<b class="nc">&nbsp;			ListContext ctx = startTemplateList();</b>
<b class="nc">&nbsp;			isMultiProjection = true;</b>
<b class="nc">&nbsp;			for (ProjectionElemList proj : node.getProjections()) {</b>
<b class="nc">&nbsp;				proj.visit(this);</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;			endTemplateList(ctx);</b>
<b class="nc">&nbsp;			isMultiProjection = false;</b>
<b class="nc">&nbsp;			visitWhere(node.getArg());</b>
<b class="nc">&nbsp;			inlineBindings = oldInlineBindings;</b>
&nbsp;		}
&nbsp;
&nbsp;		ListContext startTemplateList() throws RDFHandlerException {
<b class="nc">&nbsp;			Resource elemListBNode = valueFactory.createBNode();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, SP.TEMPLATES_PROPERTY, elemListBNode));</b>
<b class="nc">&nbsp;			return newList(elemListBNode);</b>
&nbsp;		}
&nbsp;
&nbsp;		void endTemplateList(ListContext ctx) throws RDFHandlerException {
<b class="nc">&nbsp;			endList(ctx);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Projection node) throws RDFHandlerException {
<b class="nc">&nbsp;			ExtensionContext oldInlineBindings = meetExtension(node.getArg());</b>
<b class="nc">&nbsp;			if (isSubQuery) {</b>
<b class="nc">&nbsp;				listEntry();</b>
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.SUB_QUERY_CLASS));</b>
<b class="nc">&nbsp;				Resource queryBNode = valueFactory.createBNode();</b>
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(subject, SP.QUERY_PROPERTY, queryBNode));</b>
<b class="nc">&nbsp;				subject = queryBNode;</b>
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.SELECT_CLASS));</b>
&nbsp;			}
<b class="nc">&nbsp;			node.getProjectionElemList().visit(this);</b>
<b class="nc">&nbsp;			visitWhere(node.getArg());</b>
<b class="nc">&nbsp;			node.getArg().visit(new GroupVisitor());</b>
<b class="nc">&nbsp;			node.getArg().visit(new OrderVisitor());</b>
<b class="nc">&nbsp;			inlineBindings = oldInlineBindings;</b>
<b class="nc">&nbsp;			hasGroup = false;</b>
&nbsp;		}
&nbsp;
&nbsp;		private void visitWhere(TupleExpr where) throws RDFHandlerException {
<b class="nc">&nbsp;			Resource whereBNode = valueFactory.createBNode();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, SP.WHERE_PROPERTY, whereBNode));</b>
&nbsp;
<b class="nc">&nbsp;			isSubQuery = true; // further projection elements are for</b>
&nbsp;			// sub-queries
&nbsp;
<b class="nc">&nbsp;			ListContext ctx = newList(whereBNode);</b>
<b class="nc">&nbsp;			where.visit(this);</b>
<b class="nc">&nbsp;			endList(ctx);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(ProjectionElemList node) throws RDFHandlerException {
<b class="nc">&nbsp;			Resource elemListBNode = valueFactory.createBNode();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, SP.RESULT_VARIABLES_PROPERTY, elemListBNode));</b>
<b class="nc">&nbsp;			ListContext ctx = newList(elemListBNode);</b>
<b class="nc">&nbsp;			super.meet(node);</b>
<b class="nc">&nbsp;			endList(ctx);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(ProjectionElem node) throws RDFHandlerException {
<b class="nc">&nbsp;			ValueExpr valueExpr = null;</b>
<b class="nc">&nbsp;			if (inlineBindings != null) {</b>
<b class="nc">&nbsp;				String varName = node.getName();</b>
<b class="nc">&nbsp;				valueExpr = inlineBindings.getValueExpr(varName);</b>
&nbsp;			}
<b class="nc">&nbsp;			Resource targetVar = getVar(node.getProjectionAlias().orElse(node.getName()));</b>
<b class="nc">&nbsp;			listEntry(targetVar);</b>
<b class="nc">&nbsp;			if (valueExpr != null &amp;&amp; !(valueExpr instanceof Var)) {</b>
<b class="nc">&nbsp;				Resource currentSubj = subject;</b>
<b class="nc">&nbsp;				subject = valueFactory.createBNode();</b>
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(targetVar, SP.EXPRESSION_PROPERTY, subject));</b>
<b class="nc">&nbsp;				valueExpr.visit(new ExtensionVisitor());</b>
<b class="nc">&nbsp;				subject = currentSubj;</b>
&nbsp;			}
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Extension node) throws RDFHandlerException {
<b class="nc">&nbsp;			if (inlineBindings != null &amp;&amp; inlineBindings.extension == node) {</b>
&nbsp;				// this is the first Extension node and has already been handled
&nbsp;				// by meetExtension()
&nbsp;				// to produce inline bindings in SELECT so we can skip it here
<b class="nc">&nbsp;				node.getArg().visit(this);</b>
&nbsp;			} else {
&nbsp;				// any further Extension nodes produce BIND() clauses
<b class="nc">&nbsp;				node.getArg().visit(this);</b>
<b class="nc">&nbsp;				for (ExtensionElem elem : node.getElements()) {</b>
<b class="nc">&nbsp;					elem.visit(this);</b>
<b class="nc">&nbsp;				}</b>
&nbsp;			}
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(ExtensionElem node) throws RDFHandlerException {
<b class="nc">&nbsp;			listEntry();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.BIND_CLASS));</b>
<b class="nc">&nbsp;			Resource var = getVar(node.getName());</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, SP.VARIABLE_PROPERTY, var));</b>
<b class="nc">&nbsp;			meet(node.getExpr());</b>
&nbsp;		}
&nbsp;
&nbsp;		private void meet(ValueExpr node) throws RDFHandlerException {
<b class="nc">&nbsp;			predicate = SP.EXPRESSION_PROPERTY;</b>
<b class="nc">&nbsp;			ListContext ctx = save();</b>
<b class="nc">&nbsp;			list = null;</b>
<b class="nc">&nbsp;			node.visit(this);</b>
<b class="nc">&nbsp;			restore(ctx);</b>
&nbsp;		}
&nbsp;
&nbsp;		private void flushPendingStatement() throws RDFHandlerException {
<b class="nc">&nbsp;			if (predicate != null) {</b>
<b class="nc">&nbsp;				Resource res = valueFactory.createBNode();</b>
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(subject, predicate, res));</b>
<b class="nc">&nbsp;				subject = res;</b>
&nbsp;			}
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(StatementPattern node) throws RDFHandlerException {
<b class="nc">&nbsp;			ListContext ctxList = null;</b>
<b class="nc">&nbsp;			if (StatementPattern.Scope.NAMED_CONTEXTS == node.getScope()) {</b>
<b class="nc">&nbsp;				ctxList = getNamedGraph(node.getContextVar());</b>
&nbsp;			}
<b class="nc">&nbsp;			listEntry();</b>
<b class="nc">&nbsp;			predicate = SP.SUBJECT_PROPERTY;</b>
<b class="nc">&nbsp;			node.getSubjectVar().visit(this);</b>
<b class="nc">&nbsp;			predicate = SP.PREDICATE_PROPERTY;</b>
<b class="nc">&nbsp;			node.getPredicateVar().visit(this);</b>
<b class="nc">&nbsp;			predicate = SP.OBJECT_PROPERTY;</b>
<b class="nc">&nbsp;			node.getObjectVar().visit(this);</b>
<b class="nc">&nbsp;			predicate = null;</b>
<b class="nc">&nbsp;			if (ctxList != null) {</b>
<b class="nc">&nbsp;				restoreNamedGraph(ctxList);</b>
&nbsp;			}
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Var node) throws RDFHandlerException {
&nbsp;			Value value;
<b class="nc">&nbsp;			if (node.isConstant()) {</b>
<b class="nc">&nbsp;				value = node.getValue();</b>
&nbsp;			} else {
<b class="nc">&nbsp;				value = getVar(node.getName());</b>
&nbsp;			}
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, predicate, value));</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(ValueConstant node) throws RDFHandlerException {
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, predicate, node.getValue()));</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Filter node) throws RDFHandlerException {
<b class="nc">&nbsp;			hasGroup = false;</b>
<b class="nc">&nbsp;			node.getArg().visit(this);</b>
<b class="nc">&nbsp;			if (!hasGroup) {</b>
<b class="nc">&nbsp;				listEntry();</b>
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.FILTER_CLASS));</b>
<b class="nc">&nbsp;				meet(node.getCondition());</b>
&nbsp;			}
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Compare node) throws RDFHandlerException {
<b class="nc">&nbsp;			Resource currentSubj = subject;</b>
<b class="nc">&nbsp;			flushPendingStatement();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, toValue(node.getOperator())));</b>
<b class="nc">&nbsp;			predicate = SP.ARG1_PROPERTY;</b>
<b class="nc">&nbsp;			node.getLeftArg().visit(this);</b>
<b class="nc">&nbsp;			predicate = SP.ARG2_PROPERTY;</b>
<b class="nc">&nbsp;			node.getRightArg().visit(this);</b>
<b class="nc">&nbsp;			subject = currentSubj;</b>
<b class="nc">&nbsp;			predicate = null;</b>
&nbsp;		}
&nbsp;
&nbsp;		private Value toValue(CompareOp op) {
<b class="nc">&nbsp;			switch (op) {</b>
&nbsp;			case EQ:
<b class="nc">&nbsp;				return SP.EQ;</b>
&nbsp;			case NE:
<b class="nc">&nbsp;				return SP.NE;</b>
&nbsp;			case LT:
<b class="nc">&nbsp;				return SP.LT;</b>
&nbsp;			case LE:
<b class="nc">&nbsp;				return SP.LE;</b>
&nbsp;			case GE:
<b class="nc">&nbsp;				return SP.GE;</b>
&nbsp;			case GT:
<b class="nc">&nbsp;				return SP.GT;</b>
&nbsp;			}
<b class="nc">&nbsp;			throw new AssertionError(&quot;Unrecognised CompareOp: &quot; + op);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(MathExpr node) throws RDFHandlerException {
<b class="nc">&nbsp;			Resource currentSubj = subject;</b>
<b class="nc">&nbsp;			flushPendingStatement();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, toValue(node.getOperator())));</b>
<b class="nc">&nbsp;			predicate = SP.ARG1_PROPERTY;</b>
<b class="nc">&nbsp;			node.getLeftArg().visit(this);</b>
<b class="nc">&nbsp;			predicate = SP.ARG2_PROPERTY;</b>
<b class="nc">&nbsp;			node.getRightArg().visit(this);</b>
<b class="nc">&nbsp;			subject = currentSubj;</b>
<b class="nc">&nbsp;			predicate = null;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(And node) throws RDFHandlerException {
<b class="nc">&nbsp;			Resource currentSubj = subject;</b>
<b class="nc">&nbsp;			flushPendingStatement();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.AND));</b>
<b class="nc">&nbsp;			predicate = SP.ARG1_PROPERTY;</b>
<b class="nc">&nbsp;			node.getLeftArg().visit(this);</b>
<b class="nc">&nbsp;			predicate = SP.ARG2_PROPERTY;</b>
<b class="nc">&nbsp;			node.getRightArg().visit(this);</b>
<b class="nc">&nbsp;			subject = currentSubj;</b>
<b class="nc">&nbsp;			predicate = null;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Or node) throws RDFHandlerException {
<b class="nc">&nbsp;			Resource currentSubj = subject;</b>
<b class="nc">&nbsp;			flushPendingStatement();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.OR));</b>
<b class="nc">&nbsp;			predicate = SP.ARG1_PROPERTY;</b>
<b class="nc">&nbsp;			node.getLeftArg().visit(this);</b>
<b class="nc">&nbsp;			predicate = SP.ARG2_PROPERTY;</b>
<b class="nc">&nbsp;			node.getRightArg().visit(this);</b>
<b class="nc">&nbsp;			subject = currentSubj;</b>
<b class="nc">&nbsp;			predicate = null;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Bound node) throws RDFHandlerException {
<b class="nc">&nbsp;			Resource currentSubj = subject;</b>
<b class="nc">&nbsp;			flushPendingStatement();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.BOUND));</b>
<b class="nc">&nbsp;			predicate = SP.ARG1_PROPERTY;</b>
<b class="nc">&nbsp;			node.getArg().visit(this);</b>
<b class="nc">&nbsp;			subject = currentSubj;</b>
<b class="nc">&nbsp;			predicate = null;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(If node) throws RDFHandlerException {
<b class="nc">&nbsp;			Resource currentSubj = subject;</b>
<b class="nc">&nbsp;			flushPendingStatement();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.IF));</b>
<b class="nc">&nbsp;			predicate = SP.ARG1_PROPERTY;</b>
<b class="nc">&nbsp;			node.getCondition().visit(this);</b>
<b class="nc">&nbsp;			predicate = SP.ARG2_PROPERTY;</b>
<b class="nc">&nbsp;			node.getResult().visit(this);</b>
<b class="nc">&nbsp;			predicate = SP.ARG3_PROPERTY;</b>
<b class="nc">&nbsp;			node.getAlternative().visit(this);</b>
<b class="nc">&nbsp;			subject = currentSubj;</b>
<b class="nc">&nbsp;			predicate = null;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Coalesce node) throws RDFHandlerException {
<b class="nc">&nbsp;			Resource currentSubj = subject;</b>
<b class="nc">&nbsp;			flushPendingStatement();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.COALESCE));</b>
<b class="nc">&nbsp;			List&lt;ValueExpr&gt; args = node.getArguments();</b>
<b class="nc">&nbsp;			for (int i = 0; i &lt; args.size(); i++) {</b>
<b class="nc">&nbsp;				predicate = toArgProperty(i + 1);</b>
<b class="nc">&nbsp;				args.get(i).visit(this);</b>
&nbsp;			}
<b class="nc">&nbsp;			subject = currentSubj;</b>
<b class="nc">&nbsp;			predicate = null;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(IsURI node) throws RDFHandlerException {
<b class="nc">&nbsp;			Resource currentSubj = subject;</b>
<b class="nc">&nbsp;			flushPendingStatement();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.IS_IRI));</b>
<b class="nc">&nbsp;			predicate = SP.ARG1_PROPERTY;</b>
<b class="nc">&nbsp;			node.getArg().visit(this);</b>
<b class="nc">&nbsp;			subject = currentSubj;</b>
<b class="nc">&nbsp;			predicate = null;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(IsBNode node) throws RDFHandlerException {
<b class="nc">&nbsp;			Resource currentSubj = subject;</b>
<b class="nc">&nbsp;			flushPendingStatement();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.IS_BLANK));</b>
<b class="nc">&nbsp;			predicate = SP.ARG1_PROPERTY;</b>
<b class="nc">&nbsp;			node.getArg().visit(this);</b>
<b class="nc">&nbsp;			subject = currentSubj;</b>
<b class="nc">&nbsp;			predicate = null;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(IsLiteral node) throws RDFHandlerException {
<b class="nc">&nbsp;			Resource currentSubj = subject;</b>
<b class="nc">&nbsp;			flushPendingStatement();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.IS_LITERAL));</b>
<b class="nc">&nbsp;			predicate = SP.ARG1_PROPERTY;</b>
<b class="nc">&nbsp;			node.getArg().visit(this);</b>
<b class="nc">&nbsp;			subject = currentSubj;</b>
<b class="nc">&nbsp;			predicate = null;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(IsNumeric node) throws RDFHandlerException {
<b class="nc">&nbsp;			Resource currentSubj = subject;</b>
<b class="nc">&nbsp;			flushPendingStatement();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.IS_NUMERIC));</b>
<b class="nc">&nbsp;			predicate = SP.ARG1_PROPERTY;</b>
<b class="nc">&nbsp;			node.getArg().visit(this);</b>
<b class="nc">&nbsp;			subject = currentSubj;</b>
<b class="nc">&nbsp;			predicate = null;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Str node) throws RDFHandlerException {
<b class="nc">&nbsp;			Resource currentSubj = subject;</b>
<b class="nc">&nbsp;			flushPendingStatement();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.STR));</b>
<b class="nc">&nbsp;			predicate = SP.ARG1_PROPERTY;</b>
<b class="nc">&nbsp;			node.getArg().visit(this);</b>
<b class="nc">&nbsp;			subject = currentSubj;</b>
<b class="nc">&nbsp;			predicate = null;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Lang node) throws RDFHandlerException {
<b class="nc">&nbsp;			Resource currentSubj = subject;</b>
<b class="nc">&nbsp;			flushPendingStatement();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.LANG));</b>
<b class="nc">&nbsp;			predicate = SP.ARG1_PROPERTY;</b>
<b class="nc">&nbsp;			node.getArg().visit(this);</b>
<b class="nc">&nbsp;			subject = currentSubj;</b>
<b class="nc">&nbsp;			predicate = null;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Datatype node) throws RDFHandlerException {
<b class="nc">&nbsp;			Resource currentSubj = subject;</b>
<b class="nc">&nbsp;			flushPendingStatement();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.DATATYPE));</b>
<b class="nc">&nbsp;			predicate = SP.ARG1_PROPERTY;</b>
<b class="nc">&nbsp;			node.getArg().visit(this);</b>
<b class="nc">&nbsp;			subject = currentSubj;</b>
<b class="nc">&nbsp;			predicate = null;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(IRIFunction node) throws RDFHandlerException {
<b class="nc">&nbsp;			Resource currentSubj = subject;</b>
<b class="nc">&nbsp;			flushPendingStatement();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.IRI));</b>
<b class="nc">&nbsp;			predicate = SP.ARG1_PROPERTY;</b>
<b class="nc">&nbsp;			node.getArg().visit(this);</b>
<b class="nc">&nbsp;			subject = currentSubj;</b>
<b class="nc">&nbsp;			predicate = null;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(BNodeGenerator node) throws RDFHandlerException {
<b class="nc">&nbsp;			Resource currentSubj = subject;</b>
<b class="nc">&nbsp;			flushPendingStatement();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.BNODE));</b>
<b class="nc">&nbsp;			if (node.getNodeIdExpr() != null) {</b>
<b class="nc">&nbsp;				predicate = SP.ARG1_PROPERTY;</b>
<b class="nc">&nbsp;				node.getNodeIdExpr().visit(this);</b>
&nbsp;			}
<b class="nc">&nbsp;			subject = currentSubj;</b>
<b class="nc">&nbsp;			predicate = null;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Regex node) throws RDFHandlerException {
<b class="nc">&nbsp;			Resource currentSubj = subject;</b>
<b class="nc">&nbsp;			flushPendingStatement();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.REGEX));</b>
<b class="nc">&nbsp;			predicate = SP.ARG1_PROPERTY;</b>
<b class="nc">&nbsp;			node.getLeftArg().visit(this);</b>
<b class="nc">&nbsp;			predicate = SP.ARG2_PROPERTY;</b>
<b class="nc">&nbsp;			node.getRightArg().visit(this);</b>
<b class="nc">&nbsp;			subject = currentSubj;</b>
<b class="nc">&nbsp;			predicate = null;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(LocalName node) throws RDFHandlerException {
<b class="nc">&nbsp;			Resource currentSubj = subject;</b>
<b class="nc">&nbsp;			flushPendingStatement();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, AFN.LOCALNAME));</b>
<b class="nc">&nbsp;			predicate = SP.ARG1_PROPERTY;</b>
<b class="nc">&nbsp;			node.getArg().visit(this);</b>
<b class="nc">&nbsp;			subject = currentSubj;</b>
<b class="nc">&nbsp;			predicate = null;</b>
&nbsp;		}
&nbsp;
&nbsp;		private Value toValue(MathOp op) {
<b class="nc">&nbsp;			switch (op) {</b>
&nbsp;			case PLUS:
<b class="nc">&nbsp;				return SP.ADD;</b>
&nbsp;			case MINUS:
<b class="nc">&nbsp;				return SP.SUB;</b>
&nbsp;			case MULTIPLY:
<b class="nc">&nbsp;				return SP.MUL;</b>
&nbsp;			case DIVIDE:
<b class="nc">&nbsp;				return SP.DIVIDE;</b>
&nbsp;			}
<b class="nc">&nbsp;			throw new AssertionError(&quot;Unrecognised MathOp: &quot; + op);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(FunctionCall node) throws RDFHandlerException {
<b class="nc">&nbsp;			Resource currentSubj = subject;</b>
<b class="nc">&nbsp;			flushPendingStatement();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, toValue(node)));</b>
<b class="nc">&nbsp;			List&lt;ValueExpr&gt; args = node.getArgs();</b>
<b class="nc">&nbsp;			for (int i = 0; i &lt; args.size(); i++) {</b>
<b class="nc">&nbsp;				predicate = toArgProperty(i + 1);</b>
<b class="nc">&nbsp;				args.get(i).visit(this);</b>
&nbsp;			}
<b class="nc">&nbsp;			subject = currentSubj;</b>
<b class="nc">&nbsp;			predicate = null;</b>
&nbsp;		}
&nbsp;
&nbsp;		private Value toValue(FunctionCall node) {
<b class="nc">&nbsp;			String funcName = node.getURI();</b>
<b class="nc">&nbsp;			IRI funcUri = wellKnownFunctions.apply(funcName);</b>
<b class="nc">&nbsp;			if (funcUri == null) {</b>
<b class="nc">&nbsp;				funcUri = valueFactory.createIRI(funcName);</b>
&nbsp;			}
<b class="nc">&nbsp;			return funcUri;</b>
&nbsp;		}
&nbsp;
&nbsp;		private IRI toArgProperty(int i) {
<b class="nc">&nbsp;			switch (i) {</b>
&nbsp;			case 1:
<b class="nc">&nbsp;				return SP.ARG1_PROPERTY;</b>
&nbsp;			case 2:
<b class="nc">&nbsp;				return SP.ARG2_PROPERTY;</b>
&nbsp;			case 3:
<b class="nc">&nbsp;				return SP.ARG3_PROPERTY;</b>
&nbsp;			case 4:
<b class="nc">&nbsp;				return SP.ARG4_PROPERTY;</b>
&nbsp;			case 5:
<b class="nc">&nbsp;				return SP.ARG5_PROPERTY;</b>
&nbsp;			default:
<b class="nc">&nbsp;				return valueFactory.createIRI(SP.NAMESPACE, &quot;arg&quot; + i);</b>
&nbsp;			}
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Not node) throws RDFHandlerException {
<b class="nc">&nbsp;			if (node.getArg() instanceof Exists) {</b>
<b class="nc">&nbsp;				super.meet(node);</b>
&nbsp;			} else {
<b class="nc">&nbsp;				Resource currentSubj = subject;</b>
<b class="nc">&nbsp;				flushPendingStatement();</b>
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.NOT));</b>
<b class="nc">&nbsp;				predicate = SP.ARG1_PROPERTY;</b>
<b class="nc">&nbsp;				node.getArg().visit(this);</b>
<b class="nc">&nbsp;				subject = currentSubj;</b>
<b class="nc">&nbsp;				predicate = null;</b>
&nbsp;			}
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Exists node) throws RDFHandlerException {
<b class="nc">&nbsp;			Resource currentSubj = subject;</b>
<b class="nc">&nbsp;			flushPendingStatement();</b>
<b class="nc">&nbsp;			Resource op = (node.getParentNode() instanceof Not) ? SP.NOT_EXISTS : SP.EXISTS;</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, op));</b>
<b class="nc">&nbsp;			Resource elementsList = valueFactory.createBNode();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, SP.ELEMENTS_PROPERTY, elementsList));</b>
<b class="nc">&nbsp;			ListContext elementsCtx = newList(elementsList);</b>
<b class="nc">&nbsp;			node.getSubQuery().visit(this);</b>
<b class="nc">&nbsp;			endList(elementsCtx);</b>
<b class="nc">&nbsp;			subject = currentSubj;</b>
<b class="nc">&nbsp;			predicate = null;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Group node) throws RDFHandlerException {
&nbsp;			// skip over GroupElem - leave this to the GroupVisitor later
<b class="nc">&nbsp;			node.getArg().visit(this);</b>
<b class="nc">&nbsp;			hasGroup = true;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Order node) throws RDFHandlerException {
&nbsp;			// skip over OrderElem - leave this to the OrderVisitor later
<b class="nc">&nbsp;			node.getArg().visit(this);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Slice node) throws RDFHandlerException {
<b class="nc">&nbsp;			node.getArg().visit(this);</b>
<b class="nc">&nbsp;			if (node.hasLimit()) {</b>
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(subject, SP.LIMIT_PROPERTY,</b>
<b class="nc">&nbsp;						valueFactory.createLiteral(Long.toString(node.getLimit()), XSD.INTEGER)));</b>
&nbsp;			}
<b class="nc">&nbsp;			if (node.hasOffset()) {</b>
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(subject, SP.OFFSET_PROPERTY,</b>
<b class="nc">&nbsp;						valueFactory.createLiteral(Long.toString(node.getOffset()), XSD.INTEGER)));</b>
&nbsp;			}
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Distinct node) throws RDFHandlerException {
<b class="nc">&nbsp;			node.getArg().visit(this);</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, SP.DISTINCT_PROPERTY, BooleanLiteral.TRUE));</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Reduced node) throws RDFHandlerException {
<b class="nc">&nbsp;			node.getArg().visit(this);</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, SP.REDUCED_PROPERTY, BooleanLiteral.TRUE));</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Join node) throws RDFHandlerException {
<b class="nc">&nbsp;			boolean isGroupGraphPattern = (node.getRightArg() instanceof Join);</b>
<b class="nc">&nbsp;			if (!isGroupGraphPattern) {</b>
<b class="nc">&nbsp;				super.meet(node);</b>
&nbsp;			} else {
<b class="nc">&nbsp;				listEntry();</b>
<b class="nc">&nbsp;				ListContext leftGroupCtx = newList(subject);</b>
<b class="nc">&nbsp;				node.getLeftArg().visit(this);</b>
<b class="nc">&nbsp;				endList(leftGroupCtx);</b>
<b class="nc">&nbsp;				listEntry();</b>
<b class="nc">&nbsp;				ListContext rightGroupCtx = newList(subject);</b>
<b class="nc">&nbsp;				node.getRightArg().visit(this);</b>
<b class="nc">&nbsp;				endList(rightGroupCtx);</b>
&nbsp;			}
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(LeftJoin node) throws RDFHandlerException {
<b class="nc">&nbsp;			node.getLeftArg().visit(this);</b>
<b class="nc">&nbsp;			listEntry();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.OPTIONAL_CLASS));</b>
<b class="nc">&nbsp;			Resource elementsList = valueFactory.createBNode();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, SP.ELEMENTS_PROPERTY, elementsList));</b>
<b class="nc">&nbsp;			ListContext elementsCtx = newList(elementsList);</b>
<b class="nc">&nbsp;			node.getRightArg().visit(this);</b>
<b class="nc">&nbsp;			endList(elementsCtx);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Union node) throws RDFHandlerException {
<b class="nc">&nbsp;			listEntry();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.UNION_CLASS));</b>
<b class="nc">&nbsp;			Resource elementsList = valueFactory.createBNode();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, SP.ELEMENTS_PROPERTY, elementsList));</b>
<b class="nc">&nbsp;			ListContext elementsCtx = newList(elementsList);</b>
<b class="nc">&nbsp;			listEntry();</b>
<b class="nc">&nbsp;			ListContext leftCtx = newList(subject);</b>
<b class="nc">&nbsp;			node.getLeftArg().visit(this);</b>
<b class="nc">&nbsp;			endList(leftCtx);</b>
&nbsp;
<b class="nc">&nbsp;			listEntry();</b>
<b class="nc">&nbsp;			ListContext rightCtx = newList(subject);</b>
<b class="nc">&nbsp;			node.getRightArg().visit(this);</b>
<b class="nc">&nbsp;			endList(rightCtx);</b>
<b class="nc">&nbsp;			endList(elementsCtx);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Difference node) throws RDFHandlerException {
<b class="nc">&nbsp;			node.getLeftArg().visit(this);</b>
<b class="nc">&nbsp;			listEntry();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.MINUS_CLASS));</b>
<b class="nc">&nbsp;			Resource elementsList = valueFactory.createBNode();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, SP.ELEMENTS_PROPERTY, elementsList));</b>
<b class="nc">&nbsp;			ListContext elementsCtx = newList(elementsList);</b>
<b class="nc">&nbsp;			node.getRightArg().visit(this);</b>
<b class="nc">&nbsp;			endList(elementsCtx);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Service node) throws RDFHandlerException {
<b class="nc">&nbsp;			listEntry();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.SERVICE_CLASS));</b>
<b class="nc">&nbsp;			predicate = SP.SERVICE_URI_PROPERTY;</b>
<b class="nc">&nbsp;			node.getServiceRef().visit(this);</b>
<b class="nc">&nbsp;			predicate = null;</b>
<b class="nc">&nbsp;			Resource elementsList = valueFactory.createBNode();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, SP.ELEMENTS_PROPERTY, elementsList));</b>
<b class="nc">&nbsp;			ListContext elementsCtx = newList(elementsList);</b>
<b class="nc">&nbsp;			node.getArg().visit(this);</b>
<b class="nc">&nbsp;			endList(elementsCtx);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(BindingSetAssignment node) throws RDFHandlerException {
<b class="nc">&nbsp;			listEntry();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.VALUES_CLASS));</b>
<b class="nc">&nbsp;			Resource bindingList = valueFactory.createBNode();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, SP.BINDINGS_PROPERTY, bindingList));</b>
<b class="nc">&nbsp;			ListContext bindingCtx = newList(bindingList);</b>
<b class="nc">&nbsp;			List&lt;String&gt; bindingVars = new ArrayList&lt;&gt;(node.getBindingNames());</b>
<b class="nc">&nbsp;			for (BindingSet bs : node.getBindingSets()) {</b>
<b class="nc">&nbsp;				listEntry();</b>
<b class="nc">&nbsp;				ListContext setCtx = newList(subject);</b>
<b class="nc">&nbsp;				for (String varName : bindingVars) {</b>
<b class="nc">&nbsp;					Value v = bs.getValue(varName);</b>
<b class="nc">&nbsp;					if (v == null) {</b>
<b class="nc">&nbsp;						v = SP.UNDEF;</b>
&nbsp;					}
<b class="nc">&nbsp;					listEntry(v);</b>
<b class="nc">&nbsp;				}</b>
<b class="nc">&nbsp;				endList(setCtx);</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;			endList(bindingCtx);</b>
&nbsp;
<b class="nc">&nbsp;			Resource varNameList = valueFactory.createBNode();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, SP.VAR_NAMES_PROPERTY, varNameList));</b>
<b class="nc">&nbsp;			ListContext varnameCtx = newList(varNameList);</b>
<b class="nc">&nbsp;			for (String varName : bindingVars) {</b>
<b class="nc">&nbsp;				listEntry(valueFactory.createLiteral(varName));</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;			endList(varnameCtx);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Modify node) throws RDFHandlerException {
<b class="nc">&nbsp;			TupleExpr insertExpr = node.getInsertExpr();</b>
<b class="nc">&nbsp;			TupleExpr deleteExpr = node.getDeleteExpr();</b>
<b class="nc">&nbsp;			TupleExpr whereExpr = node.getWhereExpr();</b>
<b class="nc">&nbsp;			if (insertExpr == null &amp;&amp; whereExpr.equals(deleteExpr)) {</b>
&nbsp;				// DELETE WHERE
<b class="nc">&nbsp;				visitWhere(whereExpr);</b>
&nbsp;			} else {
<b class="nc">&nbsp;				if (insertExpr != null) {</b>
<b class="nc">&nbsp;					Resource insertList = valueFactory.createBNode();</b>
<b class="nc">&nbsp;					handler.handleStatement(</b>
<b class="nc">&nbsp;							valueFactory.createStatement(subject, SP.INSERT_PATTERN_PROPERTY, insertList));</b>
<b class="nc">&nbsp;					ListContext insertCtx = newList(insertList);</b>
<b class="nc">&nbsp;					insertExpr.visit(this);</b>
<b class="nc">&nbsp;					endList(insertCtx);</b>
&nbsp;				}
<b class="nc">&nbsp;				if (deleteExpr != null) {</b>
<b class="nc">&nbsp;					Resource deleteList = valueFactory.createBNode();</b>
<b class="nc">&nbsp;					handler.handleStatement(</b>
<b class="nc">&nbsp;							valueFactory.createStatement(subject, SP.DELETE_PATTERN_PROPERTY, deleteList));</b>
<b class="nc">&nbsp;					ListContext deleteCtx = newList(deleteList);</b>
<b class="nc">&nbsp;					deleteExpr.visit(this);</b>
<b class="nc">&nbsp;					endList(deleteCtx);</b>
&nbsp;				}
<b class="nc">&nbsp;				if (whereExpr != null) {</b>
<b class="nc">&nbsp;					Resource whereList = valueFactory.createBNode();</b>
<b class="nc">&nbsp;					handler.handleStatement(valueFactory.createStatement(subject, SP.WHERE_PROPERTY, whereList));</b>
<b class="nc">&nbsp;					ListContext whereCtx = newList(whereList);</b>
<b class="nc">&nbsp;					whereExpr.visit(this);</b>
<b class="nc">&nbsp;					endList(whereCtx);</b>
&nbsp;				}
&nbsp;			}
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(InsertData node) throws RDFHandlerException {
<b class="nc">&nbsp;			Resource dataList = valueFactory.createBNode();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, SP.DATA_PROPERTY, dataList));</b>
<b class="nc">&nbsp;			ListContext dataCtx = newList(dataList);</b>
<b class="nc">&nbsp;			renderDataBlock(node.getDataBlock());</b>
<b class="nc">&nbsp;			endList(dataCtx);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(DeleteData node) throws RDFHandlerException {
<b class="nc">&nbsp;			Resource dataList = valueFactory.createBNode();</b>
<b class="nc">&nbsp;			handler.handleStatement(valueFactory.createStatement(subject, SP.DATA_PROPERTY, dataList));</b>
<b class="nc">&nbsp;			ListContext dataCtx = newList(dataList);</b>
<b class="nc">&nbsp;			renderDataBlock(node.getDataBlock());</b>
<b class="nc">&nbsp;			endList(dataCtx);</b>
&nbsp;		}
&nbsp;
&nbsp;		private void renderDataBlock(String data) throws RDFHandlerException {
<b class="nc">&nbsp;			SPARQLUpdateDataBlockParser parser = new SPARQLUpdateDataBlockParser(valueFactory);</b>
<b class="nc">&nbsp;			parser.setAllowBlankNodes(false); // no blank nodes allowed</b>
<b class="nc">&nbsp;			parser.setRDFHandler(new AbstractRDFHandler() {</b>
&nbsp;
<b class="nc">&nbsp;				final Map&lt;Resource, ListContext&gt; namedGraphLists = new HashMap&lt;&gt;();</b>
&nbsp;
&nbsp;				ListContext namedGraphContext;
&nbsp;
&nbsp;				@Override
&nbsp;				public void handleStatement(Statement st) throws RDFHandlerException {
<b class="nc">&nbsp;					ListContext ctxList = null;</b>
<b class="nc">&nbsp;					if (st.getContext() != null) {</b>
<b class="nc">&nbsp;						ctxList = getNamedGraph(st.getContext());</b>
&nbsp;					}
<b class="nc">&nbsp;					listEntry();</b>
<b class="nc">&nbsp;					handler.handleStatement(</b>
<b class="nc">&nbsp;							valueFactory.createStatement(subject, SP.SUBJECT_PROPERTY, st.getSubject()));</b>
<b class="nc">&nbsp;					handler.handleStatement(</b>
<b class="nc">&nbsp;							valueFactory.createStatement(subject, SP.PREDICATE_PROPERTY, st.getPredicate()));</b>
<b class="nc">&nbsp;					handler.handleStatement(valueFactory.createStatement(subject, SP.OBJECT_PROPERTY, st.getObject()));</b>
<b class="nc">&nbsp;					if (ctxList != null) {</b>
<b class="nc">&nbsp;						restoreNamedGraph(ctxList);</b>
&nbsp;					}
&nbsp;				}
&nbsp;
&nbsp;				@Override
&nbsp;				public void endRDF() throws RDFHandlerException {
<b class="nc">&nbsp;					for (ListContext ctxList : namedGraphLists.values()) {</b>
<b class="nc">&nbsp;						endList(ctxList);</b>
<b class="nc">&nbsp;					}</b>
&nbsp;				}
&nbsp;
&nbsp;				private ListContext getNamedGraph(Resource context) throws RDFHandlerException {
&nbsp;					ListContext currentCtx;
<b class="nc">&nbsp;					namedGraphContext = namedGraphLists.get(context);</b>
<b class="nc">&nbsp;					if (namedGraphContext == null) {</b>
<b class="nc">&nbsp;						listEntry();</b>
<b class="nc">&nbsp;						handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.NAMED_GRAPH_CLASS));</b>
<b class="nc">&nbsp;						handler.handleStatement(</b>
<b class="nc">&nbsp;								valueFactory.createStatement(subject, SP.GRAPH_NAME_NODE_PROPERTY, context));</b>
<b class="nc">&nbsp;						Resource elementsList = valueFactory.createBNode();</b>
<b class="nc">&nbsp;						handler.handleStatement(</b>
<b class="nc">&nbsp;								valueFactory.createStatement(subject, SP.ELEMENTS_PROPERTY, elementsList));</b>
<b class="nc">&nbsp;						currentCtx = newList(elementsList);</b>
<b class="nc">&nbsp;						namedGraphContext = save();</b>
<b class="nc">&nbsp;						namedGraphLists.put(context, namedGraphContext);</b>
<b class="nc">&nbsp;					} else {</b>
<b class="nc">&nbsp;						currentCtx = save();</b>
<b class="nc">&nbsp;						restore(namedGraphContext);</b>
&nbsp;					}
<b class="nc">&nbsp;					return currentCtx;</b>
&nbsp;				}
&nbsp;
&nbsp;				private void restoreNamedGraph(ListContext ctx) {
<b class="nc">&nbsp;					update(namedGraphContext);</b>
<b class="nc">&nbsp;					restore(ctx);</b>
&nbsp;				}
&nbsp;			});
&nbsp;			try {
<b class="nc">&nbsp;				parser.parse(new StringReader(data), &quot;&quot;);</b>
<b class="nc">&nbsp;			} catch (RDFParseException | IOException e) {</b>
<b class="nc">&nbsp;				throw new RDFHandlerException(e);</b>
<b class="nc">&nbsp;			}</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Load node) throws RDFHandlerException {
<b class="nc">&nbsp;			handler.handleStatement(</b>
<b class="nc">&nbsp;					valueFactory.createStatement(subject, SP.DOCUMENT_PROPERTY, node.getSource().getValue()));</b>
<b class="nc">&nbsp;			handler.handleStatement(</b>
<b class="nc">&nbsp;					valueFactory.createStatement(subject, SP.INTO_PROPERTY, node.getGraph().getValue()));</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Clear node) throws RDFHandlerException {
<b class="nc">&nbsp;			if (node.isSilent()) {</b>
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(subject, SP.SILENT_PROPERTY, BooleanLiteral.TRUE));</b>
&nbsp;			}
&nbsp;
<b class="nc">&nbsp;			if (node.getGraph() != null) {</b>
<b class="nc">&nbsp;				handler.handleStatement(</b>
<b class="nc">&nbsp;						valueFactory.createStatement(subject, SP.GRAPH_IRI_PROPERTY, node.getGraph().getValue()));</b>
<b class="nc">&nbsp;			} else if (node.getScope() != null) {</b>
<b class="nc">&nbsp;				switch (node.getScope()) {</b>
&nbsp;				case DEFAULT_CONTEXTS:
<b class="nc">&nbsp;					handler.handleStatement(</b>
<b class="nc">&nbsp;							valueFactory.createStatement(subject, SP.DEFAULT_PROPERTY, BooleanLiteral.TRUE));</b>
<b class="nc">&nbsp;					break;</b>
&nbsp;				case NAMED_CONTEXTS:
<b class="nc">&nbsp;					handler.handleStatement(</b>
<b class="nc">&nbsp;							valueFactory.createStatement(subject, SP.NAMED_PROPERTY, BooleanLiteral.TRUE));</b>
<b class="nc">&nbsp;					break;</b>
&nbsp;				}
&nbsp;			} else {
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(subject, SP.ALL_PROPERTY, BooleanLiteral.TRUE));</b>
&nbsp;			}
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Create node) throws RDFHandlerException {
<b class="nc">&nbsp;			if (node.isSilent()) {</b>
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(subject, SP.SILENT_PROPERTY, BooleanLiteral.TRUE));</b>
&nbsp;			}
&nbsp;
<b class="nc">&nbsp;			if (node.getGraph() != null) {</b>
<b class="nc">&nbsp;				handler.handleStatement(</b>
<b class="nc">&nbsp;						valueFactory.createStatement(subject, SP.GRAPH_IRI_PROPERTY, node.getGraph().getValue()));</b>
&nbsp;			}
&nbsp;		}
&nbsp;
<b class="nc">&nbsp;		private final class ExtensionVisitor extends QueryModelVisitorBase&lt;RDFHandlerException&gt; {</b>
&nbsp;
&nbsp;			@Override
&nbsp;			public void meet(Count node) throws RDFHandlerException {
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.COUNT_CLASS));</b>
<b class="nc">&nbsp;				if (node.isDistinct()) {</b>
<b class="nc">&nbsp;					handler.handleStatement(</b>
<b class="nc">&nbsp;							valueFactory.createStatement(subject, SP.DISTINCT_PROPERTY, BooleanLiteral.TRUE));</b>
&nbsp;				}
<b class="nc">&nbsp;				Resource oldSubject = subject;</b>
<b class="nc">&nbsp;				super.meet(node);</b>
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(oldSubject, SP.EXPRESSION_PROPERTY, subject));</b>
<b class="nc">&nbsp;				subject = oldSubject;</b>
&nbsp;			}
&nbsp;
&nbsp;			@Override
&nbsp;			public void meet(Max node) throws RDFHandlerException {
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.MAX_CLASS));</b>
<b class="nc">&nbsp;				if (node.isDistinct()) {</b>
<b class="nc">&nbsp;					handler.handleStatement(</b>
<b class="nc">&nbsp;							valueFactory.createStatement(subject, SP.DISTINCT_PROPERTY, BooleanLiteral.TRUE));</b>
&nbsp;				}
<b class="nc">&nbsp;				Resource oldSubject = subject;</b>
<b class="nc">&nbsp;				super.meet(node);</b>
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(oldSubject, SP.EXPRESSION_PROPERTY, subject));</b>
<b class="nc">&nbsp;				subject = oldSubject;</b>
&nbsp;			}
&nbsp;
&nbsp;			@Override
&nbsp;			public void meet(Min node) throws RDFHandlerException {
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.MIN_CLASS));</b>
<b class="nc">&nbsp;				if (node.isDistinct()) {</b>
<b class="nc">&nbsp;					handler.handleStatement(</b>
<b class="nc">&nbsp;							valueFactory.createStatement(subject, SP.DISTINCT_PROPERTY, BooleanLiteral.TRUE));</b>
&nbsp;				}
<b class="nc">&nbsp;				Resource oldSubject = subject;</b>
<b class="nc">&nbsp;				super.meet(node);</b>
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(oldSubject, SP.EXPRESSION_PROPERTY, subject));</b>
<b class="nc">&nbsp;				subject = oldSubject;</b>
&nbsp;			}
&nbsp;
&nbsp;			@Override
&nbsp;			public void meet(Sum node) throws RDFHandlerException {
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.SUM_CLASS));</b>
<b class="nc">&nbsp;				if (node.isDistinct()) {</b>
<b class="nc">&nbsp;					handler.handleStatement(</b>
<b class="nc">&nbsp;							valueFactory.createStatement(subject, SP.DISTINCT_PROPERTY, BooleanLiteral.TRUE));</b>
&nbsp;				}
<b class="nc">&nbsp;				Resource oldSubject = subject;</b>
<b class="nc">&nbsp;				super.meet(node);</b>
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(oldSubject, SP.EXPRESSION_PROPERTY, subject));</b>
<b class="nc">&nbsp;				subject = oldSubject;</b>
&nbsp;			}
&nbsp;
&nbsp;			@Override
&nbsp;			public void meet(Avg node) throws RDFHandlerException {
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.AVG_CLASS));</b>
<b class="nc">&nbsp;				if (node.isDistinct()) {</b>
<b class="nc">&nbsp;					handler.handleStatement(</b>
<b class="nc">&nbsp;							valueFactory.createStatement(subject, SP.DISTINCT_PROPERTY, BooleanLiteral.TRUE));</b>
&nbsp;				}
<b class="nc">&nbsp;				Resource oldSubject = subject;</b>
<b class="nc">&nbsp;				super.meet(node);</b>
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(oldSubject, SP.EXPRESSION_PROPERTY, subject));</b>
<b class="nc">&nbsp;				subject = oldSubject;</b>
&nbsp;			}
&nbsp;
&nbsp;			@Override
&nbsp;			public void meet(GroupConcat node) throws RDFHandlerException {
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.GROUP_CONCAT_CLASS));</b>
<b class="nc">&nbsp;				if (node.isDistinct()) {</b>
<b class="nc">&nbsp;					handler.handleStatement(</b>
<b class="nc">&nbsp;							valueFactory.createStatement(subject, SP.DISTINCT_PROPERTY, BooleanLiteral.TRUE));</b>
&nbsp;				}
<b class="nc">&nbsp;				Resource oldSubject = subject;</b>
<b class="nc">&nbsp;				super.meet(node);</b>
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(oldSubject, SP.EXPRESSION_PROPERTY, subject));</b>
<b class="nc">&nbsp;				subject = oldSubject;</b>
&nbsp;			}
&nbsp;
&nbsp;			@Override
&nbsp;			public void meet(Sample node) throws RDFHandlerException {
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, SP.SAMPLE_CLASS));</b>
<b class="nc">&nbsp;				if (node.isDistinct()) {</b>
<b class="nc">&nbsp;					handler.handleStatement(</b>
<b class="nc">&nbsp;							valueFactory.createStatement(subject, SP.DISTINCT_PROPERTY, BooleanLiteral.TRUE));</b>
&nbsp;				}
<b class="nc">&nbsp;				Resource oldSubject = subject;</b>
<b class="nc">&nbsp;				super.meet(node);</b>
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(oldSubject, SP.EXPRESSION_PROPERTY, subject));</b>
<b class="nc">&nbsp;				subject = oldSubject;</b>
&nbsp;			}
&nbsp;
&nbsp;			@Override
&nbsp;			public void meet(Var node) throws RDFHandlerException {
<b class="nc">&nbsp;				subject = getVar(node.getName());</b>
&nbsp;			}
&nbsp;		}
&nbsp;
<b class="nc">&nbsp;		private final class GroupVisitor extends QueryModelVisitorBase&lt;RDFHandlerException&gt; {</b>
&nbsp;
&nbsp;			Group group;
&nbsp;
&nbsp;			@Override
&nbsp;			public void meet(Order node) throws RDFHandlerException {
<b class="nc">&nbsp;				node.getArg().visit(this);</b>
&nbsp;			}
&nbsp;
&nbsp;			@Override
&nbsp;			public void meet(Extension node) throws RDFHandlerException {
<b class="nc">&nbsp;				node.getArg().visit(this);</b>
&nbsp;			}
&nbsp;
&nbsp;			@Override
&nbsp;			public void meet(Group node) throws RDFHandlerException {
<b class="nc">&nbsp;				group = node;</b>
<b class="nc">&nbsp;				Set&lt;String&gt; groupNames = node.getGroupBindingNames();</b>
<b class="nc">&nbsp;				if (!groupNames.isEmpty()) {</b>
<b class="nc">&nbsp;					Resource groupByList = valueFactory.createBNode();</b>
<b class="nc">&nbsp;					handler.handleStatement(valueFactory.createStatement(subject, SP.GROUP_BY_PROPERTY, groupByList));</b>
<b class="nc">&nbsp;					ListContext groupByCtx = newList(groupByList);</b>
<b class="nc">&nbsp;					for (String groupName : groupNames) {</b>
<b class="nc">&nbsp;						Resource var = getVar(groupName);</b>
<b class="nc">&nbsp;						listEntry(var);</b>
<b class="nc">&nbsp;					}</b>
<b class="nc">&nbsp;					endList(groupByCtx);</b>
&nbsp;				}
&nbsp;			}
&nbsp;
&nbsp;			@Override
&nbsp;			public void meet(Filter node) throws RDFHandlerException {
<b class="nc">&nbsp;				node.getArg().visit(this);</b>
<b class="nc">&nbsp;				if (group != null) {</b>
<b class="nc">&nbsp;					Resource havingList = valueFactory.createBNode();</b>
<b class="nc">&nbsp;					handler.handleStatement(valueFactory.createStatement(subject, SP.HAVING_PROPERTY, havingList));</b>
<b class="nc">&nbsp;					ListContext havingCtx = newList(havingList);</b>
<b class="nc">&nbsp;					listEntry();</b>
<b class="nc">&nbsp;					node.getCondition().visit(SpinVisitor.this);</b>
<b class="nc">&nbsp;					endList(havingCtx);</b>
&nbsp;				}
&nbsp;			}
&nbsp;
&nbsp;			@Override
&nbsp;			protected void meetNode(QueryModelNode node) {
&nbsp;				// stop
<b class="nc">&nbsp;			}</b>
&nbsp;		}
&nbsp;
<b class="nc">&nbsp;		private final class OrderVisitor extends QueryModelVisitorBase&lt;RDFHandlerException&gt; {</b>
&nbsp;
&nbsp;			@Override
&nbsp;			public void meet(Order node) throws RDFHandlerException {
<b class="nc">&nbsp;				Resource orderByList = valueFactory.createBNode();</b>
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(subject, SP.ORDER_BY_PROPERTY, orderByList));</b>
<b class="nc">&nbsp;				ListContext orderByCtx = newList(orderByList);</b>
<b class="nc">&nbsp;				for (OrderElem elem : node.getElements()) {</b>
<b class="nc">&nbsp;					elem.visit(this);</b>
<b class="nc">&nbsp;				}</b>
<b class="nc">&nbsp;				endList(orderByCtx);</b>
&nbsp;			}
&nbsp;
&nbsp;			@Override
&nbsp;			public void meet(OrderElem node) throws RDFHandlerException {
<b class="nc">&nbsp;				IRI asc = node.isAscending() ? SP.ASC_CLASS : SP.DESC_CLASS;</b>
<b class="nc">&nbsp;				listEntry();</b>
<b class="nc">&nbsp;				handler.handleStatement(valueFactory.createStatement(subject, RDF.TYPE, asc));</b>
<b class="nc">&nbsp;				SpinVisitor.this.meet(node.getExpr());</b>
&nbsp;			}
&nbsp;
&nbsp;			@Override
&nbsp;			protected void meetNode(QueryModelNode node) {
&nbsp;				// stop
<b class="nc">&nbsp;			}</b>
&nbsp;		}
&nbsp;	}
&nbsp;
<b class="nc">&nbsp;	private static final class ExtensionContext extends QueryModelVisitorBase&lt;RuntimeException&gt; {</b>
&nbsp;
&nbsp;		Extension extension;
&nbsp;
&nbsp;		Map&lt;String, ValueExpr&gt; extensionExprs;
&nbsp;
&nbsp;		public ValueExpr getValueExpr(String name) {
<b class="nc">&nbsp;			return extensionExprs.get(name);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Order node) {
<b class="nc">&nbsp;			node.getArg().visit(this);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void meet(Extension node) {
<b class="nc">&nbsp;			extension = node;</b>
<b class="nc">&nbsp;			List&lt;ExtensionElem&gt; elements = node.getElements();</b>
&nbsp;			// NB: preserve ExtensionElem order
<b class="nc">&nbsp;			extensionExprs = new LinkedHashMap&lt;&gt;(elements.size());</b>
<b class="nc">&nbsp;			for (ExtensionElem elem : elements) {</b>
<b class="nc">&nbsp;				extensionExprs.put(elem.getName(), elem.getExpr());</b>
<b class="nc">&nbsp;			}</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		protected void meetNode(QueryModelNode node) {
&nbsp;			// stop
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	private static final class ListContext {
&nbsp;
&nbsp;		Resource list;
&nbsp;
&nbsp;		Resource subject;
&nbsp;
<b class="nc">&nbsp;		ListContext(Resource list, Resource subject) {</b>
<b class="nc">&nbsp;			this.list = list;</b>
<b class="nc">&nbsp;			this.subject = subject;</b>
&nbsp;		}
&nbsp;	}
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2022-09-18 08:56</div>
</div>
</body>
</html>
