/*******************************************************************************
 * Copyright (c) 2025 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.benchmark.common;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertFalse;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertTrue;

import java.io.BufferedReader;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.lang.reflect.Method;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;

import org.apache.commons.io.FileUtils;
import org.eclipse.rdf4j.benchmark.rio.util.ThemeDataSetGenerator.Theme;
import org.eclipse.rdf4j.model.Model;
import org.eclipse.rdf4j.rio.RDFFormat;
import org.eclipse.rdf4j.rio.Rio;
import org.junit.jupiter.api.Test;

class ThemeDataSetCacheTest {

	@Test
	void cachesNQuadsToDisk() throws Exception {
		Path tempDir = Files.createTempDirectory("theme-cache");
		try {
			Class<?> cacheClass = Class.forName("org.eclipse.rdf4j.benchmark.common.ThemeDataSetCache");
			Method method = cacheClass.getMethod("getOrCreateNQuads", Theme.class, Path.class);
			Path cacheFile = (Path) method.invoke(null, Theme.SOCIAL_MEDIA, tempDir);
			assertNotNull(cacheFile, "Cache file should be returned");
			assertTrue(cacheFile.toString().endsWith(".nq"), "Cache should be a .nq file");
			assertTrue(Files.exists(cacheFile), "Cache file should exist");
			assertTrue(Files.size(cacheFile) > 0, "Cache file should be non-empty");
			try (InputStream input = Files.newInputStream(cacheFile)) {
				Model model = Rio.parse(input, "", RDFFormat.NQUADS);
				assertFalse(model.isEmpty(), "Cached model should have statements");
			}
		} finally {
			FileUtils.deleteDirectory(tempDir.toFile());
		}
	}

	@Test
	void cachedFilesDeletedOnExit() throws Exception {
		Path tempDir = Files.createTempDirectory("theme-cache-exit");
		try {
			Process process = new ProcessBuilder(
					javaExecutable(),
					"-cp",
					System.getProperty("java.class.path"),
					ThemeDataSetCacheTestHarness.class.getName(),
					tempDir.toString(),
					Theme.SOCIAL_MEDIA.name())
					.redirectErrorStream(true)
					.start();
			String output = readOutput(process.getInputStream());
			int exitCode = process.waitFor();
			assertEquals(0, exitCode, "Helper JVM should exit cleanly. Output:\n" + output);
			String pathLine = findCachePathLine(output);
			assertNotNull(pathLine, "Helper JVM should print cache path. Output:\n" + output);
			String cachePath = pathLine.substring("CACHE_PATH=".length());
			assertFalse(Path.of(cachePath).toFile().exists(),
					"Cache file should be removed on JVM exit. Output:\n" + output);
		} finally {
			FileUtils.deleteDirectory(tempDir.toFile());
		}
	}

	private static String javaExecutable() {
		Path javaHome = Path.of(System.getProperty("java.home"));
		Path javaBin = javaHome.resolve("bin").resolve("java");
		return javaBin.toString();
	}

	private static String readOutput(InputStream input) throws Exception {
		StringBuilder builder = new StringBuilder();
		try (BufferedReader reader = new BufferedReader(new InputStreamReader(input, StandardCharsets.UTF_8))) {
			String line;
			while ((line = reader.readLine()) != null) {
				builder.append(line).append(System.lineSeparator());
			}
		}
		return builder.toString();
	}

	private static String findCachePathLine(String output) {
		for (String line : output.split("\\R")) {
			String trimmed = line.trim();
			if (trimmed.startsWith("CACHE_PATH=")) {
				return trimmed;
			}
		}
		return null;
	}
}

class ThemeDataSetCacheTestHarness {

	public static void main(String[] args) throws Exception {
		Path cacheDir = Path.of(args[0]);
		Theme theme = Theme.valueOf(args[1]);
		Path cacheFile = ThemeDataSetCache.getOrCreateNQuads(theme, cacheDir);
		System.out.println("CACHE_PATH=" + cacheFile.toAbsolutePath());
		System.out.flush();
	}
}
