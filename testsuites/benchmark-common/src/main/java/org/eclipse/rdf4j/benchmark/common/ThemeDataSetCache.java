/*******************************************************************************
 * Copyright (c) 2025 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.benchmark.common;

import java.io.IOException;
import java.io.OutputStream;
import java.io.UncheckedIOException;
import java.nio.file.AtomicMoveNotSupportedException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.StandardCopyOption;
import java.util.Locale;
import java.util.Objects;
import java.util.UUID;

import org.eclipse.rdf4j.benchmark.rio.util.ThemeDataSetGenerator;
import org.eclipse.rdf4j.benchmark.rio.util.ThemeDataSetGenerator.Theme;
import org.eclipse.rdf4j.rio.RDFFormat;
import org.eclipse.rdf4j.rio.Rio;

public final class ThemeDataSetCache {

	public static final String CACHE_DIR_PROPERTY = "rdf4j.benchmark.themeCacheDir";

	private static final String DEFAULT_CACHE_DIR_NAME = "rdf4j-theme-benchmark-cache";

	private ThemeDataSetCache() {
	}

	public static Path getOrCreateNQuads(Theme theme) {
		Path cacheDir = resolveCacheDir();
		return getOrCreateNQuads(theme, cacheDir);
	}

	public static Path getOrCreateNQuads(Theme theme, Path cacheDir) {
		Objects.requireNonNull(theme, "theme");
		Objects.requireNonNull(cacheDir, "cacheDir");

		try {
			Files.createDirectories(cacheDir);
			Path cacheFile = cacheDir.resolve(fileName(theme));
			if (Files.exists(cacheFile) && Files.size(cacheFile) > 0) {
				return cacheFile;
			}

			Path tempFile = Files.createTempFile(cacheDir, fileStem(theme), ".tmp");
			try (OutputStream output = Files.newOutputStream(tempFile)) {
				ThemeDataSetGenerator.generate(theme, Rio.createWriter(RDFFormat.NQUADS, output));
			}
			try {
				Files.move(tempFile, cacheFile, StandardCopyOption.REPLACE_EXISTING, StandardCopyOption.ATOMIC_MOVE);
			} catch (AtomicMoveNotSupportedException e) {
				Files.move(tempFile, cacheFile, StandardCopyOption.REPLACE_EXISTING);
			}
			return cacheFile;
		} catch (IOException e) {
			throw new UncheckedIOException("Failed to cache theme dataset for " + theme, e);
		}
	}

	private static String uuid = UUID.randomUUID().toString();

	private static Path resolveCacheDir() {
		String configured = System.getProperty(CACHE_DIR_PROPERTY);
		if (configured != null && !configured.isBlank()) {
			return Path.of(configured);
		}
		return Path.of(System.getProperty("java.io.tmpdir"), DEFAULT_CACHE_DIR_NAME + "-" + uuid);
	}

	private static String fileName(Theme theme) {
		return fileStem(theme) + ".nq";
	}

	private static String fileStem(Theme theme) {
		return theme.name().toLowerCase(Locale.ROOT);
	}
}
