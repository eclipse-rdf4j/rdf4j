name: Copilot Setup Steps

on:
  workflow_dispatch:  # Allow manual triggering
  workflow_call:      # Allow being called by other workflows

permissions:
  contents: read

jobs:
  copilot-setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'
          cache: maven
          
      - name: Install system dependencies for e2e tests
        run: sudo apt-get update && sudo apt-get install -y libxml2-utils
        
      - name: Install Node.js for e2e tests
        uses: actions/setup-node@v3
        with:
          node-version: 18
          
      - name: Download all dependencies for offline work
        run: |
          # Download all runtime and test dependencies
          mvn -B --quiet dependency:go-offline
          
      - name: Quick compile and install all modules
        run: |
          # Clean and install all modules to local repository for offline work
          mvn --quiet clean && mvn -B --quiet -T 2C install -Pquick
          
      - name: Download additional test dependencies
        run: |
          # Download source dependencies for better IDE experience
          mvn -B --quiet dependency:resolve-sources
          
      - name: Install e2e test dependencies
        working-directory: ./e2e
        run: |
          # Install npm dependencies for e2e tests
          npm install
          # Install Playwright browsers
          npx playwright install --with-deps
          
      - name: Verify offline mode works
        run: |
          # Test that we can build offline after downloading dependencies
          echo "Testing offline build capability..."
          mvn -o -Pquick install | tail -50
          
      - name: Setup complete - Ready for Copilot development
        run: |
          echo "✅ Repository setup complete!"
          echo "✅ JDK 21 installed and configured"
          echo "✅ Node.js 18 installed for e2e tests"
          echo "✅ Maven dependencies cached and available offline"
          echo "✅ E2E test dependencies installed (npm, Playwright)"
          echo "✅ Project built successfully with quick profile"
          echo ""
          echo "The environment is now ready for AI-assisted development with:"
          echo "- All Maven dependencies cached in ~/.m2/repository"
          echo "- Project successfully built and installable offline"
          echo "- Maven can run with '-o' flag for offline development"
          echo "- Use 'mvn -o -Pquick install' for fast offline builds"
          echo "- E2E tests ready to run with npm and Playwright"