name: PR verify

on: pull_request

permissions:
  contents: read          # checkout & other read‑only operations
  actions: write          # allows the cancel‑workflow step to call the Actions API

jobs:

  formatting-and-quick-compile:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Cache local Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-jdk${{ matrix.jdk }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-jdk${{ matrix.jdk }}-maven-
      - name: Check formatting
        run: mvn -B formatter:validate impsort:check xml-format:xml-check
      - name: Quick compile
        run: mvn -B install -DskipTests    -Pquick


  compile:
    needs: formatting-and-quick-compile
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Cache local Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-jdk${{ matrix.jdk }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-jdk${{ matrix.jdk }}-maven-
      - name: Compile (mvn clean install)
        run: mvn -B clean install -DskipTests


  build:
    needs: formatting-and-quick-compile
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        jdk: [ 11, 21 ]
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK
        uses: actions/setup-java@v1
        with:
          java-version: ${{ matrix.jdk }}
      - name: Cache local Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-jdk${{ matrix.jdk }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-jdk${{ matrix.jdk }}-maven-
      - name: Check formatting
        run: mvn -B formatter:validate impsort:check xml-format:xml-check
      - name: Build
        run: mvn clean && mvn -B -U -T 2C install -Pquick
      - name: Test
        run: mvn -B test -DskipITs -P-formatting -Dmaven.javadoc.skip -Djapicmp.skip -Denforcer.skip -Danimal.sniffer.skip
      - name: Publish Test Report
        if: failure()
        uses: scacap/action-surefire-report@v1.9.0
        with:
          check_name: Test report - build - ${{ matrix.jdk }}


  integration-tests:
    needs: formatting-and-quick-compile
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Cache local Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-jdk11-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-jdk11-maven-
      - name: Check formatting
        run: mvn -B formatter:validate impsort:check xml-format:xml-check
      - name: Build
        run: mvn clean && mvn -B -U -T 2C install -Pquick
      - name: Verify
        run: mvn -B verify -PskipUnitTests,-formatting -Dmaven.javadoc.skip -Denforcer.skip -Danimal.sniffer.skip
      - name: Publish Test Report
        if: failure()
        uses: scacap/action-surefire-report@v1.9.0
        with:
          check_name: Test report - integration-tests

  slow-tests:
    needs: formatting-and-quick-compile
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Cache local Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-jdk11-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-jdk11-maven-
      - name: Check formatting
        run: mvn -B formatter:validate impsort:check xml-format:xml-check
      - name: Build
        run: mvn clean && mvn -B -U -T 2C install -Pquick
      - name: Verify
        run: mvn -B verify -PslowTestsOnly,-skipSlowTests,-formatting -Dmaven.javadoc.skip -Djapicmp.skip -Denforcer.skip -Danimal.sniffer.skip
      - name: Publish Test Report
        if: failure()
        uses: scacap/action-surefire-report@v1.9.0
        with:
          check_name: Test report - slow-tests

  package-assembly:
    needs: formatting-and-quick-compile
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Cache local Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-jdk11-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-jdk11-maven-
      - name: Run install
        run: mvn clean && mvn -B -U -T 2C install -Pquick
      - name: Package assembly
        run: mvn package -Passembly -DskipTests


  e2e:
    needs: formatting-and-quick-compile
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Cache local Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-jdk11-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-jdk11-maven-
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libxml2-utils
      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
      - name: Run end-to-end tests of RDF4J Server and Workbench
        working-directory: ./e2e
        run: ./run.sh

  copyright-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: check copyright header present
        run: scripts/checkCopyrightPresent.sh

