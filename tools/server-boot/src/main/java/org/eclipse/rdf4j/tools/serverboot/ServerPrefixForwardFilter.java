/*******************************************************************************
 * Copyright (c) 2025 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.tools.serverboot;

import java.io.IOException;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import jakarta.servlet.Filter;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.ServletRequest;
import jakarta.servlet.ServletResponse;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletRequestWrapper;
import jakarta.servlet.http.HttpServletResponse;

class ServerPrefixForwardFilter implements Filter {

	private static final Logger logger = LoggerFactory.getLogger(ServerPrefixForwardFilter.class);

	private static final String SERVER_PREFIX = "/rdf4j-server";

	@Override
	public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
			throws IOException, ServletException {
		if (!(request instanceof HttpServletRequest) || !(response instanceof HttpServletResponse)) {
			chain.doFilter(request, response);
			return;
		}

		HttpServletRequest httpRequest = (HttpServletRequest) request;
		HttpServletResponse httpResponse = (HttpServletResponse) response;

		String contextPath = httpRequest.getContextPath();
		String requestUri = httpRequest.getRequestURI();
		String serverPrefix = contextPath + SERVER_PREFIX;

		if (requestUri.equals(serverPrefix) || requestUri.equals(serverPrefix + "/")) {
			httpResponse.sendRedirect(serverPrefix + "/overview.view");
			return;
		}

		if (requestUri.startsWith(serverPrefix + "/")) {
			chain.doFilter(new PrefixStrippingRequestWrapper(httpRequest, SERVER_PREFIX), response);
			return;
		}

		chain.doFilter(request, response);
	}

	private static final class PrefixStrippingRequestWrapper extends HttpServletRequestWrapper {

		private final String adjustedContextPath;
		private final String adjustedServletPath;

		PrefixStrippingRequestWrapper(HttpServletRequest request, String prefix) {
			super(request);
			this.adjustedContextPath = request.getContextPath() + prefix;
			String servletPath = request.getServletPath();
			if (servletPath != null && servletPath.startsWith(prefix)) {
				String remainder = servletPath.substring(prefix.length());
				this.adjustedServletPath = normalize(remainder);
			} else {
				this.adjustedServletPath = servletPath;
			}
		}

		@Override
		public String getContextPath() {
			return adjustedContextPath;
		}

		@Override
		public String getServletPath() {
			return adjustedServletPath;
		}

		private String normalize(String value) {
			if (value == null || value.isEmpty()) {
				return "/";
			}
			return value.startsWith("/") ? value : "/" + value;
		}
	}
}
