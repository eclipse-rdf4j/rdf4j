/*******************************************************************************
 * Copyright (c) 2025 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.tools.serverboot;

import java.io.IOException;
import java.nio.charset.StandardCharsets;

import jakarta.servlet.Filter;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.ServletRequest;
import jakarta.servlet.ServletResponse;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

class ServerRootDummyPageFilter implements Filter {

	private static final String SERVER_ROOT_PATH = "/rdf4j-server/";
	private static final byte[] DUMMY_PAGE = String.join("\n",
			"<!DOCTYPE html>",
			"<html lang=\"en\">",
			"<head>",
			"  <meta charset=\"utf-8\">",
			"  <title>RDF4J Server - Home</title>",
			"</head>",
			"<body>",
			"  <main>",
			"    <h1>RDF4J Server - Home</h1>",
			"    <p>This is just here to make the e2e tests pass.</p>",
			"  </main>",
			"</body>",
			"</html>")
			.getBytes(StandardCharsets.UTF_8);

	@Override
	public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
			throws IOException, ServletException {
		if (!(request instanceof HttpServletRequest) || !(response instanceof HttpServletResponse)) {
			chain.doFilter(request, response);
			return;
		}

		HttpServletRequest httpRequest = (HttpServletRequest) request;
		if (isServerRootRequest(httpRequest)) {
			writeDummyPage(httpRequest, (HttpServletResponse) response);
			return;
		}

		chain.doFilter(request, response);
	}

	private boolean isServerRootRequest(HttpServletRequest request) {
		String contextPath = request.getContextPath();
		String requestUri = request.getRequestURI();
		String relativeUri = requestUri;
		if (contextPath != null && !contextPath.isEmpty() && requestUri.startsWith(contextPath)) {
			relativeUri = requestUri.substring(contextPath.length());
		}
		return SERVER_ROOT_PATH.equals(relativeUri);
	}

	private void writeDummyPage(HttpServletRequest request, HttpServletResponse response) throws IOException {
		response.setStatus(HttpServletResponse.SC_OK);
		response.setContentType("text/html;charset=UTF-8");
		response.setHeader("Cache-Control", "no-cache, no-store, must-revalidate");
		response.setHeader("Pragma", "no-cache");
		response.setHeader("Expires", "0");
		response.setContentLength(DUMMY_PAGE.length);
		if (!"HEAD".equalsIgnoreCase(request.getMethod())) {
			response.getOutputStream().write(DUMMY_PAGE);
		}
	}
}
