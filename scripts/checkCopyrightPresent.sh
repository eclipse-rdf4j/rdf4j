#!/bin/bash
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
repo_root="$(cd "${script_dir}/.." && pwd)"
rewrite_headers=false

for arg in "$@"; do
  if [ "$arg" = "--rewrite-header" ]; then
    rewrite_headers=true
  fi
done

filesWithOutCopyright=()
filesWithOutSPDX=()
filesWithInvalidHeader=()
filesWithAdunaYearAfter2020=()
expectedHeader=(
  "/*******************************************************************************"
  "__YEAR__"
  " *"
  " * All rights reserved. This program and the accompanying materials"
  " * are made available under the terms of the Eclipse Distribution License v1.0"
  " * which accompanies this distribution, and is available at"
  " * http://www.eclipse.org/org/documents/edl-v10.php."
  " *"
  " * SPDX-License-Identifier: BSD-3-Clause"
  " *******************************************************************************/"
)

count_asterisks() {
  local line="$1"
  local only
  only="${line//[^*]/}"
  printf '%s' "${#only}"
}

line_matches_expected() {
  local expected="$1"
  local actual="$2"
  local expected_count
  local len
  local i
  local candidate
  local prev
  local curr

  if [ "$expected" = "$actual" ]; then
    return 0
  fi

  expected_count="$(count_asterisks "$expected")"
  if [ "$expected_count" -le 10 ]; then
    return 1
  fi

  len=${#expected}
  for ((i=0; i<len; i++)); do
    if [ "${expected:i:1}" = "*" ]; then
      candidate="${expected:0:i}${expected:i+1}"
      if [ "$candidate" = "$actual" ]; then
        return 0
      fi
    fi
  done

  for ((i=0; i<=len; i++)); do
    prev=""
    curr=""
    if [ "$i" -gt 0 ]; then
      prev="${expected:i-1:1}"
    fi
    curr="${expected:i:1}"
    if [ "$prev" = "*" ] || [ "$curr" = "*" ]; then
      candidate="${expected:0:i}*${expected:i}"
      if [ "$candidate" = "$actual" ]; then
        return 0
      fi
    fi
  done
  return 1
}

rewrite_header() {
  local file="$1"
  local year_line="$2"
  local tmp_file
  local mode
  mode=$(stat -f %Lp "$file" 2>/dev/null || stat -c %a "$file")
  tmp_file="$(mktemp)"
  {
    echo "${expectedHeader[0]}"
    echo "$year_line"
    echo "${expectedHeader[2]}"
    echo "${expectedHeader[3]}"
    echo "${expectedHeader[4]}"
    echo "${expectedHeader[5]}"
    echo "${expectedHeader[6]}"
    echo "${expectedHeader[7]}"
    echo "${expectedHeader[8]}"
    echo "${expectedHeader[9]}"
    tail -n +11 "$file"
  } > "$tmp_file"
  if [ -n "$mode" ]; then
    chmod "$mode" "$tmp_file"
  fi
  mv "$tmp_file" "$file"
}

read_header_lines() {
  local file="$1"
  header_lines=()
  while IFS= read -r line; do
    line="${line%$'\r'}"
    header_lines+=("$line")
  done < <(head -n 10 "$file")
}


while IFS= read -r -d '' i; do
  if [[ "$i" == "${repo_root}/core/queryparser/sparql/JavaCC/"* ]]; then
    continue
  fi

  echo "$i"
  # only look in non test files but make sure src/main exists.
  # and not in package-info
  dir="${i/pom.xml/}src/"
  if [ -d "$dir" ]; then
    while IFS= read -r -d '' c; do
      read_header_lines "$c"

      generated=false
      if grep -q 'Generated By:' "$c"; then
        generated=true
      fi

      if [ "$generated" = false ]; then
        has_copyright=false
        if [ ${#header_lines[@]} -ge 2 ] && [[ "${header_lines[1]}" == *Copyright* ]]; then
          has_copyright=true
        elif grep -q "Copyright" "$c"; then
          has_copyright=true
        fi

        if [ ${#header_lines[@]} -lt 10 ]; then
          if [ "$has_copyright" = true ]; then
            filesWithInvalidHeader+=("$c")
          else
            filesWithOutCopyright+=("$c")
          fi
        else
          match_count=0
          has_valid_year_line=false
          aduna_year=""

          if [[ "${header_lines[1]}" =~ ^[[:space:]]*\*\ Copyright\ \(c\)\ ([0-9]{4})\ Eclipse\ RDF4J\ contributors\.$ ]]; then
            has_valid_year_line=true
          elif [[ "${header_lines[1]}" =~ ^[[:space:]]*\*\ Copyright\ \(c\)\ ([0-9]{4})\ Eclipse\ RDF4J\ contributors,\ Aduna,\ and\ others\.$ ]]; then
            has_valid_year_line=true
            aduna_year="${BASH_REMATCH[1]}"
          fi

          for idx in 0 2 3 4 5 6 7 8 9; do
            if line_matches_expected "${expectedHeader[$idx]}" "${header_lines[$idx]}"; then
              match_count=$((match_count + 1))
            fi
          done

          if [ "$rewrite_headers" = true ] && [ "$match_count" -ge 4 ] && [ "$match_count" -lt 9 ]; then
            rewrite_header "$c" "${header_lines[1]}"
            read_header_lines "$c"
            match_count=0
            has_valid_year_line=false
            aduna_year=""
            if [[ "${header_lines[1]}" =~ ^[[:space:]]*\*\ Copyright\ \(c\)\ ([0-9]{4})\ Eclipse\ RDF4J\ contributors\.$ ]]; then
              has_valid_year_line=true
            elif [[ "${header_lines[1]}" =~ ^[[:space:]]*\*\ Copyright\ \(c\)\ ([0-9]{4})\ Eclipse\ RDF4J\ contributors,\ Aduna,\ and\ others\.$ ]]; then
              has_valid_year_line=true
              aduna_year="${BASH_REMATCH[1]}"
            fi
            for idx in 0 2 3 4 5 6 7 8 9; do
              if line_matches_expected "${expectedHeader[$idx]}" "${header_lines[$idx]}"; then
                match_count=$((match_count + 1))
              fi
            done
          fi

          if [ -n "$aduna_year" ] && [ "$aduna_year" -gt 2020 ]; then
            filesWithAdunaYearAfter2020+=("$c")
          fi

          if [ "$has_valid_year_line" = false ]; then
            if [ "$has_copyright" = true ]; then
              filesWithInvalidHeader+=("$c")
            else
              filesWithOutCopyright+=("$c")
            fi
          elif [ "$match_count" -lt 9 ]; then
            filesWithInvalidHeader+=("$c")
          fi
        fi
      fi

      has_spdx=false
      if [ ${#header_lines[@]} -ge 9 ] && [[ "${header_lines[8]}" == *"SPDX-License-Identifier: BSD-3-Clause"* ]]; then
        has_spdx=true
      elif grep -q 'SPDX-License-Identifier: BSD-3-Clause' "$c"; then
        has_spdx=true
      fi

      if [ "$has_spdx" = false ]; then
        filesWithOutSPDX+=("$c")
      fi
    done < <(find "${dir}" -name "*.java" -not -name "package-info.java" -print0)
  fi
done < <(find "${repo_root}" -type d -name target -prune -o -type f -name "pom.xml" -print0)

for f in "${filesWithOutCopyright[@]}"; do
  echo "Missing copyright: $f"
done
for f in "${filesWithInvalidHeader[@]}"; do
  echo "Invalid copyright header: $f"
done
for f in "${filesWithAdunaYearAfter2020[@]}"; do
  echo "Aduna header year must be 2020 or earlier: $f"
done
for f in "${filesWithOutSPDX[@]}"; do
  echo "Missing SPDX line in: $f"
done
if [ ${#filesWithOutCopyright[@]} -ne 0 ] || [ ${#filesWithInvalidHeader[@]} -ne 0 ] || [ ${#filesWithAdunaYearAfter2020[@]} -ne 0 ]; then
  if [ "$rewrite_headers" = false ]; then
    echo "Tip: rerun with --rewrite-header to auto-fix headers when possible."
  fi
  exit 1
fi
if [ ${#filesWithOutSPDX[@]} -ne 0 ]; then
  if [ "$rewrite_headers" = false ]; then
    echo "Tip: rerun with --rewrite-header to auto-fix headers when possible."
  fi
  exit 2
fi
