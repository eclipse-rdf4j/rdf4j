/*******************************************************************************
 * Copyright (c) 2025 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.sail.elasticsearch;

import java.util.concurrent.TimeUnit;

import org.apache.hc.core5.http.HttpHost;
import org.junit.jupiter.api.AfterAll;
import org.junit.jupiter.api.Assumptions;
import org.junit.jupiter.api.BeforeAll;
import org.testcontainers.containers.GenericContainer;
import org.testcontainers.junit.jupiter.Container;
import org.testcontainers.junit.jupiter.Testcontainers;
import org.testcontainers.utility.DockerImageName;

import co.elastic.clients.elasticsearch.ElasticsearchClient;
import co.elastic.clients.elasticsearch._types.HealthStatus;
import co.elastic.clients.elasticsearch.cluster.HealthResponse;
import co.elastic.clients.json.jackson.JacksonJsonpMapper;
import co.elastic.clients.transport.ElasticsearchTransport;
import co.elastic.clients.transport.rest5_client.Rest5ClientTransport;
import co.elastic.clients.transport.rest5_client.low_level.Rest5Client;

@Testcontainers(disabledWithoutDocker = true)
public abstract class AbstractElasticsearchTest {

	protected static final String CLUSTER_NAME = "test";

	@Container
	public static final GenericContainer<?> elasticsearch = new GenericContainer<>(dockerImageName())
			.withEnv("discovery.type", "single-node")
			.withEnv("cluster.name", CLUSTER_NAME)
			.withEnv("xpack.security.enabled", "false")
			.withEnv("ES_JAVA_OPTS",
					"-Djdk.disableLastUsageTracking=true -XX:-UseContainerSupport -Xms512m -Xmx512m")
			.withEnv("JDK_JAVA_OPTIONS",
					"-Djdk.disableLastUsageTracking=true -XX:-UseContainerSupport -Xms512m -Xmx512m")
			.withEnv("JAVA_TOOL_OPTIONS",
					"-Djdk.disableLastUsageTracking=true -XX:-UseContainerSupport -Xms512m -Xmx512m")
			.withExposedPorts(9200, 9300);

	protected static Rest5Client lowLevelClient;
	protected static ElasticsearchTransport transport;
	protected static ElasticsearchClient client;
	protected static String host;
	protected static int httpPort;

	@BeforeAll
	public static void setUpCluster() throws Exception {
		System.out.println("Setting up elasticsearch cluster");
		if (client != null) {
			return;
		}

		Assumptions.assumeTrue(elasticsearch.isRunning(),
				"Elasticsearch test container failed to start:\n" + safeLogs());

		host = elasticsearch.getHost();
		httpPort = elasticsearch.getMappedPort(9200);

		lowLevelClient = Rest5Client.builder(new HttpHost("http", host, httpPort)).build();
		transport = new Rest5ClientTransport(lowLevelClient, new JacksonJsonpMapper());
		client = new ElasticsearchClient(transport);

		waitForClusterReady(client);
	}

	@AfterAll
	public static void tearDownCluster() {
		if (client != null) {
			try {
				lowLevelClient.close();
			} catch (Exception e) {
				// ignore during shutdown
			}
			client = null;
			transport = null;
			lowLevelClient = null;
		}
	}

	private static DockerImageName dockerImageName() {
		String esVersion = System.getProperty("elasticsearch.docker.version",
				System.getProperty("elasticsearch.version", "9.2.1"));

		return DockerImageName
				.parse("docker.elastic.co/elasticsearch/elasticsearch:" + esVersion)
				.asCompatibleSubstituteFor("docker.elastic.co/elasticsearch/elasticsearch");
	}

	private static void waitForClusterReady(ElasticsearchClient client) {
		if (!elasticsearch.isRunning()) {
			throw new IllegalStateException("Elasticsearch test container stopped before health check:\n" + safeLogs());
		}

		long deadline = System.nanoTime() + TimeUnit.SECONDS.toNanos(180);
		Exception lastFailure = null;

		while (System.nanoTime() < deadline) {
			if (!elasticsearch.isRunning()) {
				throw new IllegalStateException(
						"Elasticsearch test container stopped during health check:\n" + safeLogs());
			}
			try {
				HealthResponse response = client.cluster()
						.health(h -> h.waitForStatus(HealthStatus.Yellow).timeout(t -> t.time("100ms")));
				if (!response.timedOut()) {
					return;
				}
				lastFailure = new IllegalStateException("Cluster health timed out waiting for YELLOW status");
			} catch (Exception e) {
				lastFailure = e;
			}

			try {
				Thread.sleep(10);
			} catch (InterruptedException ie) {
				Thread.currentThread().interrupt();
				throw new IllegalStateException("Interrupted while waiting for Elasticsearch test cluster", ie);
			}
		}

		throw new IllegalStateException("Timed out waiting for Elasticsearch test cluster", lastFailure);
	}

	private static String safeLogs() {
		try {
			return elasticsearch.getLogs();
		} catch (Exception e) {
			return "Unable to read container logs: " + e.getMessage();
		}
	}
}
