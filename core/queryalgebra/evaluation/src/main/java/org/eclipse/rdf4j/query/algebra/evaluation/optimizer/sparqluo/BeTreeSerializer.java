/*******************************************************************************
 * Copyright (c) 2025 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.query.algebra.evaluation.optimizer.sparqluo;

import java.util.List;

import org.eclipse.rdf4j.query.algebra.Join;
import org.eclipse.rdf4j.query.algebra.LeftJoin;
import org.eclipse.rdf4j.query.algebra.SingletonSet;
import org.eclipse.rdf4j.query.algebra.StatementPattern;
import org.eclipse.rdf4j.query.algebra.TupleExpr;
import org.eclipse.rdf4j.query.algebra.Union;

public class BeTreeSerializer {
	public TupleExpr serialize(BeGroupNode group) {
		TupleExpr expr = null;
		for (BeNode child : group.getChildren()) {
			TupleExpr childExpr = serializeNode(child);
			if (expr == null) {
				expr = childExpr;
				continue;
			}
			if (child instanceof BeOptionalNode) {
				expr = new LeftJoin(expr, childExpr);
			} else {
				expr = new Join(expr, childExpr);
			}
		}
		return expr != null ? expr : new SingletonSet();
	}

	private TupleExpr serializeNode(BeNode node) {
		switch (node.getType()) {
		case BGP:
			return serializeBgp((BeBgpNode) node);
		case UNION:
			return serializeUnion((BeUnionNode) node);
		case OPTIONAL:
			return serialize(((BeOptionalNode) node).getRight());
		case GROUP:
			return serialize((BeGroupNode) node);
		case BARRIER:
			return ((BeBarrierNode) node).getTupleExpr().clone();
		default:
			throw new IllegalStateException("Unsupported BE node type: " + node.getType());
		}
	}

	private TupleExpr serializeUnion(BeUnionNode union) {
		TupleExpr unionExpr = null;
		for (BeGroupNode branch : union.getBranches()) {
			TupleExpr branchExpr = serialize(branch);
			if (unionExpr == null) {
				unionExpr = branchExpr;
			} else {
				Union newUnion = new Union(unionExpr, branchExpr);
				newUnion.setVariableScopeChange(union.isVariableScopeChange());
				unionExpr = newUnion;
			}
		}
		if (unionExpr == null) {
			return new SingletonSet();
		}
		if (unionExpr instanceof Union) {
			((Union) unionExpr).setVariableScopeChange(union.isVariableScopeChange());
		}
		return unionExpr;
	}

	private TupleExpr serializeBgp(BeBgpNode bgp) {
		List<StatementPattern> patterns = bgp.getStatementPatterns();
		TupleExpr expr = null;
		for (StatementPattern pattern : patterns) {
			StatementPattern clone = pattern.clone();
			if (expr == null) {
				expr = clone;
			} else {
				expr = new Join(expr, clone);
			}
		}
		return expr != null ? expr : new SingletonSet();
	}
}
