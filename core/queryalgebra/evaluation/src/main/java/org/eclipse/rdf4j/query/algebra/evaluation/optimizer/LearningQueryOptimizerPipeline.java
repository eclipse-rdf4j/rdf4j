/*******************************************************************************
 * Copyright (c) 2026 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.query.algebra.evaluation.optimizer;

import java.util.ArrayList;
import java.util.List;
import java.util.Objects;

import org.eclipse.rdf4j.query.algebra.evaluation.EvaluationStrategy;
import org.eclipse.rdf4j.query.algebra.evaluation.QueryOptimizer;
import org.eclipse.rdf4j.query.algebra.evaluation.QueryOptimizerPipeline;
import org.eclipse.rdf4j.query.algebra.evaluation.TripleSource;
import org.eclipse.rdf4j.query.algebra.evaluation.impl.EvaluationStatistics;
import org.eclipse.rdf4j.query.algebra.evaluation.optimizer.learned.LearnedJoinConfig;

/**
 * Standard optimizer pipeline with a learned join optimizer.
 */
public class LearningQueryOptimizerPipeline implements QueryOptimizerPipeline {

	private static boolean assertsEnabled = false;

	static {
		// noinspection AssertWithSideEffects
		assert assertsEnabled = true;
	}

	private final EvaluationStatistics evaluationStatistics;
	private final TripleSource tripleSource;
	private final EvaluationStrategy strategy;
	private final JoinStatsProvider statsProvider;
	private final LearnedJoinConfig joinConfig;

	public LearningQueryOptimizerPipeline(EvaluationStrategy strategy, TripleSource tripleSource,
			EvaluationStatistics evaluationStatistics, JoinStatsProvider statsProvider) {
		this(strategy, tripleSource, evaluationStatistics, statsProvider, new LearnedJoinConfig());
	}

	public LearningQueryOptimizerPipeline(EvaluationStrategy strategy, TripleSource tripleSource,
			EvaluationStatistics evaluationStatistics, JoinStatsProvider statsProvider, LearnedJoinConfig joinConfig) {
		this.strategy = strategy;
		this.tripleSource = tripleSource;
		this.evaluationStatistics = evaluationStatistics;
		this.statsProvider = statsProvider;
		this.joinConfig = Objects.requireNonNull(joinConfig, "joinConfig");
	}

	@Override
	public Iterable<QueryOptimizer> getOptimizers() {
		List<QueryOptimizer> optimizers = List.of(
				StandardQueryOptimizerPipeline.BINDING_ASSIGNER,
				StandardQueryOptimizerPipeline.BINDING_SET_ASSIGNMENT_INLINER,
				new ConstantOptimizer(strategy),
				new RegexAsStringFunctionOptimizer(tripleSource.getValueFactory()),
				StandardQueryOptimizerPipeline.COMPARE_OPTIMIZER,
				StandardQueryOptimizerPipeline.CONJUNCTIVE_CONSTRAINT_SPLITTER,
				StandardQueryOptimizerPipeline.DISJUNCTIVE_CONSTRAINT_OPTIMIZER,
				StandardQueryOptimizerPipeline.SAME_TERM_FILTER_OPTIMIZER,
				StandardQueryOptimizerPipeline.UNION_SCOPE_CHANGE_OPTIMIZER,
				StandardQueryOptimizerPipeline.QUERY_MODEL_NORMALIZER,
				StandardQueryOptimizerPipeline.PROJECTION_REMOVAL_OPTIMIZER,
				new LearnedQueryJoinOptimizer(evaluationStatistics, strategy.isTrackResultSize(), tripleSource,
						statsProvider, joinConfig),
				StandardQueryOptimizerPipeline.ITERATIVE_EVALUATION_OPTIMIZER,
				StandardQueryOptimizerPipeline.FILTER_OPTIMIZER,
				StandardQueryOptimizerPipeline.ORDER_LIMIT_OPTIMIZER
		);

		if (assertsEnabled) {
			List<QueryOptimizer> optimizersWithReferenceChecker = new ArrayList<>();
			optimizersWithReferenceChecker.add(new ParentReferenceChecker(null));
			for (QueryOptimizer optimizer : optimizers) {
				optimizersWithReferenceChecker.add(optimizer);
				optimizersWithReferenceChecker.add(new ParentReferenceChecker(optimizer));
			}
			optimizers = optimizersWithReferenceChecker;
		}

		return optimizers;
	}
}
