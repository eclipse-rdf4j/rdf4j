/*******************************************************************************
 * Copyright (c) 2025 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.query.algebra.evaluation.optimizer.sparqluo;

public final class SparqlUoConfig {

	public static final String PROP_ALLOW_NON_IMPROVING = "rdf4j.sparqluo.allowNonImprovingTransforms";
	public static final String PROP_VAR_DOMAIN = "rdf4j.sparqluo.assumedVarDomainCardinality";
	public static final String PROP_OPTIONAL_MATCH_RATE = "rdf4j.sparqluo.optionalMatchRate";
	public static final String PROP_OPTIONAL_MULTIPLICITY = "rdf4j.sparqluo.optionalMultiplicity";
	public static final String PROP_DEBUG_LOGGING = "rdf4j.sparqluo.debugLogging";
	public static final String PROP_SIMULATE_JOIN_ORDER = "rdf4j.sparqluo.simulateJoinOrder";
	public static final String PROP_MAX_BSA_UNION_DISTRIBUTION = "rdf4j.sparqluo.maxBindingSetAssignmentUnionSize";
	public static final String PROP_ENABLE_MINUS_UNION_SPLIT = "rdf4j.sparqluo.enableMinusUnionSplit";
	public static final String PROP_ENABLE_OPTIONAL_FILTER_JOIN = "rdf4j.sparqluo.enableOptionalFilterJoin";

	public static final boolean DEFAULT_ALLOW_NON_IMPROVING = false;
	public static final double DEFAULT_VAR_DOMAIN = 10.0;
	public static final double DEFAULT_OPTIONAL_MATCH_RATE = 0.3;
	public static final double DEFAULT_OPTIONAL_MULTIPLICITY = 1.0;
	public static final boolean DEFAULT_DEBUG_LOGGING = false;
	public static final boolean DEFAULT_SIMULATE_JOIN_ORDER = true;
	public static final int DEFAULT_MAX_BSA_UNION_DISTRIBUTION = 32;
	public static final boolean DEFAULT_ENABLE_MINUS_UNION_SPLIT = true;
	public static final boolean DEFAULT_ENABLE_OPTIONAL_FILTER_JOIN = true;

	private final boolean allowNonImprovingTransforms;
	private final double assumedVarDomainCardinality;
	private final double optionalMatchRate;
	private final double optionalMultiplicity;
	private final boolean debugLogging;
	private final boolean simulateJoinOrder;
	private final int maxBindingSetAssignmentUnionSize;
	private final boolean enableMinusUnionSplit;
	private final boolean enableOptionalFilterJoin;

	private SparqlUoConfig(Builder builder) {
		this.allowNonImprovingTransforms = builder.allowNonImprovingTransforms;
		this.assumedVarDomainCardinality = positiveOrDefault(builder.assumedVarDomainCardinality, DEFAULT_VAR_DOMAIN);
		this.optionalMatchRate = nonNegativeOrDefault(builder.optionalMatchRate, DEFAULT_OPTIONAL_MATCH_RATE);
		this.optionalMultiplicity = nonNegativeOrDefault(builder.optionalMultiplicity, DEFAULT_OPTIONAL_MULTIPLICITY);
		this.debugLogging = builder.debugLogging;
		this.simulateJoinOrder = builder.simulateJoinOrder;
		this.maxBindingSetAssignmentUnionSize = nonNegativeOrDefault(builder.maxBindingSetAssignmentUnionSize,
				DEFAULT_MAX_BSA_UNION_DISTRIBUTION);
		this.enableMinusUnionSplit = builder.enableMinusUnionSplit;
		this.enableOptionalFilterJoin = builder.enableOptionalFilterJoin;
	}

	public static SparqlUoConfig defaultConfig() {
		return builder().build();
	}

	public static SparqlUoConfig fromSystemProperties() {
		Builder builder = builder();
		Boolean allowNonImproving = readBoolean(PROP_ALLOW_NON_IMPROVING);
		if (allowNonImproving != null) {
			builder.allowNonImprovingTransforms(allowNonImproving);
		}
		Double varDomain = readDouble(PROP_VAR_DOMAIN);
		if (varDomain != null) {
			builder.assumedVarDomainCardinality(varDomain);
		}
		Double matchRate = readDouble(PROP_OPTIONAL_MATCH_RATE);
		if (matchRate != null) {
			builder.optionalMatchRate(matchRate);
		}
		Double multiplicity = readDouble(PROP_OPTIONAL_MULTIPLICITY);
		if (multiplicity != null) {
			builder.optionalMultiplicity(multiplicity);
		}
		Boolean debug = readBoolean(PROP_DEBUG_LOGGING);
		if (debug != null) {
			builder.debugLogging(debug);
		}
		Boolean simulateJoinOrder = readBoolean(PROP_SIMULATE_JOIN_ORDER);
		if (simulateJoinOrder != null) {
			builder.simulateJoinOrder(simulateJoinOrder);
		}
		Integer maxBsaUnion = readInt(PROP_MAX_BSA_UNION_DISTRIBUTION);
		if (maxBsaUnion != null) {
			builder.maxBindingSetAssignmentUnionSize(maxBsaUnion);
		}
		Boolean enableMinusUnionSplit = readBoolean(PROP_ENABLE_MINUS_UNION_SPLIT);
		if (enableMinusUnionSplit != null) {
			builder.enableMinusUnionSplit(enableMinusUnionSplit);
		}
		Boolean enableOptionalFilterJoin = readBoolean(PROP_ENABLE_OPTIONAL_FILTER_JOIN);
		if (enableOptionalFilterJoin != null) {
			builder.enableOptionalFilterJoin(enableOptionalFilterJoin);
		}
		return builder.build();
	}

	public static Builder builder() {
		return new Builder();
	}

	public boolean allowNonImprovingTransforms() {
		return allowNonImprovingTransforms;
	}

	public double assumedVarDomainCardinality() {
		return assumedVarDomainCardinality;
	}

	public double optionalMatchRate() {
		return optionalMatchRate;
	}

	public double optionalMultiplicity() {
		return optionalMultiplicity;
	}

	public boolean debugLogging() {
		return debugLogging;
	}

	public boolean simulateJoinOrder() {
		return simulateJoinOrder;
	}

	public int maxBindingSetAssignmentUnionSize() {
		return maxBindingSetAssignmentUnionSize;
	}

	public boolean enableMinusUnionSplit() {
		return enableMinusUnionSplit;
	}

	public boolean enableOptionalFilterJoin() {
		return enableOptionalFilterJoin;
	}

	private static Boolean readBoolean(String property) {
		String value = System.getProperty(property);
		if (value == null) {
			return null;
		}
		return Boolean.parseBoolean(value);
	}

	private static Double readDouble(String property) {
		String value = System.getProperty(property);
		if (value == null) {
			return null;
		}
		try {
			return Double.parseDouble(value);
		} catch (NumberFormatException ignore) {
			return null;
		}
	}

	private static Integer readInt(String property) {
		String value = System.getProperty(property);
		if (value == null) {
			return null;
		}
		try {
			return Integer.parseInt(value);
		} catch (NumberFormatException ignore) {
			return null;
		}
	}

	private static double positiveOrDefault(double value, double fallback) {
		return value > 0.0 ? value : fallback;
	}

	private static double nonNegativeOrDefault(double value, double fallback) {
		return value >= 0.0 ? value : fallback;
	}

	private static int nonNegativeOrDefault(int value, int fallback) {
		return value >= 0 ? value : fallback;
	}

	public static final class Builder {
		private boolean allowNonImprovingTransforms = DEFAULT_ALLOW_NON_IMPROVING;
		private double assumedVarDomainCardinality = DEFAULT_VAR_DOMAIN;
		private double optionalMatchRate = DEFAULT_OPTIONAL_MATCH_RATE;
		private double optionalMultiplicity = DEFAULT_OPTIONAL_MULTIPLICITY;
		private boolean debugLogging = DEFAULT_DEBUG_LOGGING;
		private boolean simulateJoinOrder = DEFAULT_SIMULATE_JOIN_ORDER;
		private int maxBindingSetAssignmentUnionSize = DEFAULT_MAX_BSA_UNION_DISTRIBUTION;
		private boolean enableMinusUnionSplit = DEFAULT_ENABLE_MINUS_UNION_SPLIT;
		private boolean enableOptionalFilterJoin = DEFAULT_ENABLE_OPTIONAL_FILTER_JOIN;

		private Builder() {
		}

		public Builder allowNonImprovingTransforms(boolean allowNonImprovingTransforms) {
			this.allowNonImprovingTransforms = allowNonImprovingTransforms;
			return this;
		}

		public Builder assumedVarDomainCardinality(double assumedVarDomainCardinality) {
			this.assumedVarDomainCardinality = assumedVarDomainCardinality;
			return this;
		}

		public Builder optionalMatchRate(double optionalMatchRate) {
			this.optionalMatchRate = optionalMatchRate;
			return this;
		}

		public Builder optionalMultiplicity(double optionalMultiplicity) {
			this.optionalMultiplicity = optionalMultiplicity;
			return this;
		}

		public Builder debugLogging(boolean debugLogging) {
			this.debugLogging = debugLogging;
			return this;
		}

		public Builder simulateJoinOrder(boolean simulateJoinOrder) {
			this.simulateJoinOrder = simulateJoinOrder;
			return this;
		}

		public Builder maxBindingSetAssignmentUnionSize(int maxBindingSetAssignmentUnionSize) {
			this.maxBindingSetAssignmentUnionSize = maxBindingSetAssignmentUnionSize;
			return this;
		}

		public Builder enableMinusUnionSplit(boolean enableMinusUnionSplit) {
			this.enableMinusUnionSplit = enableMinusUnionSplit;
			return this;
		}

		public Builder enableOptionalFilterJoin(boolean enableOptionalFilterJoin) {
			this.enableOptionalFilterJoin = enableOptionalFilterJoin;
			return this;
		}

		public SparqlUoConfig build() {
			return new SparqlUoConfig(this);
		}
	}
}
