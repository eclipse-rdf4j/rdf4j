/*******************************************************************************
 * Copyright (c) 2025 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.query.algebra.evaluation.optimizer;

import java.util.Collection;

import org.eclipse.rdf4j.query.BindingSet;
import org.eclipse.rdf4j.query.Dataset;
import org.eclipse.rdf4j.query.algebra.BindingSetAssignment;
import org.eclipse.rdf4j.query.algebra.Join;
import org.eclipse.rdf4j.query.algebra.TupleExpr;
import org.eclipse.rdf4j.query.algebra.Union;
import org.eclipse.rdf4j.query.algebra.evaluation.QueryOptimizer;
import org.eclipse.rdf4j.query.algebra.helpers.AbstractSimpleQueryModelVisitor;

/**
 * Distributes small {@link BindingSetAssignment} joins across {@link Union} branches so VALUES filtering happens inside
 * each branch instead of forcing a scope-change hash join.
 */
public class BindingSetAssignmentUnionOptimizer implements QueryOptimizer {

	private final int maxBindingSetAssignmentSize;

	public BindingSetAssignmentUnionOptimizer(int maxBindingSetAssignmentSize) {
		this.maxBindingSetAssignmentSize = maxBindingSetAssignmentSize;
	}

	@Override
	public void optimize(TupleExpr tupleExpr, Dataset dataset, BindingSet bindings) {
		tupleExpr.visit(new BindingSetAssignmentUnionVisitor());
	}

	private final class BindingSetAssignmentUnionVisitor extends AbstractSimpleQueryModelVisitor<RuntimeException> {
		@Override
		public void meet(Join join) {
			super.meet(join);

			TupleExpr leftArg = join.getLeftArg();
			TupleExpr rightArg = join.getRightArg();

			if (leftArg instanceof BindingSetAssignment && rightArg instanceof Union) {
				BindingSetAssignment bsa = (BindingSetAssignment) leftArg;
				if (isSmallBindingSetAssignment(bsa)) {
					Union union = (Union) rightArg;
					Join leftJoin = new Join(bsa.clone(), union.getLeftArg());
					Join rightJoin = new Join(bsa.clone(), union.getRightArg());
					Union newUnion = new Union(leftJoin, rightJoin);
					newUnion.setVariableScopeChange(union.isVariableScopeChange());
					join.replaceWith(newUnion);
					newUnion.visit(this);
				}
			} else if (rightArg instanceof BindingSetAssignment && leftArg instanceof Union) {
				BindingSetAssignment bsa = (BindingSetAssignment) rightArg;
				if (isSmallBindingSetAssignment(bsa)) {
					Union union = (Union) leftArg;
					Join leftJoin = new Join(union.getLeftArg(), bsa.clone());
					Join rightJoin = new Join(union.getRightArg(), bsa.clone());
					Union newUnion = new Union(leftJoin, rightJoin);
					newUnion.setVariableScopeChange(union.isVariableScopeChange());
					join.replaceWith(newUnion);
					newUnion.visit(this);
				}
			}
		}
	}

	private boolean isSmallBindingSetAssignment(BindingSetAssignment bindingSetAssignment) {
		if (maxBindingSetAssignmentSize <= 0) {
			return false;
		}
		Iterable<BindingSet> bindingSets = bindingSetAssignment.getBindingSets();
		if (bindingSets instanceof Collection<?>) {
			return ((Collection<?>) bindingSets).size() <= maxBindingSetAssignmentSize;
		}
		return false;
	}
}
