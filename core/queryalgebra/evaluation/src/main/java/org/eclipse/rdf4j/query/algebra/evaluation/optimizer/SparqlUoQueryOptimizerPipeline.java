/*******************************************************************************
 * Copyright (c) 2025 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.query.algebra.evaluation.optimizer;

import java.util.ArrayList;
import java.util.List;

import org.eclipse.rdf4j.query.algebra.evaluation.EvaluationStrategy;
import org.eclipse.rdf4j.query.algebra.evaluation.QueryOptimizer;
import org.eclipse.rdf4j.query.algebra.evaluation.QueryOptimizerPipeline;
import org.eclipse.rdf4j.query.algebra.evaluation.TripleSource;
import org.eclipse.rdf4j.query.algebra.evaluation.impl.EvaluationStatistics;
import org.eclipse.rdf4j.query.algebra.evaluation.optimizer.sparqluo.SparqlUoConfig;

public class SparqlUoQueryOptimizerPipeline implements QueryOptimizerPipeline {

	private final QueryOptimizerPipeline delegate;
	private final SparqlUoOptimizer sparqlUoOptimizer;

	public SparqlUoQueryOptimizerPipeline(EvaluationStrategy strategy, TripleSource tripleSource,
			EvaluationStatistics evaluationStatistics) {
		this(strategy, tripleSource, evaluationStatistics, SparqlUoConfig.fromSystemProperties());
	}

	public SparqlUoQueryOptimizerPipeline(EvaluationStrategy strategy, TripleSource tripleSource,
			EvaluationStatistics evaluationStatistics, SparqlUoConfig config) {
		this.delegate = new StandardQueryOptimizerPipeline(strategy, tripleSource, evaluationStatistics);
		this.sparqlUoOptimizer = new SparqlUoOptimizer(evaluationStatistics, config);
	}

	@Override
	public Iterable<QueryOptimizer> getOptimizers() {
		List<QueryOptimizer> optimizers = new ArrayList<>();
		boolean inserted = false;
		for (QueryOptimizer optimizer : delegate.getOptimizers()) {
			if (!inserted && optimizer instanceof QueryJoinOptimizer) {
				optimizers.add(sparqlUoOptimizer);
				inserted = true;
			}
			optimizers.add(optimizer);
		}
		if (!inserted) {
			optimizers.add(sparqlUoOptimizer);
		}
		return optimizers;
	}
}
