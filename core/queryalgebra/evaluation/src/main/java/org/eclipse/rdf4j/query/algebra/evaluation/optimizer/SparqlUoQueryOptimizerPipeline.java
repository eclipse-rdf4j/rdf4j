/*******************************************************************************
 * Copyright (c) 2025 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.query.algebra.evaluation.optimizer;

import java.util.ArrayList;
import java.util.List;

import org.eclipse.rdf4j.query.algebra.evaluation.EvaluationStrategy;
import org.eclipse.rdf4j.query.algebra.evaluation.QueryOptimizer;
import org.eclipse.rdf4j.query.algebra.evaluation.QueryOptimizerPipeline;
import org.eclipse.rdf4j.query.algebra.evaluation.TripleSource;
import org.eclipse.rdf4j.query.algebra.evaluation.impl.EvaluationStatistics;
import org.eclipse.rdf4j.query.algebra.evaluation.optimizer.sparqluo.SparqlUoConfig;

public class SparqlUoQueryOptimizerPipeline implements QueryOptimizerPipeline {

	private final QueryOptimizerPipeline delegate;
	private final SparqlUoOptimizer sparqlUoOptimizer;
	private final BindingSetAssignmentUnionOptimizer bindingSetAssignmentUnionOptimizer;
	private final UnionCommonStatementPatternOptimizer unionCommonStatementPatternOptimizer;
	private final UnionCommonFilterBindingSetOptimizer unionCommonFilterBindingSetOptimizer;
	private final OptionalFilterJoinOptimizer optionalFilterJoinOptimizer;
	private final MinusOptimizer minusOptimizer;
	private final ExistsConstantOptimizer existsConstantOptimizer;
	private final QueryJoinOptimizer joinOptimizer;

	public SparqlUoQueryOptimizerPipeline(EvaluationStrategy strategy, TripleSource tripleSource,
			EvaluationStatistics evaluationStatistics) {
		this(strategy, tripleSource, evaluationStatistics, SparqlUoConfig.fromSystemProperties());
	}

	public SparqlUoQueryOptimizerPipeline(EvaluationStrategy strategy, TripleSource tripleSource,
			EvaluationStatistics evaluationStatistics, SparqlUoConfig config) {
		this.delegate = new StandardQueryOptimizerPipeline(strategy, tripleSource, evaluationStatistics);
		this.sparqlUoOptimizer = new SparqlUoOptimizer(evaluationStatistics, config);
		this.bindingSetAssignmentUnionOptimizer = new BindingSetAssignmentUnionOptimizer(
				config.maxBindingSetAssignmentUnionSize());
		this.unionCommonStatementPatternOptimizer = new UnionCommonStatementPatternOptimizer(evaluationStatistics);
		this.unionCommonFilterBindingSetOptimizer = new UnionCommonFilterBindingSetOptimizer();
		this.optionalFilterJoinOptimizer = new OptionalFilterJoinOptimizer();
		this.minusOptimizer = new MinusOptimizer(config.enableMinusUnionSplit());
		this.existsConstantOptimizer = new ExistsConstantOptimizer();
		this.joinOptimizer = new QueryJoinOptimizer(evaluationStatistics, strategy.isTrackResultSize(), tripleSource,
				false);
	}

	@Override
	public Iterable<QueryOptimizer> getOptimizers() {
		List<QueryOptimizer> optimizers = new ArrayList<>();
		boolean inserted = false;
		boolean bindingSetUnionInserted = false;
		boolean statementPatternInserted = false;
		for (QueryOptimizer optimizer : delegate.getOptimizers()) {
			if (optimizer instanceof QueryJoinOptimizer) {
				if (!inserted) {
					optimizers.add(existsConstantOptimizer);
					optimizers.add(minusOptimizer);
					optimizers.add(sparqlUoOptimizer);
					inserted = true;
				}
				optimizers.add(joinOptimizer);
				continue;
			}
			if (optimizer instanceof FilterOptimizer) {
				optimizers.add(optimizer);
				optimizers.add(unionCommonFilterBindingSetOptimizer);
				optimizers.add(optionalFilterJoinOptimizer);
				if (!statementPatternInserted) {
					optimizers.add(unionCommonStatementPatternOptimizer);
					statementPatternInserted = true;
				}
				continue;
			}
			optimizers.add(optimizer);
			if (optimizer instanceof IterativeEvaluationOptimizer) {
				optimizers.add(bindingSetAssignmentUnionOptimizer);
				bindingSetUnionInserted = true;
			}
		}
		if (!inserted) {
			optimizers.add(existsConstantOptimizer);
			optimizers.add(minusOptimizer);
			optimizers.add(sparqlUoOptimizer);
			optimizers.add(joinOptimizer);
		}
		if (!bindingSetUnionInserted) {
			optimizers.add(bindingSetAssignmentUnionOptimizer);
		}
		if (!statementPatternInserted) {
			optimizers.add(unionCommonStatementPatternOptimizer);
		}
		return optimizers;
	}
}
