/*******************************************************************************
 * Copyright (c) 2025 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.query.algebra.evaluation.impl.evaluationsteps;

import org.eclipse.rdf4j.query.algebra.FunctionCall;
import org.eclipse.rdf4j.query.algebra.QueryModelNode;
import org.eclipse.rdf4j.query.algebra.evaluation.function.Function;
import org.eclipse.rdf4j.query.algebra.evaluation.function.FunctionRegistry;
import org.eclipse.rdf4j.query.algebra.helpers.AbstractQueryModelVisitor;

final class DeterminismChecks {

	private DeterminismChecks() {
	}

	static boolean containsNonDeterministicFunction(QueryModelNode node) {
		if (node == null) {
			return false;
		}
		try {
			node.visit(new AbstractQueryModelVisitor<RuntimeException>() {
				@Override
				public void meet(FunctionCall functionCall) {
					if (isNonDeterministic(functionCall)) {
						throw NonDeterministicFunctionException.INSTANCE;
					}
					super.meet(functionCall);
				}
			});
			return false;
		} catch (NonDeterministicFunctionException e) {
			return true;
		}
	}

	private static boolean isNonDeterministic(FunctionCall functionCall) {
		return FunctionRegistry.getInstance()
				.get(functionCall.getURI())
				.map(Function::mustReturnDifferentResult)
				.orElse(true);
	}

	private static final class NonDeterministicFunctionException extends RuntimeException {
		private static final NonDeterministicFunctionException INSTANCE = new NonDeterministicFunctionException();

		@Override
		public synchronized Throwable fillInStackTrace() {
			return this;
		}
	}
}
