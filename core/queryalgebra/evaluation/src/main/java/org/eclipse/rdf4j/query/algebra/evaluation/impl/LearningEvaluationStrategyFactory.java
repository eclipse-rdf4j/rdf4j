/*******************************************************************************
 * Copyright (c) 2026 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.query.algebra.evaluation.impl;

import java.util.Objects;

import org.eclipse.rdf4j.query.Dataset;
import org.eclipse.rdf4j.query.algebra.evaluation.EvaluationStrategy;
import org.eclipse.rdf4j.query.algebra.evaluation.TripleSource;
import org.eclipse.rdf4j.query.algebra.evaluation.federation.FederatedServiceResolver;
import org.eclipse.rdf4j.query.algebra.evaluation.optimizer.JoinStatsProvider;
import org.eclipse.rdf4j.query.algebra.evaluation.optimizer.LearningQueryOptimizerPipeline;
import org.eclipse.rdf4j.query.algebra.evaluation.optimizer.LearningTripleSource;
import org.eclipse.rdf4j.query.algebra.evaluation.optimizer.MemoryJoinStats;

/**
 * Evaluation strategy factory that injects a learned join optimizer.
 */
public class LearningEvaluationStrategyFactory extends DefaultEvaluationStrategyFactory {

	private final JoinStatsProvider statsProvider;
	private final EvaluationStatistics optimizerStatisticsOverride;

	public LearningEvaluationStrategyFactory() {
		this(new MemoryJoinStats(), null);
	}

	public LearningEvaluationStrategyFactory(FederatedServiceResolver resolver) {
		this(new MemoryJoinStats(), null);
		setFederatedServiceResolver(resolver);
	}

	public LearningEvaluationStrategyFactory(EvaluationStatistics optimizerStatisticsOverride) {
		this(new MemoryJoinStats(), optimizerStatisticsOverride);
	}

	public LearningEvaluationStrategyFactory(JoinStatsProvider statsProvider) {
		this(statsProvider, null);
	}

	public LearningEvaluationStrategyFactory(JoinStatsProvider statsProvider,
			EvaluationStatistics optimizerStatisticsOverride) {
		this.statsProvider = Objects.requireNonNull(statsProvider, "statsProvider");
		this.optimizerStatisticsOverride = optimizerStatisticsOverride;
	}

	public JoinStatsProvider getStatsProvider() {
		return statsProvider;
	}

	@Override
	public EvaluationStrategy createEvaluationStrategy(Dataset dataset, TripleSource tripleSource,
			EvaluationStatistics evaluationStatistics) {
		TripleSource learningTripleSource = new LearningTripleSource(tripleSource, statsProvider);
		EvaluationStrategy strategy = super.createEvaluationStrategy(dataset, learningTripleSource,
				evaluationStatistics);
		EvaluationStatistics optimizerStatistics = optimizerStatisticsOverride != null
				? optimizerStatisticsOverride
				: evaluationStatistics;
		strategy.setOptimizerPipeline(
				new LearningQueryOptimizerPipeline(strategy, learningTripleSource, optimizerStatistics,
						statsProvider));
		return strategy;
	}
}
