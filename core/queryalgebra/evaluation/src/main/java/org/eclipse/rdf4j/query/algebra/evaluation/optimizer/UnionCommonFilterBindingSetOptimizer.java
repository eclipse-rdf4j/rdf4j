/*******************************************************************************
 * Copyright (c) 2025 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.query.algebra.evaluation.optimizer;

import org.eclipse.rdf4j.query.BindingSet;
import org.eclipse.rdf4j.query.Dataset;
import org.eclipse.rdf4j.query.algebra.BindingSetAssignment;
import org.eclipse.rdf4j.query.algebra.Filter;
import org.eclipse.rdf4j.query.algebra.Join;
import org.eclipse.rdf4j.query.algebra.TupleExpr;
import org.eclipse.rdf4j.query.algebra.Union;
import org.eclipse.rdf4j.query.algebra.ValueExpr;
import org.eclipse.rdf4j.query.algebra.evaluation.QueryOptimizer;
import org.eclipse.rdf4j.query.algebra.helpers.AbstractSimpleQueryModelVisitor;

/**
 * Pulls common Filters and VALUES (BindingSetAssignment) out of Union branches when both branches are identical.
 */
public class UnionCommonFilterBindingSetOptimizer implements QueryOptimizer {

	@Override
	public void optimize(TupleExpr tupleExpr, Dataset dataset, BindingSet bindings) {
		tupleExpr.visit(new UnionVisitor());
	}

	private static final class UnionVisitor extends AbstractSimpleQueryModelVisitor<RuntimeException> {
		@Override
		public void meet(Union union) {
			super.meet(union);

			TupleExpr replacement = pullUpCommonFilter(union);
			if (replacement != union) {
				union.replaceWith(replacement);
				replacement.visit(this);
				return;
			}

			replacement = pullUpCommonBindingSetAssignment(union);
			if (replacement != union) {
				union.replaceWith(replacement);
				replacement.visit(this);
			}
		}
	}

	private static TupleExpr pullUpCommonFilter(Union union) {
		if (!(union.getLeftArg() instanceof Filter) || !(union.getRightArg() instanceof Filter)) {
			return union;
		}
		Filter leftFilter = (Filter) union.getLeftArg();
		Filter rightFilter = (Filter) union.getRightArg();
		if (!sameCondition(leftFilter.getCondition(), rightFilter.getCondition())) {
			return union;
		}
		Union newUnion = new Union(leftFilter.getArg(), rightFilter.getArg());
		newUnion.setVariableScopeChange(union.isVariableScopeChange());
		return new Filter(newUnion, leftFilter.getCondition().clone());
	}

	private static TupleExpr pullUpCommonBindingSetAssignment(Union union) {
		if (!(union.getLeftArg() instanceof Join) || !(union.getRightArg() instanceof Join)) {
			return union;
		}
		Join leftJoin = (Join) union.getLeftArg();
		Join rightJoin = (Join) union.getRightArg();

		BindingSetAssignment leftBsa = bindingSetAssignment(leftJoin.getLeftArg());
		BindingSetAssignment rightBsa = bindingSetAssignment(rightJoin.getLeftArg());
		if (sameBindingSetAssignment(leftBsa, rightBsa)) {
			Union newUnion = new Union(leftJoin.getRightArg(), rightJoin.getRightArg());
			newUnion.setVariableScopeChange(union.isVariableScopeChange());
			return new Join(leftBsa.clone(), newUnion);
		}

		leftBsa = bindingSetAssignment(leftJoin.getRightArg());
		rightBsa = bindingSetAssignment(rightJoin.getRightArg());
		if (sameBindingSetAssignment(leftBsa, rightBsa)) {
			Union newUnion = new Union(leftJoin.getLeftArg(), rightJoin.getLeftArg());
			newUnion.setVariableScopeChange(union.isVariableScopeChange());
			return new Join(newUnion, leftBsa.clone());
		}

		return union;
	}

	private static boolean sameCondition(ValueExpr left, ValueExpr right) {
		if (left == right) {
			return true;
		}
		if (left == null || right == null) {
			return false;
		}
		return left.equals(right);
	}

	private static BindingSetAssignment bindingSetAssignment(TupleExpr expr) {
		if (expr instanceof BindingSetAssignment) {
			return (BindingSetAssignment) expr;
		}
		return null;
	}

	private static boolean sameBindingSetAssignment(BindingSetAssignment left, BindingSetAssignment right) {
		if (left == right) {
			return left != null;
		}
		if (left == null || right == null) {
			return false;
		}
		left.getAssuredBindingNames();
		right.getAssuredBindingNames();
		return left.equals(right);
	}
}
