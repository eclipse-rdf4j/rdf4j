/*******************************************************************************
 * Copyright (c) 2025 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.query.algebra.evaluation.impl.evaluationsteps;

import static org.assertj.core.api.Assertions.assertThat;

import java.util.List;

import org.eclipse.rdf4j.model.impl.SimpleValueFactory;
import org.eclipse.rdf4j.query.algebra.BindingSetAssignment;
import org.eclipse.rdf4j.query.algebra.LeftJoin;
import org.eclipse.rdf4j.query.algebra.evaluation.QueryBindingSet;
import org.eclipse.rdf4j.query.algebra.evaluation.impl.DefaultEvaluationStrategy;
import org.eclipse.rdf4j.query.algebra.evaluation.impl.EmptyTripleSource;
import org.eclipse.rdf4j.query.algebra.evaluation.impl.QueryEvaluationContext;
import org.eclipse.rdf4j.query.algebra.evaluation.iterator.HashJoinIteration;
import org.eclipse.rdf4j.query.algebra.evaluation.iterator.LeftJoinIterator;
import org.eclipse.rdf4j.query.impl.EmptyBindingSet;
import org.junit.jupiter.api.Test;

class LeftJoinQueryEvaluationStepTest {

	private static final String HASH_JOIN_PROPERTY = "rdf4j.optimizer.unionOptional.independentOptionalHashJoin.enabled";

	@Test
	void usesHashJoinForIndependentOptionalWithoutCondition() {
		SimpleValueFactory valueFactory = SimpleValueFactory.getInstance();
		QueryBindingSet leftBinding = new QueryBindingSet(1);
		leftBinding.addBinding("left", valueFactory.createLiteral(1));
		BindingSetAssignment left = new BindingSetAssignment();
		left.setBindingSets(List.of(leftBinding));

		QueryBindingSet rightBinding = new QueryBindingSet(1);
		rightBinding.addBinding("right", valueFactory.createLiteral(2));
		BindingSetAssignment right = new BindingSetAssignment();
		right.setBindingSets(List.of(rightBinding));

		LeftJoin leftJoin = new LeftJoin(left, right);
		DefaultEvaluationStrategy strategy = new DefaultEvaluationStrategy(new EmptyTripleSource(), null);
		QueryEvaluationContext context = new QueryEvaluationContext.Minimal(null);

		var step = LeftJoinQueryEvaluationStep.supply(strategy, leftJoin, context);
		try (var ignored = step.evaluate(EmptyBindingSet.getInstance())) {
			assertThat(leftJoin.getAlgorithmName()).isEqualTo(HashJoinIteration.class.getSimpleName());
		}
	}

	@Test
	void fallsBackToLeftJoinIteratorWhenHashJoinDisabled() {
		String previous = System.getProperty(HASH_JOIN_PROPERTY);
		System.setProperty(HASH_JOIN_PROPERTY, "false");
		try {
			SimpleValueFactory valueFactory = SimpleValueFactory.getInstance();
			QueryBindingSet leftBinding = new QueryBindingSet(1);
			leftBinding.addBinding("left", valueFactory.createLiteral(1));
			BindingSetAssignment left = new BindingSetAssignment();
			left.setBindingSets(List.of(leftBinding));

			QueryBindingSet rightBinding = new QueryBindingSet(1);
			rightBinding.addBinding("right", valueFactory.createLiteral(2));
			BindingSetAssignment right = new BindingSetAssignment();
			right.setBindingSets(List.of(rightBinding));

			LeftJoin leftJoin = new LeftJoin(left, right);
			DefaultEvaluationStrategy strategy = new DefaultEvaluationStrategy(new EmptyTripleSource(), null);
			QueryEvaluationContext context = new QueryEvaluationContext.Minimal(null);

			var step = LeftJoinQueryEvaluationStep.supply(strategy, leftJoin, context);
			try (var ignored = step.evaluate(EmptyBindingSet.getInstance())) {
				assertThat(leftJoin.getAlgorithmName()).isEqualTo(LeftJoinIterator.class.getSimpleName());
			}
		} finally {
			if (previous == null) {
				System.clearProperty(HASH_JOIN_PROPERTY);
			} else {
				System.setProperty(HASH_JOIN_PROPERTY, previous);
			}
		}
	}
}
