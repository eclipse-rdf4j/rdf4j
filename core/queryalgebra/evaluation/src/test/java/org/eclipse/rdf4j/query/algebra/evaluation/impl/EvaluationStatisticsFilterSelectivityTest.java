/*******************************************************************************
 * Copyright (c) 2025 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.query.algebra.evaluation.impl;

import static org.assertj.core.api.Assertions.assertThat;

import org.eclipse.rdf4j.model.IRI;
import org.eclipse.rdf4j.model.impl.SimpleValueFactory;
import org.eclipse.rdf4j.model.vocabulary.FN;
import org.eclipse.rdf4j.query.algebra.Compare;
import org.eclipse.rdf4j.query.algebra.Compare.CompareOp;
import org.eclipse.rdf4j.query.algebra.Extension;
import org.eclipse.rdf4j.query.algebra.ExtensionElem;
import org.eclipse.rdf4j.query.algebra.Filter;
import org.eclipse.rdf4j.query.algebra.FunctionCall;
import org.eclipse.rdf4j.query.algebra.Join;
import org.eclipse.rdf4j.query.algebra.Or;
import org.eclipse.rdf4j.query.algebra.StatementPattern;
import org.eclipse.rdf4j.query.algebra.ValueConstant;
import org.eclipse.rdf4j.query.algebra.Var;
import org.junit.jupiter.api.Test;

class EvaluationStatisticsFilterSelectivityTest {

	@Test
	void filterEqualityOnAliasLowersCardinalityEstimate() {
		SimpleValueFactory vf = SimpleValueFactory.getInstance();
		IRI nameIri = vf.createIRI("http://example.com/theme/social/name");
		StatementPattern namePattern = new StatementPattern(new Var("tag"), new Var("p", nameIri), new Var("tn"));
		Extension extension = new Extension(namePattern);
		extension.addElement(new ExtensionElem(new Var("tn"), "optTn"));

		Compare condition = new Compare(new Var("optTn"), new ValueConstant(vf.createLiteral("tag1")), CompareOp.EQ);
		Filter filter = new Filter(extension, condition);

		EvaluationStatistics stats = new EvaluationStatistics();
		StatementPattern boundPattern = new StatementPattern(new Var("tag"), new Var("p", nameIri),
				new Var("tn", vf.createLiteral("tag1")));
		double boundCardinality = stats.getCardinality(boundPattern);
		double unfiltered = stats.getCardinality(extension);
		double filtered = stats.getCardinality(filter);

		assertThat(filtered).isLessThan(unfiltered);
		assertThat(filtered).isLessThanOrEqualTo(boundCardinality);
	}

	@Test
	void filterEqualityOnAliasUsesBoundPatternEstimateAcrossJoin() {
		SimpleValueFactory vf = SimpleValueFactory.getInstance();
		IRI hasTagIri = vf.createIRI("http://example.com/theme/social/hasTag");
		IRI nameIri = vf.createIRI("http://example.com/theme/social/name");
		StatementPattern hasTagPattern = new StatementPattern(new Var("post"), new Var("p1", hasTagIri),
				new Var("tag"));
		StatementPattern namePattern = new StatementPattern(new Var("tag"), new Var("p2", nameIri), new Var("tn"));
		Join join = new Join(hasTagPattern, namePattern);
		Extension extension = new Extension(join);
		extension.addElement(new ExtensionElem(new Var("tn"), "optTn"));

		Compare condition = new Compare(new Var("optTn"), new ValueConstant(vf.createLiteral("tag1")), CompareOp.EQ);
		Filter filter = new Filter(extension, condition);

		EvaluationStatistics stats = new EvaluationStatistics();
		StatementPattern boundPattern = new StatementPattern(new Var("tag"), new Var("p2", nameIri),
				new Var("tn", vf.createLiteral("tag1")));
		double boundCardinality = stats.getCardinality(boundPattern);
		double filtered = stats.getCardinality(filter);

		assertThat(filtered).isLessThanOrEqualTo(boundCardinality);
	}

	@Test
	void filterRangeComparisonLowersCardinalityEstimate() {
		SimpleValueFactory vf = SimpleValueFactory.getInstance();
		IRI valueIri = vf.createIRI("http://example.com/theme/metric/value");
		StatementPattern pattern = new StatementPattern(new Var("s"), new Var("p", valueIri), new Var("v"));
		Compare condition = new Compare(new Var("v"), new ValueConstant(vf.createLiteral(10)), CompareOp.GT);
		Filter filter = new Filter(pattern, condition);

		EvaluationStatistics stats = new EvaluationStatistics();
		double unfiltered = stats.getCardinality(pattern);
		double filtered = stats.getCardinality(filter);

		assertThat(filtered).isLessThan(unfiltered);
	}

	@Test
	void filterRangeComparisonUsesStrongerSelectivity() {
		SimpleValueFactory vf = SimpleValueFactory.getInstance();
		IRI valueIri = vf.createIRI("http://example.com/theme/metric/value");
		StatementPattern pattern = new StatementPattern(new Var("s"), new Var("p", valueIri), new Var("v"));
		Compare condition = new Compare(new Var("v"), new ValueConstant(vf.createLiteral(10)), CompareOp.GT);
		Filter filter = new Filter(pattern, condition);

		EvaluationStatistics stats = new EvaluationStatistics();
		double unfiltered = stats.getCardinality(pattern);
		double filtered = stats.getCardinality(filter);

		assertThat(filtered).isLessThanOrEqualTo(unfiltered * 0.1);
	}

	@Test
	void filterContainsLowersCardinalityEstimate() {
		SimpleValueFactory vf = SimpleValueFactory.getInstance();
		IRI nameIri = vf.createIRI("http://example.com/theme/resource/name");
		StatementPattern pattern = new StatementPattern(new Var("s"), new Var("p", nameIri), new Var("name"));
		FunctionCall contains = new FunctionCall(FN.CONTAINS.stringValue(), new Var("name"),
				new ValueConstant(vf.createLiteral("alpha")));
		Filter filter = new Filter(pattern, contains);

		EvaluationStatistics stats = new EvaluationStatistics();
		double unfiltered = stats.getCardinality(pattern);
		double filtered = stats.getCardinality(filter);

		assertThat(filtered).isLessThan(unfiltered);
	}

	@Test
	void filterContainsUsesStrongerSelectivity() {
		SimpleValueFactory vf = SimpleValueFactory.getInstance();
		IRI nameIri = vf.createIRI("http://example.com/theme/resource/name");
		StatementPattern pattern = new StatementPattern(new Var("s"), new Var("p", nameIri), new Var("name"));
		FunctionCall contains = new FunctionCall(FN.CONTAINS.stringValue(), new Var("name"),
				new ValueConstant(vf.createLiteral("alpha")));
		Filter filter = new Filter(pattern, contains);

		EvaluationStatistics stats = new EvaluationStatistics();
		double unfiltered = stats.getCardinality(pattern);
		double filtered = stats.getCardinality(filter);

		assertThat(filtered).isLessThanOrEqualTo(unfiltered * 0.05);
	}

	@Test
	void filterContainsOnAliasCapsEstimateByPatternCardinality() {
		SimpleValueFactory vf = SimpleValueFactory.getInstance();
		IRI nameIri = vf.createIRI("http://example.com/theme/resource/name");
		StatementPattern broadPattern = new StatementPattern(new Var("s"), new Var("p"), new Var("o"));
		StatementPattern namePattern = new StatementPattern(new Var("s"), new Var("pName", nameIri),
				new Var("name"));
		Join join = new Join(broadPattern, namePattern);
		Extension extension = new Extension(join);
		extension.addElement(new ExtensionElem(new Var("name"), "n"));

		FunctionCall contains = new FunctionCall(FN.CONTAINS.stringValue(), new Var("n"),
				new ValueConstant(vf.createLiteral("alpha")));
		Filter filter = new Filter(extension, contains);

		EvaluationStatistics stats = new EvaluationStatistics();
		double filtered = stats.getCardinality(filter);
		double nameCardinality = stats.getCardinality(namePattern);

		assertThat(filtered).isLessThanOrEqualTo(nameCardinality * 0.05);
	}

	@Test
	void filterOrContainsLowersCardinalityEstimate() {
		SimpleValueFactory vf = SimpleValueFactory.getInstance();
		IRI nameIri = vf.createIRI("http://example.com/theme/resource/name");
		StatementPattern pattern = new StatementPattern(new Var("s"), new Var("p", nameIri), new Var("name"));
		FunctionCall left = new FunctionCall(FN.CONTAINS.stringValue(), new Var("name"),
				new ValueConstant(vf.createLiteral("alpha")));
		FunctionCall right = new FunctionCall(FN.CONTAINS.stringValue(), new Var("name"),
				new ValueConstant(vf.createLiteral("beta")));
		Filter filter = new Filter(pattern, new Or(left, right));

		EvaluationStatistics stats = new EvaluationStatistics();
		double unfiltered = stats.getCardinality(pattern);
		double filtered = stats.getCardinality(filter);

		assertThat(filtered).isLessThan(unfiltered);
	}
}
