/*******************************************************************************
 * Copyright (c) 2025 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.query.algebra.evaluation.optimizer;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.within;

import org.eclipse.rdf4j.model.IRI;
import org.eclipse.rdf4j.model.impl.SimpleValueFactory;
import org.eclipse.rdf4j.query.algebra.Compare;
import org.eclipse.rdf4j.query.algebra.Filter;
import org.eclipse.rdf4j.query.algebra.Join;
import org.eclipse.rdf4j.query.algebra.LeftJoin;
import org.eclipse.rdf4j.query.algebra.StatementPattern;
import org.eclipse.rdf4j.query.algebra.Union;
import org.eclipse.rdf4j.query.algebra.ValueConstant;
import org.eclipse.rdf4j.query.algebra.Var;
import org.eclipse.rdf4j.query.algebra.evaluation.impl.EvaluationStatistics;
import org.junit.jupiter.api.Test;

class CardinalityEstimatorTest {

	@Test
	void estimatesUnionRowsAsSum() {
		StatementPattern left = statementPattern("s", "p", "o", 10.0);
		StatementPattern right = statementPattern("s2", "p2", "o2", 20.0);
		Union union = new Union(left, right);

		CardinalityEstimator estimator = new CardinalityEstimator(new EvaluationStatistics());
		CardinalityEstimator.Estimate estimate = estimator.estimate(union);

		assertThat(estimate.getRows()).isEqualTo(30.0);
		assertThat(estimate.getWork()).isEqualTo(30.0);
	}

	@Test
	void estimatesJoinRowsAsProductWhenNoSharedVars() {
		StatementPattern left = statementPattern("s1", "p1", "o1", 10.0);
		StatementPattern right = statementPattern("s2", "p2", "o2", 5.0);
		Join join = new Join(left, right);

		CardinalityEstimator estimator = new CardinalityEstimator(new EvaluationStatistics());
		CardinalityEstimator.Estimate estimate = estimator.estimate(join);

		assertThat(estimate.getRows()).isEqualTo(50.0);
	}

	@Test
	void estimatesJoinRowsWithSharedVarsUsesSelectivity() {
		StatementPattern left = statementPattern("s", "p1", "o1", 10.0);
		StatementPattern right = statementPattern("s", "p2", "o2", 6.0);
		Join join = new Join(left, right);

		CardinalityEstimator estimator = new CardinalityEstimator(new EvaluationStatistics());
		CardinalityEstimator.Estimate estimate = estimator.estimate(join);

		assertThat(estimate.getRows()).isCloseTo(3.6, within(1.0e-9));
	}

	@Test
	void estimatesLeftJoinRowsAsLeftRows() {
		StatementPattern left = statementPattern("s", "p", "o", 12.0);
		StatementPattern right = statementPattern("s", "p2", "o2", 6.0);
		LeftJoin leftJoin = new LeftJoin(left, right);

		CardinalityEstimator estimator = new CardinalityEstimator(new EvaluationStatistics());
		CardinalityEstimator.Estimate estimate = estimator.estimate(leftJoin);

		assertThat(estimate.getRows()).isEqualTo(12.0);
	}

	@Test
	void estimatesLeftJoinRowsAsProductWhenIndependent() {
		StatementPattern left = statementPattern("s", "p", "o", 12.0);
		StatementPattern right = statementPattern("t", "p2", "o2", 6.0);
		LeftJoin leftJoin = new LeftJoin(left, right);

		CardinalityEstimator estimator = new CardinalityEstimator(new EvaluationStatistics());
		CardinalityEstimator.Estimate estimate = estimator.estimate(leftJoin);

		assertThat(estimate.getRows()).isEqualTo(72.0);
	}

	@Test
	void scalesIndependentOptionalRightRowsWhenPredicateIsBound() {
		SimpleValueFactory valueFactory = SimpleValueFactory.getInstance();
		IRI leftPredicate = valueFactory.createIRI("http://example.com/p1");
		IRI rightPredicate = valueFactory.createIRI("http://example.com/p2");

		StatementPattern left = new StatementPattern(new Var("s"), new Var("p", leftPredicate), new Var("x"));
		StatementPattern right = new StatementPattern(new Var("t"), new Var("q", rightPredicate), new Var("y"));
		LeftJoin leftJoin = new LeftJoin(left, right);

		CardinalityEstimator estimator = new CardinalityEstimator(new EvaluationStatistics());
		CardinalityEstimator.Estimate estimate = estimator.estimate(leftJoin);

		assertThat(estimate.getRows()).isEqualTo(10_000.0);
	}

	@Test
	void usesResultSizeEstimateWhenLargerOutsideOptionalRightArg() {
		SimpleValueFactory valueFactory = SimpleValueFactory.getInstance();
		IRI predicate = valueFactory.createIRI("http://example.com/p1");

		StatementPattern pattern = new StatementPattern(new Var("s"), new Var("p", predicate), new Var("o"));
		pattern.setCardinality(100.0);
		pattern.setResultSizeEstimate(500.0);

		CardinalityEstimator estimator = new CardinalityEstimator(new EvaluationStatistics());
		CardinalityEstimator.Estimate estimate = estimator.estimate(pattern);

		assertThat(estimate.getRows()).isEqualTo(500.0);
	}

	@Test
	void scalesCorrelatedOptionalRightRowsWhenPredicateIsBound() {
		SimpleValueFactory valueFactory = SimpleValueFactory.getInstance();
		IRI leftPredicate = valueFactory.createIRI("http://example.com/p1");
		IRI rightPredicate = valueFactory.createIRI("http://example.com/p2");

		StatementPattern left = new StatementPattern(new Var("s"), new Var("p", leftPredicate), new Var("x"));
		StatementPattern right = new StatementPattern(new Var("s"), new Var("q", rightPredicate), new Var("y"));
		left.setCardinality(50.0);
		right.setCardinality(2.0);
		new LeftJoin(left, right);

		CardinalityEstimator estimator = new CardinalityEstimator(new EvaluationStatistics());
		CardinalityEstimator.Estimate rightEstimate = estimator.estimate(right);

		assertThat(rightEstimate.getRows()).isEqualTo(6.0);
	}

	@Test
	void scalesCorrelatedOptionalRightRowsWhenPredicateIsBoundLargeLeft() {
		SimpleValueFactory valueFactory = SimpleValueFactory.getInstance();
		IRI leftPredicate = valueFactory.createIRI("http://example.com/p1");
		IRI rightPredicate = valueFactory.createIRI("http://example.com/p2");

		StatementPattern left = new StatementPattern(new Var("s"), new Var("p", leftPredicate), new Var("x"));
		StatementPattern right = new StatementPattern(new Var("s"), new Var("q", rightPredicate), new Var("y"));
		left.setCardinality(4935.0);
		right.setCardinality(338.0);
		new LeftJoin(left, right);

		CardinalityEstimator estimator = new CardinalityEstimator(new EvaluationStatistics());
		CardinalityEstimator.Estimate rightEstimate = estimator.estimate(right);

		assertThat(rightEstimate.getRows()).isEqualTo(1690.0);
	}

	@Test
	void estimatesFilterSelectivityForRangeComparison() {
		SimpleValueFactory valueFactory = SimpleValueFactory.getInstance();
		StatementPattern pattern = statementPattern("s", "p", "y", 100.0);
		Compare compare = new Compare(new Var("y"),
				new ValueConstant(valueFactory.createLiteral(5)),
				Compare.CompareOp.LT);
		Filter filter = new Filter(pattern, compare);

		CardinalityEstimator estimator = new CardinalityEstimator(new EvaluationStatistics());
		CardinalityEstimator.Estimate estimate = estimator.estimate(filter);

		assertThat(estimate.getRows()).isEqualTo(10.0);
	}

	private static StatementPattern statementPattern(String subject, String predicate, String object,
			double cardinality) {
		StatementPattern pattern = new StatementPattern(new Var(subject), new Var(predicate), new Var(object));
		pattern.setCardinality(cardinality);
		return pattern;
	}
}
