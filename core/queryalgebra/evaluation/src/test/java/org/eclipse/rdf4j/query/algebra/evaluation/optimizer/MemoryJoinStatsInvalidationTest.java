/*******************************************************************************
 * Copyright (c) 2026 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.query.algebra.evaluation.optimizer;

import static org.junit.jupiter.api.Assertions.assertFalse;
import static org.junit.jupiter.api.Assertions.assertTrue;

import java.time.Clock;
import java.time.Duration;
import java.time.Instant;
import java.time.ZoneId;

import org.junit.jupiter.api.Test;

class MemoryJoinStatsInvalidationTest {

	private static final class MutableClock extends Clock {
		private Instant now;
		private final ZoneId zone;

		private MutableClock(Instant start, ZoneId zone) {
			this.now = start;
			this.zone = zone;
		}

		void advance(Duration duration) {
			now = now.plus(duration);
		}

		@Override
		public ZoneId getZone() {
			return zone;
		}

		@Override
		public Clock withZone(ZoneId zone) {
			return new MutableClock(now, zone);
		}

		@Override
		public Instant instant() {
			return now;
		}
	}

	@Test
	void invalidatesWhenThresholdReachedWithinWindow() throws Exception {
		PatternKey key = new PatternKey(null, PatternKey.SUBJECT_BOUND);
		MemoryJoinStats stats = new MemoryJoinStats();
		stats.recordCall(key);
		stats.recordResults(key, 1);
		assertTrue(stats.hasStats(key));

		MemoryJoinStats configured = newConfiguredStats(Duration.ofMinutes(5), 3);
		configured.recordCall(key);
		configured.recordResults(key, 1);
		assertTrue(configured.hasStats(key));

		configured.recordStatementsAdded(2);
		assertTrue(configured.hasStats(key));
		configured.recordStatementsAdded(1);
		assertFalse(configured.hasStats(key));
	}

	@Test
	void doesNotInvalidateAcrossWindowBoundary() throws Exception {
		PatternKey key = new PatternKey(null, PatternKey.SUBJECT_BOUND);
		MutableClock clock = new MutableClock(Instant.EPOCH, ZoneId.of("UTC"));
		MemoryJoinStats configured = newConfiguredStats(Duration.ofMinutes(5), 3, clock);
		configured.recordCall(key);
		configured.recordResults(key, 1);

		configured.recordStatementsAdded(2);
		clock.advance(Duration.ofMinutes(6));
		configured.recordStatementsAdded(1);

		assertTrue(configured.hasStats(key));
	}

	private static MemoryJoinStats newConfiguredStats(Duration window, long threshold) {
		return newConfiguredStats(window, threshold, new MutableClock(Instant.EPOCH, ZoneId.of("UTC")));
	}

	private static MemoryJoinStats newConfiguredStats(Duration window, long threshold, Clock clock) {
		MemoryJoinStats.InvalidationSettings settings = MemoryJoinStats.InvalidationSettings.of(window, threshold);
		return new MemoryJoinStats(settings, clock);
	}
}
