/*******************************************************************************
 * Copyright (c) 2025 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.query.algebra.evaluation.impl;

import static org.assertj.core.api.Assertions.assertThat;

import org.eclipse.rdf4j.query.QueryLanguage;
import org.eclipse.rdf4j.query.algebra.BindingSetAssignment;
import org.eclipse.rdf4j.query.algebra.Join;
import org.eclipse.rdf4j.query.algebra.LeftJoin;
import org.eclipse.rdf4j.query.algebra.Projection;
import org.eclipse.rdf4j.query.algebra.QueryRoot;
import org.eclipse.rdf4j.query.algebra.TupleExpr;
import org.eclipse.rdf4j.query.algebra.evaluation.optimizer.QueryModelNormalizerOptimizer;
import org.eclipse.rdf4j.query.impl.EmptyBindingSet;
import org.eclipse.rdf4j.query.parser.ParsedTupleQuery;
import org.eclipse.rdf4j.query.parser.QueryParserUtil;
import org.junit.jupiter.api.Test;

public class QueryModelNormalizerOptimizerTest {

	@Test
	public void testValuesJoinNotMovedAboveOptional() {
		String query = String.join("\n",
				"PREFIX : <http://example.org/>",
				"PREFIX foaf: <http://xmlns.com/foaf/0.1/>",
				"SELECT ?s ?o1 ?o2",
				"{",
				"  ?s ?p1 ?o1",
				"  OPTIONAL { ?s foaf:knows ?o2 }",
				"} VALUES (?o2) {",
				"  (:b)",
				"}"
		);

		ParsedTupleQuery parsedQuery = QueryParserUtil.parseTupleQuery(QueryLanguage.SPARQL, query, null);
		TupleExpr tupleExpr = parsedQuery.getTupleExpr();

		new QueryModelNormalizerOptimizer().optimize(tupleExpr, null, EmptyBindingSet.getInstance());

		TupleExpr optimized = ((QueryRoot) tupleExpr).getArg();
		assertThat(optimized).isInstanceOf(Projection.class);

		TupleExpr projectionArg = ((Projection) optimized).getArg();
		assertThat(projectionArg).isInstanceOf(Join.class);

		Join join = (Join) projectionArg;
		assertThat(join.getLeftArg()).isInstanceOf(BindingSetAssignment.class);
		assertThat(join.getRightArg()).isInstanceOf(LeftJoin.class);
	}
}
