/*******************************************************************************
 * Copyright (c) 2026 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.query.algebra.evaluation.optimizer.learned;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.fail;

import org.eclipse.rdf4j.query.algebra.StatementPattern;
import org.eclipse.rdf4j.query.algebra.Var;
import org.eclipse.rdf4j.query.algebra.evaluation.impl.EmptyTripleSource;
import org.eclipse.rdf4j.query.algebra.evaluation.impl.EvaluationStatistics;
import org.eclipse.rdf4j.query.algebra.evaluation.optimizer.JoinStatsProvider;
import org.eclipse.rdf4j.query.algebra.evaluation.optimizer.LearnedQueryJoinOptimizer;
import org.eclipse.rdf4j.query.algebra.evaluation.optimizer.PatternKey;
import org.junit.jupiter.api.Test;

class LearnedQueryJoinOptimizerFallbackTest {

	@Test
	void usesEvaluationStatisticsWhenLearnedStatsMissing() {
		EvaluationStatistics stats = new EvaluationStatistics();
		JoinStatsProvider statsProvider = new NoEstimateJoinStatsProvider();
		LearnedQueryJoinOptimizer optimizer = new LearnedQueryJoinOptimizer(stats, new EmptyTripleSource(),
				statsProvider);
		StatementPattern pattern = new StatementPattern(Var.of("s"), Var.of("p"), Var.of("o"));

		optimizer.optimize(pattern, null, null);

		assertEquals(stats.getCardinality(pattern), pattern.getResultSizeEstimate());
	}

	private static final class NoEstimateJoinStatsProvider implements JoinStatsProvider {

		@Override
		public void reset() {
		}

		@Override
		public void recordCall(PatternKey key) {
		}

		@Override
		public void recordResults(PatternKey key, long resultCount) {
		}

		@Override
		public void seedIfAbsent(PatternKey key, double defaultCardinality, long priorCalls) {
			fail("seedIfAbsent should not run when no learned estimate exists");
		}

		@Override
		public double getAverageResults(PatternKey key) {
			fail("getAverageResults should not run when no learned estimate exists");
			return 0.0d;
		}

		@Override
		public boolean hasStats(PatternKey key) {
			return false;
		}

		@Override
		public long getTotalCalls() {
			return 0;
		}
	}
}
