/*******************************************************************************
 * Copyright (c) 2026 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.query.algebra.evaluation.optimizer.learned;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertTrue;

import org.eclipse.rdf4j.model.impl.SimpleValueFactory;
import org.eclipse.rdf4j.query.algebra.Join;
import org.eclipse.rdf4j.query.algebra.QueryRoot;
import org.eclipse.rdf4j.query.algebra.StatementPattern;
import org.eclipse.rdf4j.query.algebra.Var;
import org.eclipse.rdf4j.query.algebra.evaluation.impl.EmptyTripleSource;
import org.eclipse.rdf4j.query.algebra.evaluation.impl.EvaluationStatistics;
import org.eclipse.rdf4j.query.algebra.evaluation.optimizer.JoinStatsProvider;
import org.eclipse.rdf4j.query.algebra.evaluation.optimizer.LearnedQueryJoinOptimizer;
import org.eclipse.rdf4j.query.algebra.evaluation.optimizer.PatternKey;
import org.junit.jupiter.api.Test;

class LearnedQueryJoinOptimizerFallbackTest {

	@Test
	void seedsDefaultStatsWhenLearnedStatsMissing() {
		EvaluationStatistics stats = new EvaluationStatistics();
		SeedTrackingStatsProvider statsProvider = new SeedTrackingStatsProvider();
		LearnedQueryJoinOptimizer optimizer = new LearnedQueryJoinOptimizer(stats, new EmptyTripleSource(),
				statsProvider);
		StatementPattern left = new StatementPattern(Var.of("s"),
				Var.of("p", SimpleValueFactory.getInstance().createIRI("urn:left")),
				Var.of("o"));
		StatementPattern right = new StatementPattern(Var.of("s"),
				Var.of("p", SimpleValueFactory.getInstance().createIRI("urn:right")),
				Var.of("o2"));
		Join join = new Join(left, right);

		QueryRoot root = new QueryRoot(join);
		optimizer.optimize(root, null, null);

		assertTrue(statsProvider.seedCalls > 0, "Expected default stats to be seeded");
		assertEquals(stats.getCardinality(left), left.getResultSizeEstimate());
	}

	private static final class SeedTrackingStatsProvider implements JoinStatsProvider {
		private int seedCalls;

		@Override
		public void reset() {
		}

		@Override
		public void recordCall(PatternKey key) {
		}

		@Override
		public void recordResults(PatternKey key, long resultCount) {
		}

		@Override
		public void seedIfAbsent(PatternKey key, double defaultCardinality, long priorCalls) {
			seedCalls++;
		}

		@Override
		public double getAverageResults(PatternKey key) {
			return 0.0d;
		}

		@Override
		public boolean hasStats(PatternKey key) {
			return false;
		}

		@Override
		public long getTotalCalls() {
			return 0;
		}
	}
}
