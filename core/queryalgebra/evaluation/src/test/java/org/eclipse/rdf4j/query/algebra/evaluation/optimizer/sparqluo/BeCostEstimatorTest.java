/*******************************************************************************
 * Copyright (c) 2025 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.query.algebra.evaluation.optimizer.sparqluo;

import static org.assertj.core.api.Assertions.assertThat;

import java.util.List;

import org.eclipse.rdf4j.model.IRI;
import org.eclipse.rdf4j.model.impl.SimpleValueFactory;
import org.eclipse.rdf4j.query.algebra.Join;
import org.eclipse.rdf4j.query.algebra.StatementPattern;
import org.eclipse.rdf4j.query.algebra.TupleExpr;
import org.eclipse.rdf4j.query.algebra.Var;
import org.eclipse.rdf4j.query.algebra.evaluation.impl.EvaluationStatistics;
import org.junit.jupiter.api.Test;

class BeCostEstimatorTest {

	@Test
	void estimateGroupResultSizeUsesSharedVars() {
		EvaluationStatistics statistics = new EvaluationStatistics() {
			@Override
			public double getCardinality(TupleExpr expr) {
				if (expr instanceof StatementPattern) {
					StatementPattern pattern = (StatementPattern) expr;
					Var predicate = pattern.getPredicateVar();
					if (predicate != null && predicate.hasValue()) {
						IRI iri = (IRI) predicate.getValue();
						if (iri.stringValue().endsWith("p1")) {
							return 100.0;
						}
						if (iri.stringValue().endsWith("p2")) {
							return 10.0;
						}
					}
				}
				if (expr instanceof Join) {
					return super.getCardinality(expr);
				}
				return super.getCardinality(expr);
			}
		};

		BeCostEstimator estimator = new BeCostEstimator(statistics);

		StatementPattern first = new StatementPattern(
				new Var("s"),
				new Var("p1", SimpleValueFactory.getInstance().createIRI("urn:p1")),
				new Var("o1"));
		StatementPattern second = new StatementPattern(
				new Var("s"),
				new Var("p2", SimpleValueFactory.getInstance().createIRI("urn:p2")),
				new Var("o2"));

		BeGroupNode group = new BeGroupNode();
		group.addChild(new BeBgpNode(List.of(first)));
		group.addChild(new BeBgpNode(List.of(second)));

		double resultSize = estimator.estimateGroupResultSize(group);
		assertThat(resultSize).isEqualTo(100.0);
	}

	@Test
	void optionalResultSizeDoesNotShrinkBelowLeft() {
		EvaluationStatistics statistics = new EvaluationStatistics() {
			@Override
			public double getCardinality(TupleExpr expr) {
				if (expr instanceof StatementPattern) {
					StatementPattern pattern = (StatementPattern) expr;
					Var predicate = pattern.getPredicateVar();
					if (predicate != null && predicate.hasValue()) {
						IRI iri = (IRI) predicate.getValue();
						if (iri.stringValue().endsWith("pLeft")) {
							return 100.0;
						}
						if (iri.stringValue().endsWith("pRight")) {
							return 0.01;
						}
					}
				}
				return super.getCardinality(expr);
			}
		};

		BeCostEstimator estimator = new BeCostEstimator(statistics);

		StatementPattern leftPattern = new StatementPattern(
				new Var("s"),
				new Var("pLeft", SimpleValueFactory.getInstance().createIRI("urn:pLeft")),
				new Var("o"));
		StatementPattern rightPattern = new StatementPattern(
				new Var("s"),
				new Var("pRight", SimpleValueFactory.getInstance().createIRI("urn:pRight")),
				new Var("o2"));

		BeGroupNode optionalRight = new BeGroupNode();
		optionalRight.addChild(new BeBgpNode(List.of(rightPattern)));

		BeGroupNode group = new BeGroupNode();
		group.addChild(new BeBgpNode(List.of(leftPattern)));
		group.addChild(new BeOptionalNode(optionalRight, null));

		double resultSize = estimator.estimateGroupResultSize(group);
		assertThat(resultSize).isGreaterThanOrEqualTo(100.0);
	}
}
