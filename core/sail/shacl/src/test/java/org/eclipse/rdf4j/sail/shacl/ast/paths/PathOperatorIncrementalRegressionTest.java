/*******************************************************************************
 * Copyright (c) 2026 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex

package org.eclipse.rdf4j.sail.shacl.ast.paths;

import static org.junit.jupiter.api.Assertions.assertInstanceOf;
import static org.junit.jupiter.api.Assertions.assertThrows;

import org.eclipse.rdf4j.repository.RepositoryException;
import org.eclipse.rdf4j.repository.sail.SailRepository;
import org.eclipse.rdf4j.repository.sail.SailRepositoryConnection;
import org.eclipse.rdf4j.sail.memory.MemoryStore;
import org.eclipse.rdf4j.sail.shacl.ShaclSail;
import org.eclipse.rdf4j.sail.shacl.ShaclSailValidationException;
import org.junit.jupiter.api.Test;

public class PathOperatorIncrementalRegressionTest {

	private static final String PREFIXES = String.join("\n",
			"PREFIX ex: <http://example.com/ns#>",
			"PREFIX sh: <http://www.w3.org/ns/shacl#>",
			"PREFIX rdf4j: <http://rdf4j.org/schema/rdf4j#>",
			"PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>",
			"");

	@Test
	public void oneOrMorePathShouldCountDistinctReachableValuesOnly() {
		SailRepository repository = getRepository();
		try {
			executeUpdate(repository, oneOrMoreMinCountShape());
			assertCommitFailsWithValidationException(repository, duplicateReachabilityGraph());
		} finally {
			repository.shutDown();
		}
	}

	@Test
	public void zeroOrMorePathShouldCountDistinctReachableValuesOnly() {
		SailRepository repository = getRepository();
		try {
			executeUpdate(repository, zeroOrMoreMinCountShape());
			assertCommitFailsWithValidationException(repository, duplicateReachabilityGraph());
		} finally {
			repository.shutDown();
		}
	}

	@Test
	public void zeroOrMorePathShouldIgnoreUnrelatedPredicateUpdates() {
		SailRepository repository = getRepository();
		try {
			executeUpdate(repository, zeroOrMoreClassShape());
			executeUpdateWithValidationDisabled(repository, invalidBaselineData());
			executeUpdate(repository, unrelatedPredicateUpdate());
		} finally {
			repository.shutDown();
		}
	}

	@Test
	public void zeroOrOnePathShouldIgnoreUnrelatedPredicateUpdates() {
		SailRepository repository = getRepository();
		try {
			executeUpdate(repository, zeroOrOneClassShape());
			executeUpdateWithValidationDisabled(repository, invalidBaselineData());
			executeUpdate(repository, unrelatedPredicateUpdate());
		} finally {
			repository.shutDown();
		}
	}

	private static SailRepository getRepository() {
		return new SailRepository(new ShaclSail(new MemoryStore()));
	}

	private static void executeUpdate(SailRepository repository, String update) {
		try (SailRepositoryConnection connection = repository.getConnection()) {
			connection.begin();
			connection.prepareUpdate(update).execute();
			connection.commit();
		}
	}

	private static void executeUpdateWithValidationDisabled(SailRepository repository, String update) {
		try (SailRepositoryConnection connection = repository.getConnection()) {
			connection.begin(ShaclSail.TransactionSettings.ValidationApproach.Disabled);
			connection.prepareUpdate(update).execute();
			connection.commit();
		}
	}

	private static void assertCommitFailsWithValidationException(SailRepository repository, String update) {
		try (SailRepositoryConnection connection = repository.getConnection()) {
			connection.begin();
			connection.prepareUpdate(update).execute();
			RepositoryException exception = assertThrows(RepositoryException.class, connection::commit);
			assertInstanceOf(ShaclSailValidationException.class, exception.getCause());
			connection.rollback();
		}
	}

	private static String oneOrMoreMinCountShape() {
		return PREFIXES + String.join("\n",
				"INSERT DATA {",
				"  GRAPH rdf4j:SHACLShapeGraph {",
				"    ex:OneOrMoreShape a sh:NodeShape ;",
				"      sh:targetNode ex:alice ;",
				"      sh:property [",
				"        sh:path [ sh:oneOrMorePath ex:knows ] ;",
				"        sh:minCount 3",
				"      ] .",
				"  }",
				"}");
	}

	private static String zeroOrMoreMinCountShape() {
		return PREFIXES + String.join("\n",
				"INSERT DATA {",
				"  GRAPH rdf4j:SHACLShapeGraph {",
				"    ex:ZeroOrMoreShape a sh:NodeShape ;",
				"      sh:targetNode ex:alice ;",
				"      sh:property [",
				"        sh:path [ sh:zeroOrMorePath ex:knows ] ;",
				"        sh:minCount 4",
				"      ] .",
				"  }",
				"}");
	}

	private static String zeroOrMoreClassShape() {
		return PREFIXES + String.join("\n",
				"INSERT DATA {",
				"  GRAPH rdf4j:SHACLShapeGraph {",
				"    ex:ZeroOrMoreClassShape a sh:NodeShape ;",
				"      sh:targetClass ex:TargetPerson ;",
				"      sh:property [",
				"        sh:path [ sh:zeroOrMorePath ex:knows ] ;",
				"        sh:class ex:Person",
				"      ] .",
				"  }",
				"}");
	}

	private static String zeroOrOneClassShape() {
		return PREFIXES + String.join("\n",
				"INSERT DATA {",
				"  GRAPH rdf4j:SHACLShapeGraph {",
				"    ex:ZeroOrOneClassShape a sh:NodeShape ;",
				"      sh:targetClass ex:TargetPerson ;",
				"      sh:property [",
				"        sh:path [ sh:zeroOrOnePath ex:knows ] ;",
				"        sh:class ex:Person",
				"      ] .",
				"  }",
				"}");
	}

	private static String duplicateReachabilityGraph() {
		return PREFIXES + String.join("\n",
				"INSERT DATA {",
				"  ex:alice ex:knows ex:bob, ex:charlie .",
				"  ex:charlie ex:knows ex:bob .",
				"}");
	}

	private static String invalidBaselineData() {
		return PREFIXES + String.join("\n",
				"INSERT DATA {",
				"  ex:alice a ex:TargetPerson, ex:Person ;",
				"    ex:knows ex:bob .",
				"  ex:bob a ex:Robot .",
				"}");
	}

	private static String unrelatedPredicateUpdate() {
		return PREFIXES + String.join("\n",
				"INSERT DATA {",
				"  ex:alice ex:age 42 .",
				"}");
	}
}
