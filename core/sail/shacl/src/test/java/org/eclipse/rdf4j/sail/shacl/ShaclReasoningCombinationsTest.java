/*******************************************************************************
 * Copyright (c) 2026 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex

package org.eclipse.rdf4j.sail.shacl;

import java.util.List;
import java.util.stream.Stream;

import org.eclipse.rdf4j.common.transaction.QueryEvaluationMode;
import org.eclipse.rdf4j.sail.NotifyingSail;
import org.eclipse.rdf4j.sail.memory.MemoryStore;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.Arguments;
import org.junit.jupiter.params.provider.MethodSource;

public class ShaclReasoningCombinationsTest extends AbstractShaclReasoningCombinationTest {

	static Stream<Arguments> reasoningCases() {
		List<ReasoningCase> cases = List.of(
				new ReasoningCase("rdfs-target-class-mincount",
						rdfsTargetClassShapes(), rdfsTargetClassData(),
						rdfsTargetClassUpdate1(), rdfsTargetClassUpdate2(),
						false, true),
				new ReasoningCase("rdfs-target-subjects-of-class",
						rdfsTargetSubjectsShapes(), rdfsTargetSubjectsData(),
						rdfsTargetSubjectsUpdate1(), rdfsTargetSubjectsUpdate2(),
						true, false),
				new ReasoningCase("rdfs-target-objects-of-class",
						rdfsTargetObjectsShapes(), rdfsTargetObjectsData(),
						rdfsTargetObjectsUpdate1(), rdfsTargetObjectsUpdate2(),
						true, false)
		);

		return cases.stream()
				.flatMap(testCase -> Stream.of(
						Arguments.of(testCase, false),
						Arguments.of(testCase, true)
				));
	}

	@ParameterizedTest(name = "{0} enabled={1}")
	@MethodSource("reasoningCases")
	void reasoningCombinations(ReasoningCase testCase, boolean enabled) {
		runAllModes(testCase, enabled, enabled, true);
	}

	@Override
	protected NotifyingSail createDataSail() {
		MemoryStore memoryStore = new MemoryStore();
		memoryStore.setDefaultQueryEvaluationMode(QueryEvaluationMode.STRICT);
		return memoryStore;
	}

	@Override
	protected String ontologyTurtle() {
		return String.join("\n",
				"@prefix tr: <https://example.com/trains/> .",
				"@prefix owl: <http://www.w3.org/2002/07/owl#> .",
				"@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .",
				"",
				"tr:Train a owl:Class .",
				"tr:Railcar a owl:Class .",
				"tr:FreightWagon a owl:Class ;",
				"  rdfs:subClassOf tr:Railcar .",
				"tr:hasRailcar a owl:ObjectProperty .",
				"tr:hasBrake a owl:ObjectProperty .",
				""
		);
	}

	private static String rdfsTargetClassShapes() {
		return String.join("\n",
				"@prefix tr: <https://example.com/trains/> .",
				"@prefix sh: <http://www.w3.org/ns/shacl#> .",
				"",
				"tr:RailcarBrakeShape a sh:NodeShape ;",
				"  sh:targetClass tr:Railcar ;",
				"  sh:property [",
				"    sh:path tr:hasBrake ;",
				"    sh:minCount 1",
				"  ] .",
				""
		);
	}

	private static String rdfsTargetClassData() {
		return String.join("\n",
				"@prefix tr: <https://example.com/trains/> .",
				"",
				"<urn:train1> a tr:Train ;",
				"  tr:hasRailcar <urn:wagon1> , <urn:wagon2> .",
				"<urn:wagon1> a tr:FreightWagon ;",
				"  tr:hasBrake <urn:brake1> .",
				"<urn:wagon2> a tr:FreightWagon .",
				""
		);
	}

	private static String rdfsTargetClassUpdate1() {
		return String.join("\n",
				"PREFIX tr: <https://example.com/trains/>",
				"INSERT DATA {",
				"  GRAPH <urn:data> {",
				"    <urn:train1> a tr:Train ;",
				"      tr:hasRailcar <urn:wagon1> .",
				"    <urn:wagon1> a tr:FreightWagon ;",
				"      tr:hasBrake <urn:brake1> .",
				"  }",
				"}"
		);
	}

	private static String rdfsTargetClassUpdate2() {
		return String.join("\n",
				"PREFIX tr: <https://example.com/trains/>",
				"INSERT DATA {",
				"  GRAPH <urn:data> {",
				"    <urn:train1> tr:hasRailcar <urn:wagon2> .",
				"    <urn:wagon2> a tr:FreightWagon .",
				"  }",
				"}"
		);
	}

	private static String rdfsTargetSubjectsShapes() {
		return String.join("\n",
				"@prefix tr: <https://example.com/trains/> .",
				"@prefix sh: <http://www.w3.org/ns/shacl#> .",
				"",
				"tr:TrainRailcarClassShape a sh:NodeShape ;",
				"  sh:targetSubjectsOf tr:hasRailcar ;",
				"  sh:property [",
				"    sh:path tr:hasRailcar ;",
				"    sh:class tr:Railcar ;",
				"    sh:minCount 1",
				"  ] .",
				""
		);
	}

	private static String rdfsTargetSubjectsData() {
		return String.join("\n",
				"@prefix tr: <https://example.com/trains/> .",
				"",
				"<urn:train1> tr:hasRailcar <urn:wagon1> .",
				"<urn:wagon1> a tr:FreightWagon .",
				""
		);
	}

	private static String rdfsTargetSubjectsUpdate1() {
		return String.join("\n",
				"PREFIX tr: <https://example.com/trains/>",
				"INSERT DATA {",
				"  GRAPH <urn:data> {",
				"    <urn:train1> tr:hasRailcar <urn:wagon1> .",
				"  }",
				"}"
		);
	}

	private static String rdfsTargetSubjectsUpdate2() {
		return String.join("\n",
				"PREFIX tr: <https://example.com/trains/>",
				"INSERT DATA {",
				"  GRAPH <urn:data> {",
				"    <urn:wagon1> a tr:FreightWagon .",
				"  }",
				"}"
		);
	}

	private static String rdfsTargetObjectsShapes() {
		return String.join("\n",
				"@prefix tr: <https://example.com/trains/> .",
				"@prefix sh: <http://www.w3.org/ns/shacl#> .",
				"",
				"tr:RailcarClassShape a sh:NodeShape ;",
				"  sh:targetObjectsOf tr:hasRailcar ;",
				"  sh:class tr:Railcar .",
				""
		);
	}

	private static String rdfsTargetObjectsData() {
		return rdfsTargetSubjectsData();
	}

	private static String rdfsTargetObjectsUpdate1() {
		return rdfsTargetSubjectsUpdate1();
	}

	private static String rdfsTargetObjectsUpdate2() {
		return rdfsTargetSubjectsUpdate2();
	}
}
