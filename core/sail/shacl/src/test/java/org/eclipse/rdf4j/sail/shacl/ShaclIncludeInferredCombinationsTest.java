/*******************************************************************************
 * Copyright (c) 2026 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex

package org.eclipse.rdf4j.sail.shacl;

import java.util.List;
import java.util.stream.Stream;

import org.eclipse.rdf4j.common.transaction.QueryEvaluationMode;
import org.eclipse.rdf4j.sail.NotifyingSail;
import org.eclipse.rdf4j.sail.inferencer.fc.SchemaCachingRDFSInferencer;
import org.eclipse.rdf4j.sail.memory.MemoryStore;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.Arguments;
import org.junit.jupiter.params.provider.MethodSource;

public class ShaclIncludeInferredCombinationsTest extends AbstractShaclReasoningCombinationTest {

	static Stream<Arguments> reasoningCases() {
		List<ReasoningCase> cases = List.of(
				new ReasoningCase("include-target-class-inferred-type",
						includeTargetClassShapes(), includeTargetClassData(),
						includeTargetClassUpdate1(), includeTargetClassUpdate2(),
						true, false),
				new ReasoningCase("include-target-subjects-of-inferred",
						includeTargetSubjectsShapes(), includeTargetSubjectsData(),
						includeTargetSubjectsUpdate1(), includeTargetSubjectsUpdate2(),
						false, true),
				new ReasoningCase("include-target-objects-of-inferred",
						includeTargetObjectsShapes(), includeTargetObjectsData(),
						includeTargetObjectsUpdate1(), includeTargetObjectsUpdate2(),
						false, true)
		);

		return cases.stream()
				.flatMap(testCase -> Stream.of(
						Arguments.of(testCase, false),
						Arguments.of(testCase, true)
				));
	}

	@ParameterizedTest(name = "{0} enabled={1}")
	@MethodSource("reasoningCases")
	void includeInferredCombinations(ReasoningCase testCase, boolean enabled) {
		runAllModes(testCase, enabled, false, enabled);
	}

	@Override
	protected NotifyingSail createDataSail() {
		MemoryStore memoryStore = new MemoryStore();
		memoryStore.setDefaultQueryEvaluationMode(QueryEvaluationMode.STRICT);
		return new SchemaCachingRDFSInferencer(memoryStore, false);
	}

	@Override
	protected String ontologyTurtle() {
		return String.join("\n",
				"@prefix tr: <https://example.com/trains/> .",
				"@prefix owl: <http://www.w3.org/2002/07/owl#> .",
				"@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .",
				"",
				"tr:Train a owl:Class .",
				"tr:Railcar a owl:Class .",
				"tr:FreightWagon a owl:Class ;",
				"  rdfs:subClassOf tr:Railcar .",
				"tr:hasRailcar a owl:ObjectProperty ;",
				"  rdfs:subPropertyOf tr:relatedRailcar .",
				"tr:relatedRailcar a owl:ObjectProperty .",
				"tr:isRailcarOf a owl:ObjectProperty .",
				"tr:hasBrake a owl:ObjectProperty .",
				""
		);
	}

	private static String includeTargetClassShapes() {
		return String.join("\n",
				"@prefix tr: <https://example.com/trains/> .",
				"@prefix sh: <http://www.w3.org/ns/shacl#> .",
				"",
				"tr:TrainRailcarShape a sh:NodeShape ;",
				"  sh:targetClass tr:Train ;",
				"  sh:property [",
				"    sh:path [ sh:inversePath tr:isRailcarOf ] ;",
				"    sh:class tr:Railcar ;",
				"    sh:minCount 1",
				"  ] .",
				""
		);
	}

	private static String includeTargetClassData() {
		return String.join("\n",
				"@prefix tr: <https://example.com/trains/> .",
				"",
				"<urn:train1> a tr:Train .",
				"<urn:wagon1> a tr:FreightWagon ;",
				"  tr:isRailcarOf <urn:train1> .",
				""
		);
	}

	private static String includeTargetClassUpdate1() {
		return String.join("\n",
				"PREFIX tr: <https://example.com/trains/>",
				"INSERT DATA {",
				"  GRAPH <urn:data> {",
				"    <urn:train1> a tr:Train .",
				"  }",
				"}"
		);
	}

	private static String includeTargetClassUpdate2() {
		return String.join("\n",
				"PREFIX tr: <https://example.com/trains/>",
				"INSERT DATA {",
				"  GRAPH <urn:data> {",
				"    <urn:wagon1> a tr:FreightWagon ;",
				"      tr:isRailcarOf <urn:train1> .",
				"  }",
				"}"
		);
	}

	private static String includeTargetSubjectsShapes() {
		return String.join("\n",
				"@prefix tr: <https://example.com/trains/> .",
				"@prefix sh: <http://www.w3.org/ns/shacl#> .",
				"",
				"tr:RailcarBrakeShape a sh:NodeShape ;",
				"  sh:targetSubjectsOf tr:relatedRailcar ;",
				"  sh:property [",
				"    sh:path tr:hasBrake ;",
				"    sh:minCount 1",
				"  ] .",
				""
		);
	}

	private static String includeTargetSubjectsData() {
		return String.join("\n",
				"@prefix tr: <https://example.com/trains/> .",
				"",
				"<urn:train1> tr:hasRailcar <urn:wagon1> .",
				"<urn:wagon1> a tr:FreightWagon .",
				""
		);
	}

	private static String includeTargetSubjectsUpdate1() {
		return String.join("\n",
				"PREFIX tr: <https://example.com/trains/>",
				"INSERT DATA {",
				"  GRAPH <urn:data> {",
				"    <urn:train1> tr:hasRailcar <urn:wagon1> .",
				"  }",
				"}"
		);
	}

	private static String includeTargetSubjectsUpdate2() {
		return String.join("\n",
				"PREFIX tr: <https://example.com/trains/>",
				"INSERT DATA {",
				"  GRAPH <urn:data> {",
				"    <urn:wagon1> a tr:FreightWagon .",
				"  }",
				"}"
		);
	}

	private static String includeTargetObjectsShapes() {
		return String.join("\n",
				"@prefix tr: <https://example.com/trains/> .",
				"@prefix sh: <http://www.w3.org/ns/shacl#> .",
				"",
				"tr:RailcarBrakeShape a sh:NodeShape ;",
				"  sh:targetObjectsOf tr:relatedRailcar ;",
				"  sh:property [",
				"    sh:path tr:hasBrake ;",
				"    sh:minCount 1",
				"  ] .",
				""
		);
	}

	private static String includeTargetObjectsData() {
		return String.join("\n",
				"@prefix tr: <https://example.com/trains/> .",
				"",
				"<urn:train1> tr:hasRailcar <urn:wagon1> .",
				"<urn:wagon1> a tr:FreightWagon .",
				""
		);
	}

	private static String includeTargetObjectsUpdate1() {
		return String.join("\n",
				"PREFIX tr: <https://example.com/trains/>",
				"INSERT DATA {",
				"  GRAPH <urn:data> {",
				"    <urn:train1> tr:hasRailcar <urn:wagon1> .",
				"  }",
				"}"
		);
	}

	private static String includeTargetObjectsUpdate2() {
		return String.join("\n",
				"PREFIX tr: <https://example.com/trains/>",
				"INSERT DATA {",
				"  GRAPH <urn:data> {",
				"    <urn:wagon1> a tr:FreightWagon .",
				"  }",
				"}"
		);
	}
}
