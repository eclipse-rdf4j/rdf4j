/*******************************************************************************
 * Copyright (c) 2015 Eclipse RDF4J contributors, Aduna, and others.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.sail.elasticsearch;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertTrue;

import java.util.Map;

import org.eclipse.rdf4j.model.vocabulary.GEOF;
import org.junit.jupiter.api.Test;
import org.locationtech.spatial4j.context.SpatialContext;
import org.locationtech.spatial4j.distance.DistanceUtils;
import org.locationtech.spatial4j.io.GeohashUtils;
import org.locationtech.spatial4j.shape.Point;

import com.google.common.base.Function;
import com.google.common.base.Functions;

import co.elastic.clients.elasticsearch.core.search.Hit;

public class ElasticsearchDocumentDistanceTest {

	private final Function<? super String, ? extends SpatialContext> geoContextMapper = Functions
			.constant(SpatialContext.GEO);

	@Test
	public void getDistanceSupportsLegacyGeohash() {
		String geohash = "u4pruydqqvj";
		String geoPointField = ElasticsearchIndex.toGeoPointFieldName("wkt");
		Map<String, Object> source = Map.of(geoPointField, geohash);

		Hit<Map<String, Object>> hit = Hit.of(h -> h.id("1").index("idx").source(source));
		ElasticsearchDocumentDistance distance = new ElasticsearchDocumentDistance(hit, geoContextMapper, geoPointField,
				GEOF.UOM_METRE, 0, 0);

		Point point = GeohashUtils.decode(geohash, SpatialContext.GEO);
		double distRad = DistanceUtils.distHaversineRAD(0, 0, point.getY(), point.getX());
		double expectedMeters = DistanceUtils.radians2Dist(distRad, DistanceUtils.EARTH_MEAN_RADIUS_KM) * 1000.0;

		double actual = distance.getDistance();
		assertTrue(actual > 0);
		assertEquals(expectedMeters, actual, 0.0001);
	}
}
