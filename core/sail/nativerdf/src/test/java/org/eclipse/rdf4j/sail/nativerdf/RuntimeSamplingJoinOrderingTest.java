/*******************************************************************************
 * Copyright (c) 2026 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.sail.nativerdf;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertTrue;

import java.io.File;

import org.eclipse.rdf4j.model.IRI;
import org.eclipse.rdf4j.model.ValueFactory;
import org.eclipse.rdf4j.query.TupleQuery;
import org.eclipse.rdf4j.query.TupleQueryResult;
import org.eclipse.rdf4j.query.algebra.evaluation.impl.EvaluationStatistics;
import org.eclipse.rdf4j.query.algebra.evaluation.impl.LearningEvaluationStrategyFactory;
import org.eclipse.rdf4j.query.algebra.evaluation.optimizer.MemoryJoinStats;
import org.eclipse.rdf4j.query.algebra.evaluation.optimizer.learned.LearnedJoinConfig;
import org.eclipse.rdf4j.repository.Repository;
import org.eclipse.rdf4j.repository.RepositoryConnection;
import org.eclipse.rdf4j.repository.sail.SailRepository;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.io.TempDir;

class RuntimeSamplingJoinOrderingTest {

	@TempDir
	public File dataDir;

	@Test
	void runtimeSamplingImprovesFirstRunOrdering() {
		File baselineDir = new File(dataDir, "baseline");
		File samplingDir = new File(dataDir, "sampling");

		long baselineCalls = runQueryWithSampling(baselineDir, false);
		long samplingCalls = runQueryWithSampling(samplingDir, true);

		assertEquals(1101L, baselineCalls);
		assertEquals(24L, samplingCalls);
		assertTrue(samplingCalls < baselineCalls);
	}

	private long runQueryWithSampling(File dir, boolean enableSampling) {
		MemoryJoinStats statsProvider = new MemoryJoinStats();
		LearnedJoinConfig config = new LearnedJoinConfig(
				LearnedJoinConfig.DEFAULT_DP_THRESHOLD,
				false,
				true,
				enableSampling,
				LearnedJoinConfig.DEFAULT_RUNTIME_SAMPLING_MAX_OPERANDS,
				LearnedJoinConfig.DEFAULT_RUNTIME_SAMPLING_MAX_STATEMENTS,
				false,
				LearnedJoinConfig.DEFAULT_ADAPTIVE_NESTED_LOOP_THRESHOLD,
				LearnedJoinConfig.DEFAULT_HASH_JOIN_MAX_BUILD_ROWS);
		LearningEvaluationStrategyFactory factory = new LearningEvaluationStrategyFactory(statsProvider,
				new EvaluationStatistics(), config);
		NativeStore store = new NativeStore(dir);
		store.setEvaluationStrategyFactory(factory);
		Repository repo = new SailRepository(store);
		repo.init();

		try (RepositoryConnection conn = repo.getConnection()) {
			ValueFactory vf = conn.getValueFactory();
			IRI predA = vf.createIRI("http://example.org/aPred");
			IRI predB = vf.createIRI("http://example.org/bPred");
			IRI predC = vf.createIRI("http://example.org/cPred");
			loadData(conn, vf, predA, predB, predC);

			String query = "SELECT ?x ?y WHERE { "
					+ "?x <http://example.org/aPred> \"hot\" . "
					+ "?x <http://example.org/bPred> ?y . "
					+ "?y <http://example.org/cPred> \"cold\" . "
					+ "}";

			long callsBefore = statsProvider.getTotalCalls();
			int results = runQuery(conn, query);
			long callsAfter = statsProvider.getTotalCalls();

			assertEquals(10, results);
			return callsAfter - callsBefore;
		} finally {
			repo.shutDown();
		}
	}

	private static int runQuery(RepositoryConnection conn, String query) {
		TupleQuery tupleQuery = conn.prepareTupleQuery(query);
		int count = 0;
		try (TupleQueryResult result = tupleQuery.evaluate()) {
			while (result.hasNext()) {
				result.next();
				count++;
			}
		}
		return count;
	}

	private static void loadData(RepositoryConnection conn, ValueFactory vf, IRI predA, IRI predB, IRI predC) {
		for (int i = 1; i <= 1000; i++) {
			IRI subj = vf.createIRI("http://example.org/x" + i);
			conn.add(subj, predA, vf.createLiteral("hot"));
			if (i <= 100) {
				IRI obj = vf.createIRI("http://example.org/y" + i);
				conn.add(subj, predB, obj);
				if (i <= 10) {
					conn.add(obj, predC, vf.createLiteral("cold"));
				}
			}
		}
	}
}
