/*******************************************************************************
 * Copyright (c) 2025 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.sail.memory;

import static org.junit.jupiter.api.Assertions.assertEquals;

import java.util.HashSet;
import java.util.List;
import java.util.Set;

import org.eclipse.rdf4j.model.IRI;
import org.eclipse.rdf4j.model.Value;
import org.eclipse.rdf4j.model.util.Values;
import org.eclipse.rdf4j.model.vocabulary.FOAF;
import org.eclipse.rdf4j.query.BindingSet;
import org.eclipse.rdf4j.query.TupleQuery;
import org.eclipse.rdf4j.query.TupleQueryResult;
import org.eclipse.rdf4j.repository.sail.SailRepository;
import org.eclipse.rdf4j.repository.sail.SailRepositoryConnection;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

public class MemoryStoreValuesOptionalQueryTest {

	private SailRepository repository;

	@BeforeEach
	public void setUp() {
		repository = new SailRepository(new MemoryStore());
		repository.init();
	}

	@AfterEach
	public void tearDown() {
		if (repository != null) {
			repository.shutDown();
		}
	}

	@Test
	public void testPostQueryValuesWithOptionalObjectVar() {
		try (SailRepositoryConnection conn = repository.getConnection()) {
			IRI a = Values.iri("http://example.org/a");
			IRI b = Values.iri("http://example.org/b");
			IRI c = Values.iri("http://example.org/c");

			conn.add(a, FOAF.NAME, Values.literal("Alan"));
			conn.add(a, FOAF.MBOX, Values.literal("alan@example.org"));
			conn.add(b, FOAF.NAME, Values.literal("Bob"));
			conn.add(b, FOAF.MBOX, Values.literal("bob@example.org"));
			conn.add(c, FOAF.NAME, Values.literal("Alice"));
			conn.add(c, FOAF.MBOX, Values.literal("alice@example.org"));
			conn.add(a, FOAF.KNOWS, b);
			conn.add(b, FOAF.KNOWS, c);

			String sparql = String.join("\n",
					"PREFIX : <http://example.org/>",
					"PREFIX foaf: <http://xmlns.com/foaf/0.1/>",
					"SELECT ?s ?o1 ?o2",
					"{",
					"  ?s ?p1 ?o1",
					"  OPTIONAL { ?s foaf:knows ?o2 }",
					"} VALUES (?o2) {",
					"  (:b)",
					"}"
			);

			TupleQuery query = conn.prepareTupleQuery(sparql);
			Set<List<Value>> actual = new HashSet<>();
			try (TupleQueryResult result = query.evaluate()) {
				while (result.hasNext()) {
					BindingSet bindingSet = result.next();
					actual.add(List.of(
							bindingSet.getValue("s"),
							bindingSet.getValue("o1"),
							bindingSet.getValue("o2")
					));
				}
			}

			Set<List<Value>> expected = Set.of(
					List.of(a, b, b),
					List.of(a, Values.literal("alan@example.org"), b),
					List.of(a, Values.literal("Alan"), b),
					List.of(c, Values.literal("alice@example.org"), b),
					List.of(c, Values.literal("Alice"), b)
			);

			assertEquals(expected, actual);
		}
	}
}
