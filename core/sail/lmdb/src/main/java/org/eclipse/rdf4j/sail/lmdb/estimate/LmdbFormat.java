/*******************************************************************************
 * Copyright (c) 2026 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.sail.lmdb.estimate;

import java.nio.ByteBuffer;

final class LmdbFormat {

	static final int MDB_MAGIC = 0xBEEFC0DE;
	static final int MDB_DATA_VERSION = 1;
	static final int MDB_DATA_VERSION_DEVEL = 999;

	static final int P_BRANCH = 0x01;
	static final int P_LEAF = 0x02;
	static final int P_OVERFLOW = 0x04;
	static final int P_META = 0x08;
	static final int P_LEAF2 = 0x20;
	static final int P_SUBP = 0x40;

	static final int F_BIGDATA = 0x01;
	static final int F_SUBDATA = 0x02;
	static final int F_DUPDATA = 0x04;

	static final long P_INVALID = -1L;

	static final int PAGE_HEADER_SIZE = 16;
	static final int PAGE_BASE = 0;

	static final int META_MAGIC_OFFSET = 0;
	static final int META_VERSION_OFFSET = 4;
	static final int META_MAP_SIZE_OFFSET = 16;
	static final int META_DBS_OFFSET = 24;
	static final int META_DB_SIZE = 48;
	static final int META_LAST_PG_OFFSET = META_DBS_OFFSET + 2 * META_DB_SIZE;
	static final int META_TXNID_OFFSET = META_LAST_PG_OFFSET + Long.BYTES;

	static final int MDB_DB_PAD_OFFSET = 0;
	static final int MDB_DB_FLAGS_OFFSET = 4;
	static final int MDB_DB_DEPTH_OFFSET = 6;
	static final int MDB_DB_BRANCH_PAGES_OFFSET = 8;
	static final int MDB_DB_LEAF_PAGES_OFFSET = 16;
	static final int MDB_DB_OVERFLOW_PAGES_OFFSET = 24;
	static final int MDB_DB_ENTRIES_OFFSET = 32;
	static final int MDB_DB_ROOT_OFFSET = 40;

	static final int NODE_LO_OFFSET = 0;
	static final int NODE_HI_OFFSET = 2;
	static final int NODE_FLAGS_OFFSET = 4;
	static final int NODE_KEYSIZE_OFFSET = 6;
	static final int NODE_DATA_OFFSET = 8;
	static final int NODE_SIZE = NODE_DATA_OFFSET;

	static final int PGNO_TOPWORD_SHIFT = 32;

	private LmdbFormat() {
	}

	static int unsignedShort(ByteBuffer buffer, int offset) {
		return Short.toUnsignedInt(buffer.getShort(offset));
	}

	static int nodeDataSize(ByteBuffer buffer, int offset) {
		int lo = unsignedShort(buffer, offset + NODE_LO_OFFSET);
		int hi = unsignedShort(buffer, offset + NODE_HI_OFFSET);
		return lo | (hi << 16);
	}

	static long nodeBranchPgno(ByteBuffer buffer, int offset) {
		long lo = unsignedShort(buffer, offset + NODE_LO_OFFSET);
		long hi = unsignedShort(buffer, offset + NODE_HI_OFFSET);
		long flags = unsignedShort(buffer, offset + NODE_FLAGS_OFFSET);
		return lo | (hi << 16) | (flags << PGNO_TOPWORD_SHIFT);
	}

	static int numKeys(int lower) {
		return (lower - (PAGE_HEADER_SIZE - PAGE_BASE)) >> 1;
	}

}
