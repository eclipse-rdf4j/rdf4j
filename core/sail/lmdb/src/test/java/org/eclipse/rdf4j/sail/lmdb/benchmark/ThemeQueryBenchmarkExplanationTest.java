/*******************************************************************************
 * Copyright (c) 2026 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.sail.lmdb.benchmark;

import static org.junit.jupiter.api.Assertions.assertFalse;

import java.io.File;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.util.Arrays;

import org.apache.commons.io.FileUtils;
import org.eclipse.rdf4j.benchmark.common.ThemeQueryCatalog;
import org.eclipse.rdf4j.benchmark.rio.util.ThemeDataSetGenerator;
import org.eclipse.rdf4j.benchmark.rio.util.ThemeDataSetGenerator.Theme;
import org.eclipse.rdf4j.common.transaction.IsolationLevels;
import org.eclipse.rdf4j.query.explanation.Explanation;
import org.eclipse.rdf4j.repository.sail.SailRepository;
import org.eclipse.rdf4j.repository.sail.SailRepositoryConnection;
import org.eclipse.rdf4j.repository.util.RDFInserter;
import org.eclipse.rdf4j.sail.lmdb.LmdbStore;
import org.eclipse.rdf4j.sail.lmdb.config.LmdbStoreConfig;
import org.junit.jupiter.api.Test;

class ThemeQueryBenchmarkExplanationTest {

	@Test
	void recordOptimizedQueryExplanationWithAndWithoutPageEstimator() throws IOException {
		Theme[] themes = Theme.values();
		File outputDir = new File("target/theme-query-explanations");
		FileUtils.forceMkdir(outputDir);
		for (boolean pageEstimatorEnabled : new boolean[] { false, true }) {
			File outputFile = new File(outputDir, "optimized-explanations-page-estimator-"
					+ (pageEstimatorEnabled ? "enabled" : "disabled") + ".txt");
			StringBuilder recordedExplanations = new StringBuilder();
			recordedExplanations.append("pageCardinalityEstimator=").append(pageEstimatorEnabled).append('\n');
			recordedExplanations.append("themes=").append(Arrays.toString(themes)).append('\n');
			recordedExplanations.append("queryIndexes=0..").append(ThemeQueryCatalog.QUERY_COUNT - 1).append("\n\n");

			for (Theme theme : themes) {
				String themeName = theme.name();
				File dataDir = Files.createTempDirectory("theme-query-explain").toFile();
				LmdbStoreConfig config = ConfigUtil.createConfig().setPageCardinalityEstimator(pageEstimatorEnabled);
				SailRepository repository = new SailRepository(new LmdbStore(dataDir, config));
				try {
					loadData(theme, repository);
					try (SailRepositoryConnection connection = repository.getConnection()) {
						for (int queryIndex = 0; queryIndex < ThemeQueryCatalog.QUERY_COUNT; queryIndex++) {
							String query = ThemeQueryCatalog.queryFor(theme, queryIndex);
							long expectedCount = ThemeQueryCatalog.expectedCountFor(theme, queryIndex);
							String explanation = connection
									.prepareTupleQuery(query)
									.explain(Explanation.Level.Optimized)
									.toString();
							assertFalse(explanation.isBlank(), "Missing explanation for theme " + themeName + " query "
									+ queryIndex + " with page estimator " + pageEstimatorEnabled);
							recordedExplanations.append("theme=")
									.append(themeName)
									.append(", queryIndex=")
									.append(queryIndex)
									.append(", expectedCount=")
									.append(expectedCount)
									.append('\n')
									.append(explanation)
									.append("\n\n");
						}
					}
				} finally {
					repository.shutDown();
					FileUtils.deleteDirectory(dataDir);
				}
			}
			FileUtils.writeStringToFile(outputFile, recordedExplanations.toString(), StandardCharsets.UTF_8);
			System.out.println("Wrote optimized query explanations to " + outputFile.getAbsolutePath());
		}
	}

	private static void loadData(Theme theme, SailRepository repository) throws IOException {
		try (SailRepositoryConnection connection = repository.getConnection()) {
			connection.begin(IsolationLevels.NONE);
			RDFInserter inserter = new RDFInserter(connection);
			ThemeDataSetGenerator.generate(theme, inserter);
			connection.commit();
		}
	}
}
