/*******************************************************************************
 * Copyright (c) 2026 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.sail.lmdb.benchmark;

import static org.junit.jupiter.api.Assertions.fail;

import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Set;
import java.util.TreeSet;

import org.eclipse.rdf4j.benchmark.common.ThemeQueryCatalog;
import org.eclipse.rdf4j.benchmark.rio.util.ThemeDataSetGenerator;
import org.eclipse.rdf4j.benchmark.rio.util.ThemeDataSetGenerator.Theme;
import org.eclipse.rdf4j.common.transaction.IsolationLevels;
import org.eclipse.rdf4j.query.BindingSet;
import org.eclipse.rdf4j.query.QueryEvaluationException;
import org.eclipse.rdf4j.query.TupleQueryResult;
import org.eclipse.rdf4j.repository.sail.SailRepository;
import org.eclipse.rdf4j.repository.sail.SailRepositoryConnection;
import org.eclipse.rdf4j.repository.util.RDFInserter;
import org.eclipse.rdf4j.sail.lmdb.LmdbStore;
import org.eclipse.rdf4j.sail.memory.MemoryStore;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.io.TempDir;

class LmdbThemeQueryResultDiffTest {

	private static final Theme THEME = Theme.PHARMA;
	private static final int SAMPLE_LIMIT = 20;

	@TempDir
	File dataDir;

	@Test
	void queryIndex8MatchesMemoryResults() throws IOException {
		assertLmdbMatchesMemory(8, "drug", "targetCount");
	}

	@Test
	void queryIndex10MatchesMemoryResults() throws IOException {
		assertLmdbMatchesMemory(10, "pathway", "drugCount");
	}

	private void assertLmdbMatchesMemory(int queryIndex, String keyBinding, String valueBinding) throws IOException {
		String query = ThemeQueryCatalog.queryFor(THEME, queryIndex);
		SailRepository lmdbRepository = createLmdbRepository();
		SailRepository memoryRepository = createMemoryRepository();
		try {
			Map<String, String> lmdbResults = executeResults(lmdbRepository, query, keyBinding, valueBinding);
			Map<String, String> memoryResults = executeResults(memoryRepository, query, keyBinding, valueBinding);

			if (!lmdbResults.equals(memoryResults)) {
				Set<String> extra = new TreeSet<>(lmdbResults.keySet());
				extra.removeAll(memoryResults.keySet());
				Set<String> missing = new TreeSet<>(memoryResults.keySet());
				missing.removeAll(lmdbResults.keySet());
				Set<String> mismatched = new TreeSet<>();
				for (String key : lmdbResults.keySet()) {
					if (memoryResults.containsKey(key)
							&& !Objects.equals(lmdbResults.get(key), memoryResults.get(key))) {
						mismatched.add(key + "=" + lmdbResults.get(key) + " (memory=" + memoryResults.get(key) + ")");
					}
				}
				String diagnostics = "";
				if (queryIndex == 10) {
					diagnostics = "\ncounts testedIn lmdb="
							+ countMatches(lmdbRepository,
									"SELECT (COUNT(*) AS ?c) WHERE { ?drug <http://example.com/theme/pharma/testedIn> ?trial }")
							+ " memory="
							+ countMatches(memoryRepository,
									"SELECT (COUNT(*) AS ?c) WHERE { ?drug <http://example.com/theme/pharma/testedIn> ?trial }")
							+ "\ncounts hasResult lmdb="
							+ countMatches(lmdbRepository,
									"SELECT (COUNT(*) AS ?c) WHERE { ?arm <http://example.com/theme/pharma/hasResult> ?result }")
							+ " memory="
							+ countMatches(memoryRepository,
									"SELECT (COUNT(*) AS ?c) WHERE { ?arm <http://example.com/theme/pharma/hasResult> ?result }")
							+ "\ncounts biomarker lmdb="
							+ countMatches(lmdbRepository,
									"SELECT (COUNT(*) AS ?c) WHERE { ?result <http://example.com/theme/pharma/biomarker> ?marker }")
							+ " memory="
							+ countMatches(memoryRepository,
									"SELECT (COUNT(*) AS ?c) WHERE { ?result <http://example.com/theme/pharma/biomarker> ?marker }");
				} else if (queryIndex == 8 && !extra.isEmpty()) {
					diagnostics = "\nextra drug diagnostics: " + sample(drugDiagnostics(lmdbRepository,
							memoryRepository, extra));
				}
				fail("LMDB results differ from MemoryStore for theme " + THEME + " queryIndex " + queryIndex
						+ ". extra=" + extra.size() + " missing=" + missing.size() + " mismatched="
						+ mismatched.size()
						+ "\nextra sample: " + sample(extra)
						+ "\nmissing sample: " + sample(missing)
						+ "\nmismatched sample: " + sample(mismatched)
						+ diagnostics);
			}
		} finally {
			lmdbRepository.shutDown();
			memoryRepository.shutDown();
		}
	}

	private SailRepository createLmdbRepository() throws IOException {
		SailRepository repository = new SailRepository(new LmdbStore(dataDir, ConfigUtil.createConfig()));
		repository.init();
		loadData(repository);
		return repository;
	}

	private SailRepository createMemoryRepository() throws IOException {
		SailRepository repository = new SailRepository(new MemoryStore());
		repository.init();
		loadData(repository);
		return repository;
	}

	private void loadData(SailRepository repository) throws IOException {
		try (SailRepositoryConnection connection = repository.getConnection()) {
			connection.begin(IsolationLevels.NONE);
			RDFInserter inserter = new RDFInserter(connection);
			ThemeDataSetGenerator.generate(THEME, inserter);
			connection.commit();
		}
	}

	private Map<String, String> executeResults(SailRepository repository, String query, String keyBinding,
			String valueBinding) {
		Map<String, String> results = new HashMap<>();
		try (SailRepositoryConnection connection = repository.getConnection();
				TupleQueryResult result = connection.prepareTupleQuery(query).evaluate()) {
			while (result.hasNext()) {
				BindingSet bindingSet = result.next();
				String key = bindingSet.getValue(keyBinding).stringValue();
				String value = bindingSet.getValue(valueBinding).stringValue();
				results.put(key, value);
			}
		}
		return results;
	}

	private static String sample(Set<String> values) {
		if (values.isEmpty()) {
			return "<none>";
		}
		List<String> sample = new ArrayList<>(SAMPLE_LIMIT);
		for (String value : values) {
			sample.add(value);
			if (sample.size() >= SAMPLE_LIMIT) {
				break;
			}
		}
		return String.join(", ", sample);
	}

	private static long countMatches(SailRepository repository, String query) {
		try (SailRepositoryConnection connection = repository.getConnection();
				TupleQueryResult result = connection.prepareTupleQuery(query).evaluate()) {
			if (!result.hasNext()) {
				throw new QueryEvaluationException("Count query returned no result");
			}
			BindingSet bindingSet = result.next();
			return Long.parseLong(bindingSet.getValue("c").stringValue());
		}
	}

	private static Set<String> drugDiagnostics(SailRepository lmdbRepository, SailRepository memoryRepository,
			Set<String> extraDrugs) {
		Set<String> diagnostics = new TreeSet<>();
		int seen = 0;
		for (String drug : extraDrugs) {
			if (seen++ >= SAMPLE_LIMIT) {
				break;
			}
			long lmdbTargets = countMatches(lmdbRepository,
					"SELECT (COUNT(DISTINCT ?t) AS ?c) WHERE { <" + drug
							+ "> <http://example.com/theme/pharma/targets> ?t }");
			long memoryTargets = countMatches(memoryRepository,
					"SELECT (COUNT(DISTINCT ?t) AS ?c) WHERE { <" + drug
							+ "> <http://example.com/theme/pharma/targets> ?t }");
			boolean lmdbContra6 = ask(lmdbRepository,
					"ASK { <" + drug
							+ "> <http://example.com/theme/pharma/contraindicatedFor> <http://example.com/theme/pharma/disease/6> }");
			boolean memoryContra6 = ask(memoryRepository,
					"ASK { <" + drug
							+ "> <http://example.com/theme/pharma/contraindicatedFor> <http://example.com/theme/pharma/disease/6> }");
			boolean lmdbContra7 = ask(lmdbRepository,
					"ASK { <" + drug
							+ "> <http://example.com/theme/pharma/contraindicatedFor> <http://example.com/theme/pharma/disease/7> }");
			boolean memoryContra7 = ask(memoryRepository,
					"ASK { <" + drug
							+ "> <http://example.com/theme/pharma/contraindicatedFor> <http://example.com/theme/pharma/disease/7> }");
			diagnostics.add(drug + " targets lmdb=" + lmdbTargets + " memory=" + memoryTargets
					+ " contraindicated6 lmdb=" + lmdbContra6 + " memory=" + memoryContra6
					+ " contraindicated7 lmdb=" + lmdbContra7 + " memory=" + memoryContra7);
		}
		return diagnostics;
	}

	private static boolean ask(SailRepository repository, String query) {
		try (SailRepositoryConnection connection = repository.getConnection()) {
			return connection.prepareBooleanQuery(query).evaluate();
		}
	}
}
