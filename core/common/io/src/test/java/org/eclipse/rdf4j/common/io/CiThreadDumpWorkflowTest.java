/*******************************************************************************
 * Copyright (c) 2025 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex

package org.eclipse.rdf4j.common.io;

import static org.assertj.core.api.Assertions.assertThat;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.List;
import java.util.stream.Collectors;

import org.junit.jupiter.api.Test;

class CiThreadDumpWorkflowTest {

	@Test
	void threadDumpWrapperUsesExecInWorkflow() throws IOException {
		Path workflow = findWorkflow();
		List<String> offenders = Files.readAllLines(workflow)
				.stream()
				.filter(line -> line.contains("run-with-thread-dump.sh"))
				.filter(line -> !line.contains("exec "))
				.collect(Collectors.toList());

		assertThat(offenders)
				.withFailMessage("Expected exec wrapper for run-with-thread-dump.sh in %s but found:%n%s",
						workflow, String.join(System.lineSeparator(), offenders))
				.isEmpty();
	}

	@Test
	void registersThreadDumpPostBeforeTests() throws IOException {
		Path workflow = findWorkflow();
		List<String> lines = Files.readAllLines(workflow);
		int registrationIndex = indexOfLineContaining(lines, "uses: ./.github/actions/thread-dump-post");
		int firstRunIndex = indexOfLineContaining(lines, "run-with-thread-dump.sh");

		assertThat(registrationIndex)
				.withFailMessage("Expected thread dump post action registration in %s", workflow)
				.isGreaterThanOrEqualTo(0);
		assertThat(firstRunIndex)
				.withFailMessage("Expected run-with-thread-dump.sh invocation in %s", workflow)
				.isGreaterThanOrEqualTo(0);
		assertThat(registrationIndex)
				.withFailMessage("Expected thread dump post action to be registered before tests in %s", workflow)
				.isLessThan(firstRunIndex);
	}

	private Path findWorkflow() {
		Path current = Path.of("").toAbsolutePath();
		while (current != null) {
			Path candidate = current.resolve(".github/workflows/pr-verify.yml");
			if (Files.exists(candidate)) {
				return candidate;
			}
			current = current.getParent();
		}
		throw new IllegalStateException("Could not locate .github/workflows/pr-verify.yml");
	}

	private int indexOfLineContaining(List<String> lines, String needle) {
		for (int i = 0; i < lines.size(); i++) {
			if (lines.get(i).contains(needle)) {
				return i;
			}
		}
		return -1;
	}
}
