/*******************************************************************************
 * Copyright (c) 2025 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.queryrender;

import static org.assertj.core.api.Assertions.assertThat;

import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.List;
import java.util.stream.Stream;

import org.eclipse.rdf4j.query.BindingSet;
import org.eclipse.rdf4j.query.Dataset;
import org.eclipse.rdf4j.query.MalformedQueryException;
import org.eclipse.rdf4j.query.QueryLanguage;
import org.eclipse.rdf4j.query.algebra.TupleExpr;
import org.eclipse.rdf4j.query.algebra.evaluation.impl.EvaluationStatistics;
import org.eclipse.rdf4j.query.algebra.evaluation.optimizer.SparqlUoOptimizer;
import org.eclipse.rdf4j.query.impl.EmptyBindingSet;
import org.eclipse.rdf4j.query.impl.SimpleDataset;
import org.eclipse.rdf4j.query.parser.ParsedQuery;
import org.eclipse.rdf4j.query.parser.QueryParserUtil;
import org.eclipse.rdf4j.queryrender.sparql.TupleExprIRRenderer;
import org.junit.jupiter.api.DynamicTest;
import org.junit.jupiter.api.TestFactory;

/**
 * Visualize SPARQL-UO rewrites by rendering pre/post-optimization SPARQL with TupleExprIRRenderer. Artifacts are
 * written to surefire-reports for inspection.
 */
public class SparqlUoOptimizerVisualizationTest {

	private static final String PREFIXES = "PREFIX ex: <http://example.org/>\n";
	private static final Dataset DATASET = new SimpleDataset();
	private static final BindingSet BINDINGS = EmptyBindingSet.getInstance();

	private static final List<Example> COUNTER_EXAMPLES = List.of(
			new Example("counter_union_no_shared_subject_or_object",
					PREFIXES + "SELECT * WHERE {\n" +
							"  ?s ex:p1 ?o .\n" +
							"  { ?x ex:p2 ?y } UNION { ?a ex:p3 ?b }\n" +
							"}\n",
					PREFIXES + "SELECT ?s ?o ?x ?y ?a ?b WHERE {\n" +
							"  ?s ex:p1 ?o .\n" +
							"  {\n" +
							"    ?x ex:p2 ?y .\n" +
							"  }\n" +
							"  UNION\n" +
							"  {\n" +
							"    ?a ex:p3 ?b .\n" +
							"  }\n" +
							"}"),
			new Example("counter_union_only_predicate_shared",
					PREFIXES + "SELECT * WHERE {\n" +
							"  ?s ?p ?o .\n" +
							"  { ?x ?p ?y } UNION { ?x ?p ?z }\n" +
							"}\n",
					PREFIXES + "SELECT ?s ?p ?o ?x ?y ?z WHERE {\n" +
							"  {\n" +
							"    ?s ?p ?o .\n" +
							"    {\n" +
							"      ?x ?p ?y .\n" +
							"    }\n" +
							"  }\n" +
							"  UNION\n" +
							"  {\n" +
							"    ?s ?p ?o .\n" +
							"    {\n" +
							"      ?x ?p ?z .\n" +
							"    }\n" +
							"  }\n" +
							"}"),
			new Example("counter_optional_no_shared_subject_or_object",
					PREFIXES + "SELECT * WHERE {\n" +
							"  ?s ex:p1 ?o\n" +
							"  OPTIONAL { ?x ex:p2 ?y }\n" +
							"}\n",
					PREFIXES + "SELECT ?s ?o ?x ?y WHERE {\n" +
							"  ?s ex:p1 ?o .\n" +
							"  OPTIONAL {\n" +
							"    ?x ex:p2 ?y .\n" +
							"  }\n" +
							"}"),
			new Example("counter_optional_with_filter_barrier",
					PREFIXES + "SELECT * WHERE {\n" +
							"  ?s ex:p1 ?o\n" +
							"  OPTIONAL { FILTER(?o > 5) ?s ex:p2 ?o2 }\n" +
							"}\n",
					PREFIXES + "SELECT ?s ?o ?o2 WHERE {\n" +
							"  ?s ex:p1 ?o .\n" +
							"  OPTIONAL {\n" +
							"    ?s ex:p2 ?o2 .\n" +
							"    FILTER (?o > 5)\n" +
							"  }\n" +
							"}"),
			new Example("counter_union_with_filter_barrier",
					PREFIXES + "SELECT * WHERE {\n" +
							"  ?s ex:p1 ?o .\n" +
							"  { FILTER(?o > 5) ?s ex:p2 ?o2 } UNION { FILTER(?o > 5) ?s ex:p3 ?o3 }\n" +
							"}\n",
					PREFIXES + "SELECT ?s ?o ?o2 ?o3 WHERE {\n" +
							"  ?s ex:p1 ?o .\n" +
							"  {\n" +
							"    ?s ex:p2 ?o2 .\n" +
							"    FILTER (?o > 5)\n" +
							"  }\n" +
							"  UNION\n" +
							"  {\n" +
							"    ?s ex:p3 ?o3 .\n" +
							"    FILTER (?o > 5)\n" +
							"  }\n" +
							"}"),
			new Example("counter_service_barrier",
					PREFIXES + "SELECT * WHERE {\n" +
							"  ?s ex:p1 ?o\n" +
							"  SERVICE <http://example.org/svc> { ?s ex:p2 ?o2 }\n" +
							"}\n",
					PREFIXES + "SELECT ?s ?o ?o2 WHERE {\n" +
							"  ?s ex:p1 ?o .\n" +
							"  SERVICE ex:svc {\n" +
							"    ?s ex:p2 ?o2 .\n" +
							"  }\n" +
							"}")
	);

	private static final List<Example> EXAMPLES = List.of(
			new Example("merge_simple_union",
					PREFIXES + "SELECT * WHERE {\n" +
							"  ?s ex:p1 ?o .\n" +
							"  { ?s ex:p2 ?o2 } UNION { ?s ex:p3 ?o3 }\n" +
							"}\n",
					PREFIXES + "SELECT ?s ?o ?o2 ?o3 WHERE {\n" +
							"  {\n" +
							"    ?s ex:p1 ?o .\n" +
							"    {\n" +
							"      ?s ex:p2 ?o2 .\n" +
							"    }\n" +
							"  }\n" +
							"  UNION\n" +
							"  {\n" +
							"    ?s ex:p1 ?o .\n" +
							"    {\n" +
							"      ?s ex:p3 ?o3 .\n" +
							"    }\n" +
							"  }\n" +
							"}"),
			new Example("merge_union_with_longer_branch",
					PREFIXES + "SELECT * WHERE {\n" +
							"  ?s ex:p1 ?o .\n" +
							"  { ?s ex:p2 ?o2 . ?o2 ex:p4 ?x } UNION { ?s ex:p3 ?o3 }\n" +
							"}\n",
					PREFIXES + "SELECT ?s ?o ?o2 ?x ?o3 WHERE {\n" +
							"  {\n" +
							"    ?s ex:p1 ?o .\n" +
							"    ?s ex:p2 ?o2 .\n" +
							"    ?o2 ex:p4 ?x .\n" +
							"  }\n" +
							"  UNION\n" +
							"  {\n" +
							"    ?s ex:p1 ?o .\n" +
							"    {\n" +
							"      ?s ex:p3 ?o3 .\n" +
							"    }\n" +
							"  }\n" +
							"}"),
			new Example("merge_union_shared_object",
					PREFIXES + "SELECT * WHERE {\n" +
							"  ?s ex:p1 ?o .\n" +
							"  { ?x ex:p2 ?o } UNION { ?y ex:p3 ?o }\n" +
							"}\n",
					PREFIXES + "SELECT ?s ?o ?x ?y WHERE {\n" +
							"  {\n" +
							"    ?s ex:p1 ?o .\n" +
							"    {\n" +
							"      ?x ex:p2 ?o .\n" +
							"    }\n" +
							"  }\n" +
							"  UNION\n" +
							"  {\n" +
							"    ?s ex:p1 ?o .\n" +
							"    {\n" +
							"      ?y ex:p3 ?o .\n" +
							"    }\n" +
							"  }\n" +
							"}"),
			new Example("merge_three_union_branches",
					PREFIXES + "SELECT * WHERE {\n" +
							"  ?s ex:p1 ?o .\n" +
							"  { ?s ex:p2 ?o2 } UNION { ?s ex:p3 ?o3 } UNION { ?s ex:p4 ?o4 }\n" +
							"}\n",
					PREFIXES + "SELECT ?s ?o ?o2 ?o3 ?o4 WHERE {\n" +
							"  {\n" +
							"    {\n" +
							"      ?s ex:p1 ?o .\n" +
							"      {\n" +
							"        ?s ex:p2 ?o2 .\n" +
							"      }\n" +
							"    }\n" +
							"    UNION\n" +
							"    {\n" +
							"      ?s ex:p1 ?o .\n" +
							"      {\n" +
							"        ?s ex:p3 ?o3 .\n" +
							"      }\n" +
							"    }\n" +
							"  }\n" +
							"  UNION\n" +
							"  {\n" +
							"    ?s ex:p1 ?o .\n" +
							"    {\n" +
							"      ?s ex:p4 ?o4 .\n" +
							"    }\n" +
							"  }\n" +
							"}"),
			new Example("inject_simple_optional",
					PREFIXES + "SELECT * WHERE {\n" +
							"  ?s ex:p1 ?o\n" +
							"  OPTIONAL { ?s ex:p2 ?o2 }\n" +
							"}\n",
					PREFIXES + "SELECT ?s ?o ?o2 WHERE {\n" +
							"  ?s ex:p1 ?o .\n" +
							"  OPTIONAL {\n" +
							"    ?s ex:p1 ?o .\n" +
							"    ?s ex:p2 ?o2 .\n" +
							"  }\n" +
							"}"),
			new Example("inject_optional_multi_bgp",
					PREFIXES + "SELECT * WHERE {\n" +
							"  ?s ex:p1 ?o\n" +
							"  OPTIONAL { ?s ex:p2 ?o2 . ?o2 ex:p3 ?x }\n" +
							"}\n",
					PREFIXES + "SELECT ?s ?o ?o2 ?x WHERE {\n" +
							"  ?s ex:p1 ?o .\n" +
							"  OPTIONAL {\n" +
							"    ?s ex:p1 ?o .\n" +
							"    ?s ex:p2 ?o2 .\n" +
							"    ?o2 ex:p3 ?x .\n" +
							"  }\n" +
							"}"),
			new Example("inject_optional_with_union_and_bgp",
					PREFIXES + "SELECT * WHERE {\n" +
							"  ?s ex:p1 ?o\n" +
							"  OPTIONAL { ?s ex:p2 ?o2 . { ?s ex:p3 ?o3 } UNION { ?s ex:p4 ?o4 } }\n" +
							"}\n",
					PREFIXES + "SELECT ?s ?o ?o2 ?o3 ?o4 WHERE {\n" +
							"  ?s ex:p1 ?o .\n" +
							"  OPTIONAL {\n" +
							"    ?s ex:p1 ?o .\n" +
							"    {\n" +
							"      ?s ex:p2 ?o2 .\n" +
							"      {\n" +
							"        ?s ex:p3 ?o3 .\n" +
							"      }\n" +
							"    }\n" +
							"    UNION\n" +
							"    {\n" +
							"      ?s ex:p2 ?o2 .\n" +
							"      {\n" +
							"        ?s ex:p4 ?o4 .\n" +
							"      }\n" +
							"    }\n" +
							"  }\n" +
							"}"),
			new Example("inject_nested_optional",
					PREFIXES + "SELECT * WHERE {\n" +
							"  ?s ex:p1 ?o\n" +
							"  OPTIONAL { ?s ex:p2 ?o2 OPTIONAL { ?s ex:p3 ?o3 } }\n" +
							"}\n",
					PREFIXES + "SELECT ?s ?o ?o2 ?o3 WHERE {\n" +
							"  ?s ex:p1 ?o .\n" +
							"  OPTIONAL {\n" +
							"    ?s ex:p1 ?o .\n" +
							"    ?s ex:p2 ?o2 .\n" +
							"    OPTIONAL {\n" +
							"      ?s ex:p2 ?o2 .\n" +
							"      ?s ex:p3 ?o3 .\n" +
							"    }\n" +
							"  }\n" +
							"}")
	);

	@TestFactory
	Stream<DynamicTest> visualizeOptimizedQueries() {
		Stream<Example> all = Stream.concat(EXAMPLES.stream(), COUNTER_EXAMPLES.stream());
		return all.map(example -> DynamicTest.dynamicTest(example.name, () -> runExample(example, cfg())));
	}

	private static void runExample(Example example, TupleExprIRRenderer.Config style) {
		TupleExpr original = parseAlgebra(example.sparql);
		String before = render(original, style);

		TupleExpr optimized = original.clone();
		new SparqlUoOptimizer(new FixedEvaluationStatistics(), true)
				.optimize(optimized, DATASET, BINDINGS);
		String after = render(optimized, style);

		writeArtifacts(example.name, example.sparql, before, after, original, optimized);

		assertThat(after).isEqualTo(example.expectedSparqlAfterOptimization);

	}

	private static TupleExprIRRenderer.Config cfg() {
		TupleExprIRRenderer.Config style = new TupleExprIRRenderer.Config();
		style.prefixes.put("ex", "http://example.org/");
		style.valuesPreserveOrder = true;
		return style;
	}

	private static TupleExpr parseAlgebra(String sparql) {
		try {
			ParsedQuery pq = QueryParserUtil.parseQuery(QueryLanguage.SPARQL, sparql, null);
			return pq.getTupleExpr();
		} catch (MalformedQueryException e) {
			throw new MalformedQueryException(
					"Failed to parse SPARQL query.\n###### QUERY ######\n" + sparql + "\n\n######################",
					e);
		}
	}

	private static String render(TupleExpr tupleExpr, TupleExprIRRenderer.Config style) {
		return new TupleExprIRRenderer(style).render(tupleExpr, null).trim();
	}

	private static void writeArtifacts(String baseName, String input, String before, String after, TupleExpr beforeExpr,
			TupleExpr afterExpr) {
		String safeBase = baseName.replaceAll("[^A-Za-z0-9._-]", "_");
		Path dir = Paths.get("target", "surefire-reports");
		try {
			Files.createDirectories(dir);
			writeFile(dir.resolve(safeBase + "_input.sparql"), input);
			writeFile(dir.resolve(safeBase + "_before.sparql"), before);
			writeFile(dir.resolve(safeBase + "_after.sparql"), after);
			writeFile(dir.resolve(safeBase + "_before.tupleexpr.txt"),
					VarNameNormalizer.normalizeVars(beforeExpr.toString()));
			writeFile(dir.resolve(safeBase + "_after.tupleexpr.txt"),
					VarNameNormalizer.normalizeVars(afterExpr.toString()));
		} catch (IOException ioe) {
			System.err.println("[sparql-uo] Failed to write artifacts for " + baseName + ": " + ioe);
		}
	}

	private static void writeFile(Path path, String content) throws IOException {
		Files.writeString(path, content == null ? "" : content, StandardCharsets.UTF_8);
	}

	private static final class Example {
		private final String name;
		private final String sparql;
		public final String expectedSparqlAfterOptimization;

		private Example(String name, String sparql, String expectedSparqlAfterOptimization) {
			this.name = name;
			this.sparql = sparql;
			this.expectedSparqlAfterOptimization = expectedSparqlAfterOptimization;
		}
	}

	private static final class FixedEvaluationStatistics extends EvaluationStatistics {
		@Override
		public double getCardinality(TupleExpr expr) {
			return 1.0;
		}
	}
}
