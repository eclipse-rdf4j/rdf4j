/*******************************************************************************
 * Copyright (c) 2025 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex

import java.io.IOException;
import java.util.Locale;

import org.eclipse.rdf4j.benchmark.common.ThemeQueryCatalog;
import org.eclipse.rdf4j.benchmark.rio.util.ThemeDataSetGenerator;
import org.eclipse.rdf4j.benchmark.rio.util.ThemeDataSetGenerator.Theme;
import org.eclipse.rdf4j.common.transaction.IsolationLevels;
import org.eclipse.rdf4j.query.Dataset;
import org.eclipse.rdf4j.query.algebra.evaluation.EvaluationStrategy;
import org.eclipse.rdf4j.query.algebra.evaluation.EvaluationStrategyFactory;
import org.eclipse.rdf4j.query.algebra.evaluation.TripleSource;
import org.eclipse.rdf4j.query.algebra.evaluation.impl.DefaultEvaluationStrategyFactory;
import org.eclipse.rdf4j.query.algebra.evaluation.impl.EvaluationStatistics;
import org.eclipse.rdf4j.query.algebra.evaluation.optimizer.StandardQueryOptimizerPipeline;
import org.eclipse.rdf4j.repository.sail.SailRepository;
import org.eclipse.rdf4j.repository.sail.SailRepositoryConnection;
import org.eclipse.rdf4j.repository.util.RDFInserter;
import org.eclipse.rdf4j.sail.memory.MemoryStore;

public final class ThemeQueryQuickTiming {

	public static void main(String[] args) throws Exception {
		if (args == null || args.length < 2) {
			System.err.println("Usage: ThemeQueryQuickTiming <THEME> <QUERY_INDEX> [runs] [warmups]");
			System.exit(2);
		}

		Theme theme = Theme.valueOf(args[0].toUpperCase(Locale.ROOT));
		int queryIndex = Integer.parseInt(args[1]);
		int runs = args.length >= 3 ? Integer.parseInt(args[2]) : 3;
		int warmups = args.length >= 4 ? Integer.parseInt(args[3]) : 1;

		String query = ThemeQueryCatalog.queryFor(theme, queryIndex);
		long expected = ThemeQueryCatalog.expectedCountFor(theme, queryIndex);

		for (boolean useSparqlUo : new boolean[] { true, false }) {
			System.out.println();
			System.out.println("Theme=" + theme.name() + " QueryIndex=" + queryIndex + " UseSparqlUo=" + useSparqlUo);

			SailRepository repository = createRepository(useSparqlUo);
			try {
				loadData(repository, theme);

				for (int i = 0; i < warmups; i++) {
					runOnce(repository, query, expected);
				}

				long totalNanos = 0L;
				for (int i = 0; i < runs; i++) {
					long start = System.nanoTime();
					long count = runOnce(repository, query, expected);
					long end = System.nanoTime();
					long elapsed = end - start;
					totalNanos += elapsed;
					System.out.printf(Locale.ROOT, "  run %d: %.3f ms (count=%d)%n", i + 1,
							elapsed / 1_000_000.0, count);
				}
				System.out.printf(Locale.ROOT, "  avg: %.3f ms%n", (totalNanos / 1_000_000.0) / runs);
			} finally {
				repository.shutDown();
			}
		}
	}

	private static long runOnce(SailRepository repository, String query, long expected) {
		try (SailRepositoryConnection connection = repository.getConnection()) {
			long count = connection.prepareTupleQuery(query).evaluate().stream().count();
			if (count != expected) {
				throw new IllegalStateException("Unexpected count: expected " + expected + " but got " + count);
			}
			return count;
		}
	}

	private static void loadData(SailRepository repository, Theme theme) throws IOException {
		try (SailRepositoryConnection connection = repository.getConnection()) {
			connection.begin(IsolationLevels.NONE);
			RDFInserter inserter = new RDFInserter(connection);
			ThemeDataSetGenerator.generate(theme, inserter);
			connection.commit();
		}
	}

	private static SailRepository createRepository(boolean useSparqlUo) {
		MemoryStore store = new MemoryStore();
		if (!useSparqlUo) {
			store.setEvaluationStrategyFactory(createStandardPipelineFactory(store));
		}
		return new SailRepository(store);
	}

	private static EvaluationStrategyFactory createStandardPipelineFactory(MemoryStore store) {
		DefaultEvaluationStrategyFactory factory = new DefaultEvaluationStrategyFactory(
				store.getFederatedServiceResolver()) {
			@Override
			public EvaluationStrategy createEvaluationStrategy(Dataset dataset, TripleSource tripleSource,
					EvaluationStatistics evaluationStatistics) {
				EvaluationStrategy strategy = super.createEvaluationStrategy(dataset, tripleSource,
						evaluationStatistics);
				strategy.setOptimizerPipeline(
						new StandardQueryOptimizerPipeline(strategy, tripleSource, evaluationStatistics));
				return strategy;
			}
		};
		factory.setQuerySolutionCacheThreshold(store.getIterationCacheSyncThreshold());
		factory.setTrackResultSize(store.isTrackResultSize());
		return factory;
	}

	private ThemeQueryQuickTiming() {
	}
}

